{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/images/array.png","path":"images/array.png","modified":0,"renderable":0},{"_id":"source/images/object.png","path":"images/object.png","modified":0,"renderable":0},{"_id":"source/images/value.png","path":"images/value.png","modified":0,"renderable":0},{"_id":"source/images/number.png","path":"images/number.png","modified":0,"renderable":0},{"_id":"source/images/string.png","path":"images/string.png","modified":0,"renderable":0},{"_id":"themes/alberta/source/css/style.styl","path":"css/style.styl","modified":0,"renderable":1},{"_id":"themes/alberta/source/fancybox/blank.gif","path":"fancybox/blank.gif","modified":0,"renderable":1},{"_id":"themes/alberta/source/fancybox/fancybox_loading.gif","path":"fancybox/fancybox_loading.gif","modified":0,"renderable":1},{"_id":"themes/alberta/source/fancybox/fancybox_loading@2x.gif","path":"fancybox/fancybox_loading@2x.gif","modified":0,"renderable":1},{"_id":"themes/alberta/source/fancybox/fancybox_overlay.png","path":"fancybox/fancybox_overlay.png","modified":0,"renderable":1},{"_id":"themes/alberta/source/fancybox/fancybox_sprite.png","path":"fancybox/fancybox_sprite.png","modified":0,"renderable":1},{"_id":"themes/alberta/source/fancybox/fancybox_sprite@2x.png","path":"fancybox/fancybox_sprite@2x.png","modified":0,"renderable":1},{"_id":"themes/alberta/source/fancybox/jquery.fancybox.css","path":"fancybox/jquery.fancybox.css","modified":0,"renderable":1},{"_id":"themes/alberta/source/fancybox/jquery.fancybox.pack.js","path":"fancybox/jquery.fancybox.pack.js","modified":0,"renderable":1},{"_id":"themes/alberta/source/fancybox/jquery.fancybox.js","path":"fancybox/jquery.fancybox.js","modified":0,"renderable":1},{"_id":"themes/alberta/source/js/script.js","path":"js/script.js","modified":0,"renderable":1},{"_id":"themes/alberta/source/css/fonts/FontAwesome.otf","path":"css/fonts/FontAwesome.otf","modified":0,"renderable":1},{"_id":"themes/alberta/source/css/fonts/fontawesome-webfont.eot","path":"css/fonts/fontawesome-webfont.eot","modified":0,"renderable":1},{"_id":"themes/alberta/source/css/fonts/fontawesome-webfont.woff","path":"css/fonts/fontawesome-webfont.woff","modified":0,"renderable":1},{"_id":"themes/alberta/source/fancybox/helpers/jquery.fancybox-buttons.css","path":"fancybox/helpers/jquery.fancybox-buttons.css","modified":0,"renderable":1},{"_id":"themes/alberta/source/fancybox/helpers/jquery.fancybox-buttons.js","path":"fancybox/helpers/jquery.fancybox-buttons.js","modified":0,"renderable":1},{"_id":"themes/alberta/source/fancybox/helpers/fancybox_buttons.png","path":"fancybox/helpers/fancybox_buttons.png","modified":0,"renderable":1},{"_id":"themes/alberta/source/fancybox/helpers/jquery.fancybox-media.js","path":"fancybox/helpers/jquery.fancybox-media.js","modified":0,"renderable":1},{"_id":"themes/alberta/source/fancybox/helpers/jquery.fancybox-thumbs.css","path":"fancybox/helpers/jquery.fancybox-thumbs.css","modified":0,"renderable":1},{"_id":"themes/alberta/source/fancybox/helpers/jquery.fancybox-thumbs.js","path":"fancybox/helpers/jquery.fancybox-thumbs.js","modified":0,"renderable":1},{"_id":"source/images/extra_credits.png","path":"images/extra_credits.png","modified":0,"renderable":0},{"_id":"themes/alberta/source/css/fonts/fontawesome-webfont.ttf","path":"css/fonts/fontawesome-webfont.ttf","modified":0,"renderable":1},{"_id":"themes/alberta/source/css/fonts/fontawesome-webfont.svg","path":"css/fonts/fontawesome-webfont.svg","modified":0,"renderable":1},{"_id":"themes/alberta/source/css/images/banner.jpg","path":"css/images/banner.jpg","modified":0,"renderable":1}],"Cache":[{"_id":"themes/alberta/Gruntfile.js","hash":"412e30530784993c8997aa8b1319c669b83b91c2","modified":1470569232952},{"_id":"themes/alberta/README.md","hash":"fc5b6f04592f021bf48d960383301afcb941169a","modified":1470569232955},{"_id":"themes/alberta/_config.yml","hash":"7062d729bac27587fb7c14736d3156ce04e65226","modified":1470569232955},{"_id":"source/About/index.md","hash":"d98a99f5037913477ba0abc562df29fb781ba4ec","modified":1470569232925},{"_id":"source/images/array.png","hash":"6e965355b514d13be64704750ef32ccdbf373b7b","modified":1470569232944},{"_id":"source/images/object.png","hash":"ec9c986a27bd218e78dccba8d6993a4fd322445d","modified":1470569232949},{"_id":"source/images/value.png","hash":"8ac93e46151a00d5449c16951b5586c2529750b3","modified":1470569232951},{"_id":"source/_posts/A_New_Begin.md","hash":"eec7d1ecd1ba17a8526df973e99f6b8574fcc520","modified":1470569232926},{"_id":"source/_posts/About_IAP_Receipt.md","hash":"2a2fb256f23749dac12d0fa10f2f72e004f4694b","modified":1470569232928},{"_id":"source/_posts/A_New_Blog.md","hash":"808875bc414b1fba3fbb941b4b109ec4f6cdc314","modified":1470569232928},{"_id":"source/_posts/Black_Magic_Xcode_Plugin.md","hash":"b934a8b020847176edbef632fef9fe282916e641","modified":1470569232937},{"_id":"source/_posts/Black_Magic_Flash_iOS_ANE.md","hash":"7ac9fba8e46a7d4759b524b816b73907ecd244ba","modified":1470569232936},{"_id":"source/_posts/Extra_Credits.md","hash":"5d04681e9ce4eef56d622e31981b007426d10dfa","modified":1470569232939},{"_id":"source/_posts/Homework_Lua.md","hash":"1872eab98d07d9a6b25932687b2b1d859878ceaf","modified":1470569232943},{"_id":"source/_posts/U3D_iOS_Wrapper.md","hash":"d6367a0a1fa0eda2469a765210879a993faf740d","modified":1470569232939},{"_id":"themes/alberta/layout/archive.ejs","hash":"2703b07cc8ac64ae46d1d263f4653013c7e1666b","modified":1470569232965},{"_id":"themes/alberta/layout/category.ejs","hash":"765426a9c8236828dc34759e604cc2c52292835a","modified":1470569232965},{"_id":"themes/alberta/layout/index.ejs","hash":"aa1b4456907bdb43e629be3931547e2d29ac58c8","modified":1470569232966},{"_id":"themes/alberta/layout/layout.ejs","hash":"37269ea633eb8fa66e7a9263852138ddd9a6abd4","modified":1470569232985},{"_id":"themes/alberta/layout/page.ejs","hash":"7d80e4e36b14d30a7cd2ac1f61376d9ebf264e8b","modified":1470569232985},{"_id":"themes/alberta/layout/post.ejs","hash":"7d80e4e36b14d30a7cd2ac1f61376d9ebf264e8b","modified":1470569232986},{"_id":"themes/alberta/layout/tag.ejs","hash":"eaa7b4ccb2ca7befb90142e4e68995fb1ea68b2e","modified":1470569232987},{"_id":"themes/alberta/scripts/fancybox.js","hash":"4c130fc242cf9b59b5df6ca5eae3b14302311e8c","modified":1470569232988},{"_id":"source/images/number.png","hash":"de2bd925b5b8ea43033143c6ad8479f27aa474c9","modified":1470569232948},{"_id":"source/images/string.png","hash":"6299d8bae92a75dbbb5f01975dec7813fc0d507b","modified":1470569232950},{"_id":"themes/alberta/layout/_partial/mobile-nav.ejs","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1470569232960},{"_id":"themes/alberta/layout/_partial/archive.ejs","hash":"e440311811c74c20cbdf70f6fd44fd4855d059ae","modified":1470569232957},{"_id":"themes/alberta/layout/_partial/after-footer.ejs","hash":"938a56fec194353c0608f22cb72e504b9bf6d130","modified":1470569232956},{"_id":"themes/alberta/layout/_partial/article.ejs","hash":"f286b2999b83cdcac5be8f333ebb7d16117c6dc3","modified":1470579515401},{"_id":"themes/alberta/layout/_partial/archive-post.ejs","hash":"5062c723721d8497eebad372f57092ade45041f4","modified":1470569232956},{"_id":"themes/alberta/layout/_partial/footer.ejs","hash":"2c5aa89850f481d2155971d6ad57b3ac08285892","modified":1470569232958},{"_id":"themes/alberta/layout/_partial/google-analytics.ejs","hash":"1ccc627d7697e68fddc367c73ac09920457e5b35","modified":1470569232959},{"_id":"themes/alberta/layout/_partial/header.ejs","hash":"ba0042d50595f341a42e840287fd219bea3cc40f","modified":1470569232960},{"_id":"themes/alberta/layout/_partial/head.ejs","hash":"3709b77d947b955fed3b09b4450705ccd9e7fe26","modified":1470569232959},{"_id":"themes/alberta/source/css/_extend.styl","hash":"8ab1ad313bd6707d248c5ca1ee9a5eab8d815e42","modified":1470569232989},{"_id":"themes/alberta/source/css/_variables.styl","hash":"88176c12e004071facf86b069e21575e1b6da021","modified":1470569232996},{"_id":"themes/alberta/source/css/style.styl","hash":"a6a4f0dcf39e4c046be8c4eb7c39366aa1e76d18","modified":1470569233035},{"_id":"themes/alberta/source/fancybox/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1470569233036},{"_id":"themes/alberta/source/fancybox/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1470569233037},{"_id":"themes/alberta/source/fancybox/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1470569233037},{"_id":"themes/alberta/source/fancybox/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1470569233038},{"_id":"themes/alberta/source/fancybox/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1470569233039},{"_id":"themes/alberta/source/fancybox/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1470569233039},{"_id":"themes/alberta/source/fancybox/jquery.fancybox.css","hash":"2e54d51d21e68ebc4bb870f6e57d3bfb660d4f9c","modified":1470569233052},{"_id":"themes/alberta/source/fancybox/jquery.fancybox.pack.js","hash":"2da892a02778236b64076e5e8802ef0566e1d9e8","modified":1470569233071},{"_id":"themes/alberta/source/fancybox/jquery.fancybox.js","hash":"58193c802f307ec9bc9e586c0e8a13ebef45d2f8","modified":1470569233061},{"_id":"themes/alberta/source/js/script.js","hash":"c0d368681c687258b628bacc84cc30d353de6d47","modified":1470569233073},{"_id":"themes/alberta/layout/_partial/post/category.ejs","hash":"16128d2422645e18d1b6882d4c4df17d895bd76e","modified":1470569232960},{"_id":"themes/alberta/layout/_partial/post/date.ejs","hash":"947f513f7a85fbcf085624e46dc2ae6de8185eec","modified":1470569232961},{"_id":"themes/alberta/layout/_partial/post/gallery.ejs","hash":"b0bf3f5d923c261ca2b5fabab513f1ec2708c8ca","modified":1470569232961},{"_id":"themes/alberta/layout/_partial/post/nav.ejs","hash":"eb000d9d8a9ebd9087046fa019abe1cddae8fd9c","modified":1470569232962},{"_id":"themes/alberta/layout/_partial/post/tag.ejs","hash":"694b5101bcc44c9f9c1cc62e5ad2fdfb4b7c7a07","modified":1470569232962},{"_id":"themes/alberta/layout/_partial/post/title.ejs","hash":"d4a460a35e2112d0c7414fd5e19b3a16093f1caf","modified":1470569232964},{"_id":"themes/alberta/source/css/_util/grid.styl","hash":"1aa883ab432d9e4139c89dcbd40ae2bd1528d029","modified":1470569232995},{"_id":"themes/alberta/source/css/_util/mixin.styl","hash":"429bad87fc156eacf226c5e35b0eafc277f2504b","modified":1470569232995},{"_id":"themes/alberta/source/css/_partial/archive.styl","hash":"9e574d8eb1a5285ec3b4346607414770d2f7e0ff","modified":1470569232989},{"_id":"themes/alberta/source/css/_partial/article.styl","hash":"624d120e0c0793e20335d3acd8d79755856a5f11","modified":1470569232990},{"_id":"themes/alberta/source/css/_partial/footer.styl","hash":"330e9cb2a51f1c6e2a73a7245019fd8ec59253c3","modified":1470569232991},{"_id":"themes/alberta/source/css/_partial/comment.styl","hash":"2834870661e490775f9154d71638bfdc72e640a6","modified":1470569232990},{"_id":"themes/alberta/source/css/_partial/header.styl","hash":"ac5d23f1631c247b9cec34cbeefde2c5ca99bf15","modified":1470569232991},{"_id":"themes/alberta/source/css/_partial/highlight.styl","hash":"05da1b8f4859761dc60bca40b8682f167e350742","modified":1470569232992},{"_id":"themes/alberta/source/css/_partial/mobile.styl","hash":"680c7b809b62cd3ad294e822793fbd0b1a32cc33","modified":1470569232993},{"_id":"themes/alberta/source/css/_partial/sidebar-aside.styl","hash":"1fb15f13ba70d5b954f62920c6b63d26e2fb2985","modified":1470569232993},{"_id":"themes/alberta/source/css/_partial/sidebar-bottom.styl","hash":"f6023861b2fbd858946e2108438b5f8f17586179","modified":1470569232994},{"_id":"themes/alberta/source/css/_partial/sidebar.styl","hash":"0c91d8e0081cf2de5f729c8cf2f42c3a2ae5ccb6","modified":1470569232994},{"_id":"themes/alberta/source/css/fonts/FontAwesome.otf","hash":"b5b4f9be85f91f10799e87a083da1d050f842734","modified":1470569233002},{"_id":"themes/alberta/source/css/fonts/fontawesome-webfont.eot","hash":"7619748fe34c64fb157a57f6d4ef3678f63a8f5e","modified":1470569233013},{"_id":"themes/alberta/source/css/fonts/fontawesome-webfont.woff","hash":"04c3bf56d87a0828935bd6b4aee859995f321693","modified":1470569233028},{"_id":"themes/alberta/source/fancybox/helpers/jquery.fancybox-buttons.css","hash":"6394c48092085788a8c0ef72670b0652006231a1","modified":1470569233041},{"_id":"themes/alberta/source/fancybox/helpers/jquery.fancybox-buttons.js","hash":"4c9c395d705d22af7da06870d18f434e2a2eeaf9","modified":1470569233041},{"_id":"themes/alberta/source/fancybox/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1470569233040},{"_id":"themes/alberta/source/fancybox/helpers/jquery.fancybox-media.js","hash":"e14c32cc6823b81b2f758512f13ed8eb9ef2b454","modified":1470569233043},{"_id":"themes/alberta/source/fancybox/helpers/jquery.fancybox-thumbs.css","hash":"b88b589f5f1aa1b3d87cc7eef34c281ff749b1ae","modified":1470569233043},{"_id":"themes/alberta/source/fancybox/helpers/jquery.fancybox-thumbs.js","hash":"83cdfea43632b613771691a11f56f99d85fb6dbd","modified":1470569233051},{"_id":"source/images/extra_credits.png","hash":"1a2003845b8f0ab9f04678395953d31f6071a6fa","modified":1470569232946},{"_id":"themes/alberta/source/css/fonts/fontawesome-webfont.ttf","hash":"7f09c97f333917034ad08fa7295e916c9f72fd3f","modified":1470569233025},{"_id":"themes/alberta/source/css/fonts/fontawesome-webfont.svg","hash":"a275426daefd3716c53561fad121d258a7f05b47","modified":1470569233020},{"_id":"themes/alberta/source/css/images/banner.jpg","hash":"843d9d47bf2b7b75495db11b3d765efaaae442a9","modified":1470569233033},{"_id":"public/About/index.html","hash":"180baa8810ab5d3ae45875c914ab3f2b0e7f59a5","modified":1470580074029},{"_id":"public/2014/11/28/A_New_Begin/index.html","hash":"2eb5ca8081668c1447edc2927e35302b701829be","modified":1470580074029},{"_id":"public/2014/11/27/Extra_Credits/index.html","hash":"84857eeef06631073735458aed71d8d3d34b6b89","modified":1470580074030},{"_id":"public/2014/11/24/Black_Magic_Xcode_Plugin/index.html","hash":"460cf41c929b576a0a461dc71a075c0dd0de5b7d","modified":1470580074030},{"_id":"public/2014/08/17/About_IAP_Receipt/index.html","hash":"e073946040646b2b695f19755a4ec63fe0c778fa","modified":1470580074030},{"_id":"public/2014/08/17/U3D_iOS_Wrapper/index.html","hash":"7f3b147513db935032fe19eba3a1a7d750598bf6","modified":1470580074030},{"_id":"public/2014/07/17/A_New_Blog/index.html","hash":"dab80875b5b9873b1cf6836df14a73a647555c9f","modified":1470580074030},{"_id":"public/archives/index.html","hash":"f11eb7469c8c8f3b4f7d60a7cdb067ada044e333","modified":1470580074030},{"_id":"public/archives/2014/index.html","hash":"97a1fac330545691f056c2735c90f687abacc387","modified":1470580074030},{"_id":"public/archives/2014/07/index.html","hash":"469637451fc200652698f3e0cab679c4082f5970","modified":1470580074030},{"_id":"public/archives/2014/08/index.html","hash":"c391f0ade083b66e84611d329a45f7d13c655b2f","modified":1470580074030},{"_id":"public/archives/2014/11/index.html","hash":"087a2a3a72765dcf1cbe611c83a44af627002fe3","modified":1470580074030},{"_id":"public/archives/2015/index.html","hash":"ce3c77ffa11b795265c6831f176b1895242839a8","modified":1470580074030},{"_id":"public/archives/2015/01/index.html","hash":"37a1557a7335355ca8b83d8958e19a5126e8cb7d","modified":1470580074030},{"_id":"public/tags/game/index.html","hash":"aa32dd2e98cc862c05f5a6411731d1b39b4f3dc4","modified":1470580074030},{"_id":"public/tags/work/index.html","hash":"d7a58ec1a2c32ea7fea48e2426ca02e35a0c514f","modified":1470580074030},{"_id":"public/tags/begin/index.html","hash":"8a752aed7686b9912531b3630d60979ee33bf86b","modified":1470580074031},{"_id":"public/tags/iOS/index.html","hash":"0b82a15c3d5edd7891004256a5703a5112d9fe0f","modified":1470580074031},{"_id":"public/tags/IAP/index.html","hash":"8b208842b278ec1da2ab0b621f2eff267da0ca03","modified":1470580074031},{"_id":"public/tags/Receipt/index.html","hash":"740cb8b48dd255502f875bbded048041aad4271a","modified":1470580074031},{"_id":"public/tags/daily/index.html","hash":"0a53a4da05625e05e16c43f7081345a90e5cd345","modified":1470580074031},{"_id":"public/tags/Xcode/index.html","hash":"262c89dba90163204c20bdc08d6896fcc8cf3bb1","modified":1470580074031},{"_id":"public/tags/Plugin/index.html","hash":"07e6f2ac6c4bd5198377ac5e59f7a1a5171abea7","modified":1470580074031},{"_id":"public/tags/SDK/index.html","hash":"aa52aead7be8132146bd162ad5f03f8b8615e623","modified":1470580074031},{"_id":"public/tags/Flash/index.html","hash":"da9ec050ef695a38b9d844e8ce094d90e3ac5dec","modified":1470580074031},{"_id":"public/tags/ANE/index.html","hash":"be6eb092e6f682773638528c29e19c6d54aa846b","modified":1470580074031},{"_id":"public/tags/Extra-Credits/index.html","hash":"cb50de032bf830738c61a0455fc3996efa4f9acf","modified":1470580074031},{"_id":"public/tags/video-lesson-series/index.html","hash":"2f01a7e25728cd63936104e16ea63b4fbecf48f4","modified":1470580074031},{"_id":"public/tags/U3D/index.html","hash":"9b0c338d3f714ee2da420244650c9a641ad8c6bd","modified":1470580074031},{"_id":"public/tags/lua/index.html","hash":"42757d9a94928209955b52c1b7e047aaa09c5ce8","modified":1470580074032},{"_id":"public/tags/json/index.html","hash":"f32d18497cb60c16f988e81564a9e3871f155f5c","modified":1470580074032},{"_id":"public/tags/parser/index.html","hash":"eeca27b4a45a935e58a1552a4946810481cbf006","modified":1470580074032},{"_id":"public/2015/01/09/Homework_Lua/index.html","hash":"9ccbb47f32a53c7281460f6edd3dcdb933001ca6","modified":1470580074032},{"_id":"public/2014/08/15/Black_Magic_Flash_iOS_ANE/index.html","hash":"b49632ffd95df9269435fc9128e6c8c097468ee1","modified":1470580074032},{"_id":"public/index.html","hash":"6708662187cb553f2c0ced4ca52c526673fa4df0","modified":1470580074032},{"_id":"public/images/object.png","hash":"ec9c986a27bd218e78dccba8d6993a4fd322445d","modified":1470580074044},{"_id":"public/images/array.png","hash":"6e965355b514d13be64704750ef32ccdbf373b7b","modified":1470580074044},{"_id":"public/images/value.png","hash":"8ac93e46151a00d5449c16951b5586c2529750b3","modified":1470580074044},{"_id":"public/fancybox/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1470580074044},{"_id":"public/fancybox/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1470580074044},{"_id":"public/fancybox/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1470580074044},{"_id":"public/fancybox/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1470580074045},{"_id":"public/fancybox/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1470580074045},{"_id":"public/fancybox/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1470580074045},{"_id":"public/css/fonts/FontAwesome.otf","hash":"b5b4f9be85f91f10799e87a083da1d050f842734","modified":1470580074045},{"_id":"public/css/fonts/fontawesome-webfont.eot","hash":"7619748fe34c64fb157a57f6d4ef3678f63a8f5e","modified":1470580074045},{"_id":"public/css/fonts/fontawesome-webfont.woff","hash":"04c3bf56d87a0828935bd6b4aee859995f321693","modified":1470580074045},{"_id":"public/fancybox/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1470580074045},{"_id":"public/images/number.png","hash":"de2bd925b5b8ea43033143c6ad8479f27aa474c9","modified":1470580074549},{"_id":"public/images/string.png","hash":"6299d8bae92a75dbbb5f01975dec7813fc0d507b","modified":1470580074549},{"_id":"public/css/fonts/fontawesome-webfont.ttf","hash":"7f09c97f333917034ad08fa7295e916c9f72fd3f","modified":1470580074550},{"_id":"public/fancybox/jquery.fancybox.css","hash":"aaa582fb9eb4b7092dc69fcb2d5b1c20cca58ab6","modified":1470580074555},{"_id":"public/js/script.js","hash":"2876e0b19ce557fca38d7c6f49ca55922ab666a1","modified":1470580074556},{"_id":"public/fancybox/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1470580074556},{"_id":"public/fancybox/helpers/jquery.fancybox-buttons.js","hash":"dc3645529a4bf72983a39fa34c1eb9146e082019","modified":1470580074556},{"_id":"public/fancybox/helpers/jquery.fancybox-media.js","hash":"294420f9ff20f4e3584d212b0c262a00a96ecdb3","modified":1470580074556},{"_id":"public/fancybox/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1470580074556},{"_id":"public/fancybox/helpers/jquery.fancybox-thumbs.js","hash":"47da1ae5401c24b5c17cc18e2730780f5c1a7a0c","modified":1470580074556},{"_id":"public/css/style.css","hash":"43449dab7e5dc0d37a703d9fd3ca431c29f10948","modified":1470580074556},{"_id":"public/fancybox/jquery.fancybox.js","hash":"d08b03a42d5c4ba456ef8ba33116fdbb7a9cabed","modified":1470580074556},{"_id":"public/fancybox/jquery.fancybox.pack.js","hash":"9e0d51ca1dbe66f6c0c7aefd552dc8122e694a6e","modified":1470580074557},{"_id":"public/css/fonts/fontawesome-webfont.svg","hash":"a275426daefd3716c53561fad121d258a7f05b47","modified":1470580074562},{"_id":"public/css/images/banner.jpg","hash":"843d9d47bf2b7b75495db11b3d765efaaae442a9","modified":1470580074562},{"_id":"public/images/extra_credits.png","hash":"1a2003845b8f0ab9f04678395953d31f6071a6fa","modified":1470580074569}],"Category":[],"Data":[],"Page":[{"title":"About","_content":"\n\n{% code ME lang:json %}\n\n{ \n  \"id\": \"wo1fSea\", \n  \"name\": [\"黄铨雍\", \"Quanyong Huang\"], \n  \"major\": \"CS\",\n  \"language\": [\"潮州话\",\"普通话\",\"English\",\"c/c++\"],\n  \"contact\": \n    { \n      \"qq\": 5337338, \n      \"email\": \"quanyongh@foxmail.com\", \n      \"wechat\": \"huangquanyong\"\n    } \n}\n\n{% endcode %}\n","source":"About/index.md","raw":"title: About\n---\n\n\n{% code ME lang:json %}\n\n{ \n  \"id\": \"wo1fSea\", \n  \"name\": [\"黄铨雍\", \"Quanyong Huang\"], \n  \"major\": \"CS\",\n  \"language\": [\"潮州话\",\"普通话\",\"English\",\"c/c++\"],\n  \"contact\": \n    { \n      \"qq\": 5337338, \n      \"email\": \"quanyongh@foxmail.com\", \n      \"wechat\": \"huangquanyong\"\n    } \n}\n\n{% endcode %}\n","date":"2016-08-07T11:27:12.925Z","updated":"2016-08-07T11:27:12.925Z","path":"About/index.html","comments":1,"layout":"page","_id":"cirkp6cv90001h8g6iht9ydmm","content":"<figure class=\"highlight json\"><figcaption><span>ME</span></figcaption><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\">&#123; </div><div class=\"line\">  <span class=\"attr\">\"id\"</span>: <span class=\"string\">\"wo1fSea\"</span>, </div><div class=\"line\">  <span class=\"attr\">\"name\"</span>: [<span class=\"string\">\"黄铨雍\"</span>, <span class=\"string\">\"Quanyong Huang\"</span>], </div><div class=\"line\">  <span class=\"attr\">\"major\"</span>: <span class=\"string\">\"CS\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"language\"</span>: [<span class=\"string\">\"潮州话\"</span>,<span class=\"string\">\"普通话\"</span>,<span class=\"string\">\"English\"</span>,<span class=\"string\">\"c/c++\"</span>],</div><div class=\"line\">  <span class=\"attr\">\"contact\"</span>: </div><div class=\"line\">    &#123; </div><div class=\"line\">      <span class=\"attr\">\"qq\"</span>: <span class=\"number\">5337338</span>, </div><div class=\"line\">      <span class=\"attr\">\"email\"</span>: <span class=\"string\">\"quanyongh@foxmail.com\"</span>, </div><div class=\"line\">      <span class=\"attr\">\"wechat\"</span>: <span class=\"string\">\"huangquanyong\"</span></div><div class=\"line\">    &#125; </div><div class=\"line\">&#125;</div><div class=\"line\"></div></pre></td></tr></table></figure>\n","excerpt":"","more":"<figure class=\"highlight json\"><figcaption><span>ME</span></figcaption><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\">&#123; </div><div class=\"line\">  <span class=\"attr\">\"id\"</span>: <span class=\"string\">\"wo1fSea\"</span>, </div><div class=\"line\">  <span class=\"attr\">\"name\"</span>: [<span class=\"string\">\"黄铨雍\"</span>, <span class=\"string\">\"Quanyong Huang\"</span>], </div><div class=\"line\">  <span class=\"attr\">\"major\"</span>: <span class=\"string\">\"CS\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"language\"</span>: [<span class=\"string\">\"潮州话\"</span>,<span class=\"string\">\"普通话\"</span>,<span class=\"string\">\"English\"</span>,<span class=\"string\">\"c/c++\"</span>],</div><div class=\"line\">  <span class=\"attr\">\"contact\"</span>: </div><div class=\"line\">    &#123; </div><div class=\"line\">      <span class=\"attr\">\"qq\"</span>: <span class=\"number\">5337338</span>, </div><div class=\"line\">      <span class=\"attr\">\"email\"</span>: <span class=\"string\">\"quanyongh@foxmail.com\"</span>, </div><div class=\"line\">      <span class=\"attr\">\"wechat\"</span>: <span class=\"string\">\"huangquanyong\"</span></div><div class=\"line\">    &#125; </div><div class=\"line\">&#125;</div><div class=\"line\"></div></pre></td></tr></table></figure>\n"}],"Post":[{"title":"实习离职","date":"2014-11-27T21:41:42.000Z","_content":"\n今天终于实习离职了，从5月8日到11月28日，在网易游戏实习了接近7个月。今天离职信里终结了下，在UniSDK，完整的东西大概做了下面这些，然后零零索索的给游戏处理各种iOS疑难杂症。\n\n\t+ NtUniSdkFramework\n\t\t+ 91\n\t\t+ PP\n\t\t+ Tongbu\n\t\t+ DownJoy\n\t\t+ iTools\n\t\t+ KuaiYong\n\t\t+ NetEase\n\t\t+ YiXin\n\t\t+ Line\n\t\t\n\t+ NtShareSdkFramework\n\t\t+ YiXin\n\t\t+ WeiXin\n\t\t+ Weibo\n\n\t+ NtUniSdk Xcode Plugin\n\n\t+ U3D C# Wrapper for both Android and iOS NtUniSdk\n\n\t+ Flash ANE for both Android and iOS NtUniSdk\n\n <!-- more --> \n\n大半年来，还是能学到不少东西，从没接触过iOS开发，到现在许多线上的项目都用着我们的iOS UniSDK。体会最深的还是，AppStore IAP部分的代码，来来去去，踩了不少坑，也加了不少班。对一个比较长的业务流程，其实是很难保证在上线前能得到非常完备的测试的。在大量的用户面前，你完全不知道用户到底会如何使用。另外，各种概率性出现的bug也是很难重现的。比如，第一次IAP的代码上线的时候，和G3程序在重现一个0。1%概率的bug，愣是一个下午过去了，都没能重现出来，最后，也是直接靠猜了。\n\n![用户是这样使用我们开发的软件的](http://ww1.sinaimg.cn/bmiddle/82a507cagw1emndj5fsn2g20dw07tnbp.gif)\n\n明天，就不用再考虑上班的事了，先睡几天大懒觉。\n今天走的时候，一个同学说，“你居然是实习，你放着大好的时间不去浪，在这里呆了7个月？你以后会后悔的。”\n可是，不实习，回来学校还是要干活的啊...\n\n\n","source":"_posts/A_New_Begin.md","raw":"title: 实习离职 \ndate: 2014-11-28 05:41:42\ntags: [game, work, begin]\n---\n\n今天终于实习离职了，从5月8日到11月28日，在网易游戏实习了接近7个月。今天离职信里终结了下，在UniSDK，完整的东西大概做了下面这些，然后零零索索的给游戏处理各种iOS疑难杂症。\n\n\t+ NtUniSdkFramework\n\t\t+ 91\n\t\t+ PP\n\t\t+ Tongbu\n\t\t+ DownJoy\n\t\t+ iTools\n\t\t+ KuaiYong\n\t\t+ NetEase\n\t\t+ YiXin\n\t\t+ Line\n\t\t\n\t+ NtShareSdkFramework\n\t\t+ YiXin\n\t\t+ WeiXin\n\t\t+ Weibo\n\n\t+ NtUniSdk Xcode Plugin\n\n\t+ U3D C# Wrapper for both Android and iOS NtUniSdk\n\n\t+ Flash ANE for both Android and iOS NtUniSdk\n\n <!-- more --> \n\n大半年来，还是能学到不少东西，从没接触过iOS开发，到现在许多线上的项目都用着我们的iOS UniSDK。体会最深的还是，AppStore IAP部分的代码，来来去去，踩了不少坑，也加了不少班。对一个比较长的业务流程，其实是很难保证在上线前能得到非常完备的测试的。在大量的用户面前，你完全不知道用户到底会如何使用。另外，各种概率性出现的bug也是很难重现的。比如，第一次IAP的代码上线的时候，和G3程序在重现一个0。1%概率的bug，愣是一个下午过去了，都没能重现出来，最后，也是直接靠猜了。\n\n![用户是这样使用我们开发的软件的](http://ww1.sinaimg.cn/bmiddle/82a507cagw1emndj5fsn2g20dw07tnbp.gif)\n\n明天，就不用再考虑上班的事了，先睡几天大懒觉。\n今天走的时候，一个同学说，“你居然是实习，你放着大好的时间不去浪，在这里呆了7个月？你以后会后悔的。”\n可是，不实习，回来学校还是要干活的啊...\n\n\n","slug":"A_New_Begin","published":1,"updated":"2016-08-07T11:27:12.926Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cirkp6cv50000h8g6gquj4q2j","content":"<p>今天终于实习离职了，从5月8日到11月28日，在网易游戏实习了接近7个月。今天离职信里终结了下，在UniSDK，完整的东西大概做了下面这些，然后零零索索的给游戏处理各种iOS疑难杂症。</p>\n<pre><code>+ NtUniSdkFramework\n    + 91\n    + PP\n    + Tongbu\n    + DownJoy\n    + iTools\n    + KuaiYong\n    + NetEase\n    + YiXin\n    + Line\n\n+ NtShareSdkFramework\n    + YiXin\n    + WeiXin\n    + Weibo\n\n+ NtUniSdk Xcode Plugin\n\n+ U3D C# Wrapper for both Android and iOS NtUniSdk\n\n+ Flash ANE for both Android and iOS NtUniSdk\n</code></pre> <a id=\"more\"></a> \n<p>大半年来，还是能学到不少东西，从没接触过iOS开发，到现在许多线上的项目都用着我们的iOS UniSDK。体会最深的还是，AppStore IAP部分的代码，来来去去，踩了不少坑，也加了不少班。对一个比较长的业务流程，其实是很难保证在上线前能得到非常完备的测试的。在大量的用户面前，你完全不知道用户到底会如何使用。另外，各种概率性出现的bug也是很难重现的。比如，第一次IAP的代码上线的时候，和G3程序在重现一个0。1%概率的bug，愣是一个下午过去了，都没能重现出来，最后，也是直接靠猜了。</p>\n<p><img src=\"http://ww1.sinaimg.cn/bmiddle/82a507cagw1emndj5fsn2g20dw07tnbp.gif\" alt=\"用户是这样使用我们开发的软件的\"></p>\n<p>明天，就不用再考虑上班的事了，先睡几天大懒觉。<br>今天走的时候，一个同学说，“你居然是实习，你放着大好的时间不去浪，在这里呆了7个月？你以后会后悔的。”<br>可是，不实习，回来学校还是要干活的啊…</p>\n","excerpt":"<p>今天终于实习离职了，从5月8日到11月28日，在网易游戏实习了接近7个月。今天离职信里终结了下，在UniSDK，完整的东西大概做了下面这些，然后零零索索的给游戏处理各种iOS疑难杂症。</p>\n<pre><code>+ NtUniSdkFramework\n    + 91\n    + PP\n    + Tongbu\n    + DownJoy\n    + iTools\n    + KuaiYong\n    + NetEase\n    + YiXin\n    + Line\n\n+ NtShareSdkFramework\n    + YiXin\n    + WeiXin\n    + Weibo\n\n+ NtUniSdk Xcode Plugin\n\n+ U3D C# Wrapper for both Android and iOS NtUniSdk\n\n+ Flash ANE for both Android and iOS NtUniSdk\n</code></pre>","more":"<p>大半年来，还是能学到不少东西，从没接触过iOS开发，到现在许多线上的项目都用着我们的iOS UniSDK。体会最深的还是，AppStore IAP部分的代码，来来去去，踩了不少坑，也加了不少班。对一个比较长的业务流程，其实是很难保证在上线前能得到非常完备的测试的。在大量的用户面前，你完全不知道用户到底会如何使用。另外，各种概率性出现的bug也是很难重现的。比如，第一次IAP的代码上线的时候，和G3程序在重现一个0。1%概率的bug，愣是一个下午过去了，都没能重现出来，最后，也是直接靠猜了。</p>\n<p><img src=\"http://ww1.sinaimg.cn/bmiddle/82a507cagw1emndj5fsn2g20dw07tnbp.gif\" alt=\"用户是这样使用我们开发的软件的\"></p>\n<p>明天，就不用再考虑上班的事了，先睡几天大懒觉。<br>今天走的时候，一个同学说，“你居然是实习，你放着大好的时间不去浪，在这里呆了7个月？你以后会后悔的。”<br>可是，不实习，回来学校还是要干活的啊…</p>"},{"title":"关于AppStore IAP的新旧Receipt","date":"2014-08-17T13:27:40.000Z","_content":"\niOS7.0后，SKPayment的property transactionReceipt变成了DEPRECATED。\n\n建议使用新接口来实现receipt的获取。\n\n\t [[[NSBundle mainBundle] appStoreReceiptURL] dataWithContentsOfURL:receiptURL];\n\n如果使用了IAP，Apple官方的建议是使用下列代码来处理：\n\n    NSData *receipt = nil;\n    \n    if (floor(NSFoundationVersionNumber) <= NSFoundationVersionNumber_iOS_6_1) {\n        // Load resources for iOS 6.1 or earlier\n        receipt = transaction.transactionReceipt;\n        \n    } else {\n        NSURL *receiptURL = [[NSBundle mainBundle] appStoreReceiptURL];\n        receipt = [NSData dataWithContentsOfURL:receiptURL];\n    }\n\n上面的代码很容易以为，新旧接口取得的receipt格式是一致的。其实不然。\n\n <!-- more --> \n\n在NtUniSdk里面,iOS官方渠道的易信和网易通行证使用了IAP,然后使用了上述Apple官方建议的代码，结果就是receipt格式不一致，计费验证不通过，把接入SDK的G3坑了一顿。\n\n原来旧接口返回的receipt如下：\n\n\t2014-07-24 15:53:51.284 [NetEase]iOSNtUniSdkFrameworkDemo[22831:4107] [NtUniSdk] IAP jsonResponse: {\n    \treceipt =     {\n        \tbid = \"com.netease.sdk.test\";\n        \tbvrs = \"1.0\";\n        \t\"item_id\" = 892617314;\n        \t\"original_purchase_date\" = \"2014-07-24 07:43:14 Etc/GMT\";\n        \t\"original_purchase_date_ms\" = 1406187794660;\n        \t\"original_purchase_date_pst\" = \"2014-07-24 00:43:14 America/Los_Angeles\";\n        \t\"original_transaction_id\" = 1000000117879059;\n        \t\"product_id\" = \"com.netease.sdk.test.item2\";\n        \t\"purchase_date\" = \"2014-07-24 07:43:14 Etc/GMT\";\n        \t\"purchase_date_ms\" = 1406187794660;\n        \t\"purchase_date_pst\" = \"2014-07-24 00:43:14 America/Los_Angeles\";\n        \tquantity = 1;\n        \t\"transaction_id\" = 1000000117879059;\n        \t\"unique_identifier\" = 0000b0196818;\n        \t\"unique_vendor_identifier\" = \"FEF4F2DB-D07D-4B96-8F22-592A4B9CBAE7\";\n    \t};\n    \tstatus = 0;\n\t}\n\n而新接口返回的receipt：\n\n\t2014-07-24 17:11:16.475 [NetEase]iOSNtUniSdkFrameworkDemo[185:748f] [NtUniSdk] IAP jsonResponse: {\n    \tenvironment = Sandbox;\n    \treceipt =     {\n        \t\"adam_id\" = 0;\n        \t\"application_version\" = \"1.0\";\n        \t\"bundle_id\" = \"com.netease.sdk.test\";\n        \t\"download_id\" = 0;\n        \t\"in_app\" =         (\n                        \t{\n                \t\"is_trial_period\" = false;\n                \t\"original_purchase_date\" = \"2014-07-24 09:11:00 Etc/GMT\";\n                \t\"original_purchase_date_ms\" = 1406193060000;\n                \t\"original_purchase_date_pst\" = \"2014-07-24 02:11:00 America/Los_Angeles\";\n                \t\"original_transaction_id\" = 1000000117894869;\n                \t\"product_id\" = \"com.netease.sdk.test.item2\";\n                \t\"purchase_date\" = \"2014-07-24 09:11:01 Etc/GMT\";\n                \t\"purchase_date_ms\" = 1406193061000;\n                \t\"purchase_date_pst\" = \"2014-07-24 02:11:01 America/Los_Angeles\";\n                \tquantity = 1;\n                \t\"transaction_id\" = 1000000117894869;\n            \t}\n        \t);\n        \t\"original_application_version\" = \"1.0\";\n        \t\"original_purchase_date\" = \"2013-08-01 07:00:00 Etc/GMT\";\n        \t\"original_purchase_date_ms\" = 1375340400000;\n        \t\"original_purchase_date_pst\" = \"2013-08-01 00:00:00 America/Los_Angeles\";\n        \t\"receipt_type\" = ProductionSandbox;\n        \t\"request_date\" = \"2014-07-24 09:11:17 Etc/GMT\";\n        \t\"request_date_ms\" = 1406193077021;\n        \t\"request_date_pst\" = \"2014-07-24 02:11:17 America/Los_Angeles\";\n    \t};\n    \tstatus = 0;\n\t}\n\n新旧receipt在验证API接口方面无变化，变化主要在于返回的jsonResponese格式。\n新的jsonResponese格式官网文档如下：\n>Receipt Fields\n>https://developer.apple.com/library/ios/releasenotes/General/ValidateAppStoreReceipt/Chapters/ReceiptFields.html#//apple_ref/doc/uid/TP40010573-CH106-SW1\n\n下面是程序中实际输出jsonResponese的Log，值得注意的有receipt字段中的in_app字段可能包含多个transaction的receipt。\n客户端APP中的新接口每次读取将读取出还没读取过的所有receipt，当上一次transaction完成后，但没有成功调用到读取receipt接口时，即将出现多条，如下第二条Log所示。\n\n\t2014-07-24 16:06:52.077 [NetEase]iOSNtUniSdkFrameworkDemo[164:3e0b] [NtUniSdk] IAP jsonResponse: {\n    \tenvironment = Sandbox;\n    \treceipt =     {\n        \t\"adam_id\" = 0;\n        \t\"application_version\" = \"1.0\";\n        \t\"bundle_id\" = \"com.netease.sdk.test\";\n        \t\"download_id\" = 0;\n        \t\"in_app\" =         (\n            \t            {\n                \t\"is_trial_period\" = false;\n                \t\"original_purchase_date\" = \"2014-06-23 06:59:55 Etc/GMT\";\n                \t\"original_purchase_date_ms\" = 1403506795000;\n                \t\"original_purchase_date_pst\" = \"2014-06-22 23:59:55 America/Los_Angeles\";\n                \t\"original_transaction_id\" = 1000000114795007;\n                \t\"product_id\" = \"com.netease.sdk.test.item1\";\n                \t\"purchase_date\" = \"2014-06-24 09:06:09 Etc/GMT\";\n                \t\"purchase_date_ms\" = 1403600769000;\n                \t\"purchase_date_pst\" = \"2014-06-24 02:06:09 America/Los_Angeles\";\n                \tquantity = 1;\n                \t\"transaction_id\" = 1000000114795007;\n            \t},\n                \t        {\n                \t\"is_trial_period\" = false;\n                \t\"original_purchase_date\" = \"2014-06-24 09:06:09 Etc/GMT\";\n                \t\"original_purchase_date_ms\" = 1403600769000;\n                \t\"original_purchase_date_pst\" = \"2014-06-24 02:06:09 America/Los_Angeles\";\n                \t\"original_transaction_id\" = 1000000114938703;\n                \t\"product_id\" = \"com.netease.sdk.test.item3\";\n                \t\"purchase_date\" = \"2014-06-24 09:06:09 Etc/GMT\";\n                \t\"purchase_date_ms\" = 1403600769000;\n                \t\"purchase_date_pst\" = \"2014-06-24 02:06:09 America/Los_Angeles\";\n                \tquantity = 1;\n                \t\"transaction_id\" = 1000000114938703;\n            \t}\n        \t);\n        \t\"original_application_version\" = \"1.0\";\n        \t\"original_purchase_date\" = \"2013-08-01 07:00:00 Etc/GMT\";\n        \t\"original_purchase_date_ms\" = 1375340400000;\n        \t\"original_purchase_date_pst\" = \"2013-08-01 00:00:00 America/Los_Angeles\";\n        \t\"receipt_type\" = ProductionSandbox;\n        \t\"request_date\" = \"2014-07-24 08:06:54 Etc/GMT\";\n        \t\"request_date_ms\" = 1406189214105;\n        \t\"request_date_pst\" = \"2014-07-24 01:06:54 America/Los_Angeles\";\n   \t\t};\n    \tstatus = 0;\n\t}\n\nApple的IAP一直存在一个比较蛋疼的问题，在IAP的交易订单上没有填写额外信息的地方。由于存在网游的账号和AppStore支付账号两套系统，道具发放一直存在着可能在支付过程意外中断而导致漏洞的情况。iOS7.0在SKPayment中提供了一个applicationUsername属性用于填写用户信息，不过鉴于iOS7.0－的系统中没有该属性，在短时间内对这种意外情况改善也不大。\n\n","source":"_posts/About_IAP_Receipt.md","raw":"title: 关于AppStore IAP的新旧Receipt \ndate: 2014-08-17 21:27:40\ntags: [iOS,IAP,Receipt]\n---\n\niOS7.0后，SKPayment的property transactionReceipt变成了DEPRECATED。\n\n建议使用新接口来实现receipt的获取。\n\n\t [[[NSBundle mainBundle] appStoreReceiptURL] dataWithContentsOfURL:receiptURL];\n\n如果使用了IAP，Apple官方的建议是使用下列代码来处理：\n\n    NSData *receipt = nil;\n    \n    if (floor(NSFoundationVersionNumber) <= NSFoundationVersionNumber_iOS_6_1) {\n        // Load resources for iOS 6.1 or earlier\n        receipt = transaction.transactionReceipt;\n        \n    } else {\n        NSURL *receiptURL = [[NSBundle mainBundle] appStoreReceiptURL];\n        receipt = [NSData dataWithContentsOfURL:receiptURL];\n    }\n\n上面的代码很容易以为，新旧接口取得的receipt格式是一致的。其实不然。\n\n <!-- more --> \n\n在NtUniSdk里面,iOS官方渠道的易信和网易通行证使用了IAP,然后使用了上述Apple官方建议的代码，结果就是receipt格式不一致，计费验证不通过，把接入SDK的G3坑了一顿。\n\n原来旧接口返回的receipt如下：\n\n\t2014-07-24 15:53:51.284 [NetEase]iOSNtUniSdkFrameworkDemo[22831:4107] [NtUniSdk] IAP jsonResponse: {\n    \treceipt =     {\n        \tbid = \"com.netease.sdk.test\";\n        \tbvrs = \"1.0\";\n        \t\"item_id\" = 892617314;\n        \t\"original_purchase_date\" = \"2014-07-24 07:43:14 Etc/GMT\";\n        \t\"original_purchase_date_ms\" = 1406187794660;\n        \t\"original_purchase_date_pst\" = \"2014-07-24 00:43:14 America/Los_Angeles\";\n        \t\"original_transaction_id\" = 1000000117879059;\n        \t\"product_id\" = \"com.netease.sdk.test.item2\";\n        \t\"purchase_date\" = \"2014-07-24 07:43:14 Etc/GMT\";\n        \t\"purchase_date_ms\" = 1406187794660;\n        \t\"purchase_date_pst\" = \"2014-07-24 00:43:14 America/Los_Angeles\";\n        \tquantity = 1;\n        \t\"transaction_id\" = 1000000117879059;\n        \t\"unique_identifier\" = 0000b0196818;\n        \t\"unique_vendor_identifier\" = \"FEF4F2DB-D07D-4B96-8F22-592A4B9CBAE7\";\n    \t};\n    \tstatus = 0;\n\t}\n\n而新接口返回的receipt：\n\n\t2014-07-24 17:11:16.475 [NetEase]iOSNtUniSdkFrameworkDemo[185:748f] [NtUniSdk] IAP jsonResponse: {\n    \tenvironment = Sandbox;\n    \treceipt =     {\n        \t\"adam_id\" = 0;\n        \t\"application_version\" = \"1.0\";\n        \t\"bundle_id\" = \"com.netease.sdk.test\";\n        \t\"download_id\" = 0;\n        \t\"in_app\" =         (\n                        \t{\n                \t\"is_trial_period\" = false;\n                \t\"original_purchase_date\" = \"2014-07-24 09:11:00 Etc/GMT\";\n                \t\"original_purchase_date_ms\" = 1406193060000;\n                \t\"original_purchase_date_pst\" = \"2014-07-24 02:11:00 America/Los_Angeles\";\n                \t\"original_transaction_id\" = 1000000117894869;\n                \t\"product_id\" = \"com.netease.sdk.test.item2\";\n                \t\"purchase_date\" = \"2014-07-24 09:11:01 Etc/GMT\";\n                \t\"purchase_date_ms\" = 1406193061000;\n                \t\"purchase_date_pst\" = \"2014-07-24 02:11:01 America/Los_Angeles\";\n                \tquantity = 1;\n                \t\"transaction_id\" = 1000000117894869;\n            \t}\n        \t);\n        \t\"original_application_version\" = \"1.0\";\n        \t\"original_purchase_date\" = \"2013-08-01 07:00:00 Etc/GMT\";\n        \t\"original_purchase_date_ms\" = 1375340400000;\n        \t\"original_purchase_date_pst\" = \"2013-08-01 00:00:00 America/Los_Angeles\";\n        \t\"receipt_type\" = ProductionSandbox;\n        \t\"request_date\" = \"2014-07-24 09:11:17 Etc/GMT\";\n        \t\"request_date_ms\" = 1406193077021;\n        \t\"request_date_pst\" = \"2014-07-24 02:11:17 America/Los_Angeles\";\n    \t};\n    \tstatus = 0;\n\t}\n\n新旧receipt在验证API接口方面无变化，变化主要在于返回的jsonResponese格式。\n新的jsonResponese格式官网文档如下：\n>Receipt Fields\n>https://developer.apple.com/library/ios/releasenotes/General/ValidateAppStoreReceipt/Chapters/ReceiptFields.html#//apple_ref/doc/uid/TP40010573-CH106-SW1\n\n下面是程序中实际输出jsonResponese的Log，值得注意的有receipt字段中的in_app字段可能包含多个transaction的receipt。\n客户端APP中的新接口每次读取将读取出还没读取过的所有receipt，当上一次transaction完成后，但没有成功调用到读取receipt接口时，即将出现多条，如下第二条Log所示。\n\n\t2014-07-24 16:06:52.077 [NetEase]iOSNtUniSdkFrameworkDemo[164:3e0b] [NtUniSdk] IAP jsonResponse: {\n    \tenvironment = Sandbox;\n    \treceipt =     {\n        \t\"adam_id\" = 0;\n        \t\"application_version\" = \"1.0\";\n        \t\"bundle_id\" = \"com.netease.sdk.test\";\n        \t\"download_id\" = 0;\n        \t\"in_app\" =         (\n            \t            {\n                \t\"is_trial_period\" = false;\n                \t\"original_purchase_date\" = \"2014-06-23 06:59:55 Etc/GMT\";\n                \t\"original_purchase_date_ms\" = 1403506795000;\n                \t\"original_purchase_date_pst\" = \"2014-06-22 23:59:55 America/Los_Angeles\";\n                \t\"original_transaction_id\" = 1000000114795007;\n                \t\"product_id\" = \"com.netease.sdk.test.item1\";\n                \t\"purchase_date\" = \"2014-06-24 09:06:09 Etc/GMT\";\n                \t\"purchase_date_ms\" = 1403600769000;\n                \t\"purchase_date_pst\" = \"2014-06-24 02:06:09 America/Los_Angeles\";\n                \tquantity = 1;\n                \t\"transaction_id\" = 1000000114795007;\n            \t},\n                \t        {\n                \t\"is_trial_period\" = false;\n                \t\"original_purchase_date\" = \"2014-06-24 09:06:09 Etc/GMT\";\n                \t\"original_purchase_date_ms\" = 1403600769000;\n                \t\"original_purchase_date_pst\" = \"2014-06-24 02:06:09 America/Los_Angeles\";\n                \t\"original_transaction_id\" = 1000000114938703;\n                \t\"product_id\" = \"com.netease.sdk.test.item3\";\n                \t\"purchase_date\" = \"2014-06-24 09:06:09 Etc/GMT\";\n                \t\"purchase_date_ms\" = 1403600769000;\n                \t\"purchase_date_pst\" = \"2014-06-24 02:06:09 America/Los_Angeles\";\n                \tquantity = 1;\n                \t\"transaction_id\" = 1000000114938703;\n            \t}\n        \t);\n        \t\"original_application_version\" = \"1.0\";\n        \t\"original_purchase_date\" = \"2013-08-01 07:00:00 Etc/GMT\";\n        \t\"original_purchase_date_ms\" = 1375340400000;\n        \t\"original_purchase_date_pst\" = \"2013-08-01 00:00:00 America/Los_Angeles\";\n        \t\"receipt_type\" = ProductionSandbox;\n        \t\"request_date\" = \"2014-07-24 08:06:54 Etc/GMT\";\n        \t\"request_date_ms\" = 1406189214105;\n        \t\"request_date_pst\" = \"2014-07-24 01:06:54 America/Los_Angeles\";\n   \t\t};\n    \tstatus = 0;\n\t}\n\nApple的IAP一直存在一个比较蛋疼的问题，在IAP的交易订单上没有填写额外信息的地方。由于存在网游的账号和AppStore支付账号两套系统，道具发放一直存在着可能在支付过程意外中断而导致漏洞的情况。iOS7.0在SKPayment中提供了一个applicationUsername属性用于填写用户信息，不过鉴于iOS7.0－的系统中没有该属性，在短时间内对这种意外情况改善也不大。\n\n","slug":"About_IAP_Receipt","published":1,"updated":"2016-08-07T11:27:12.928Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cirkp6cvb0002h8g67y3f12lo","content":"<p>iOS7.0后，SKPayment的property transactionReceipt变成了DEPRECATED。</p>\n<p>建议使用新接口来实现receipt的获取。</p>\n<pre><code>[[[NSBundle mainBundle] appStoreReceiptURL] dataWithContentsOfURL:receiptURL];\n</code></pre><p>如果使用了IAP，Apple官方的建议是使用下列代码来处理：</p>\n<pre><code>NSData *receipt = nil;\n\nif (floor(NSFoundationVersionNumber) &lt;= NSFoundationVersionNumber_iOS_6_1) {\n    // Load resources for iOS 6.1 or earlier\n    receipt = transaction.transactionReceipt;\n\n} else {\n    NSURL *receiptURL = [[NSBundle mainBundle] appStoreReceiptURL];\n    receipt = [NSData dataWithContentsOfURL:receiptURL];\n}\n</code></pre><p>上面的代码很容易以为，新旧接口取得的receipt格式是一致的。其实不然。</p>\n <a id=\"more\"></a> \n<p>在NtUniSdk里面,iOS官方渠道的易信和网易通行证使用了IAP,然后使用了上述Apple官方建议的代码，结果就是receipt格式不一致，计费验证不通过，把接入SDK的G3坑了一顿。</p>\n<p>原来旧接口返回的receipt如下：</p>\n<pre><code>2014-07-24 15:53:51.284 [NetEase]iOSNtUniSdkFrameworkDemo[22831:4107] [NtUniSdk] IAP jsonResponse: {\n    receipt =     {\n        bid = &quot;com.netease.sdk.test&quot;;\n        bvrs = &quot;1.0&quot;;\n        &quot;item_id&quot; = 892617314;\n        &quot;original_purchase_date&quot; = &quot;2014-07-24 07:43:14 Etc/GMT&quot;;\n        &quot;original_purchase_date_ms&quot; = 1406187794660;\n        &quot;original_purchase_date_pst&quot; = &quot;2014-07-24 00:43:14 America/Los_Angeles&quot;;\n        &quot;original_transaction_id&quot; = 1000000117879059;\n        &quot;product_id&quot; = &quot;com.netease.sdk.test.item2&quot;;\n        &quot;purchase_date&quot; = &quot;2014-07-24 07:43:14 Etc/GMT&quot;;\n        &quot;purchase_date_ms&quot; = 1406187794660;\n        &quot;purchase_date_pst&quot; = &quot;2014-07-24 00:43:14 America/Los_Angeles&quot;;\n        quantity = 1;\n        &quot;transaction_id&quot; = 1000000117879059;\n        &quot;unique_identifier&quot; = 0000b0196818;\n        &quot;unique_vendor_identifier&quot; = &quot;FEF4F2DB-D07D-4B96-8F22-592A4B9CBAE7&quot;;\n    };\n    status = 0;\n}\n</code></pre><p>而新接口返回的receipt：</p>\n<pre><code>2014-07-24 17:11:16.475 [NetEase]iOSNtUniSdkFrameworkDemo[185:748f] [NtUniSdk] IAP jsonResponse: {\n    environment = Sandbox;\n    receipt =     {\n        &quot;adam_id&quot; = 0;\n        &quot;application_version&quot; = &quot;1.0&quot;;\n        &quot;bundle_id&quot; = &quot;com.netease.sdk.test&quot;;\n        &quot;download_id&quot; = 0;\n        &quot;in_app&quot; =         (\n                        {\n                &quot;is_trial_period&quot; = false;\n                &quot;original_purchase_date&quot; = &quot;2014-07-24 09:11:00 Etc/GMT&quot;;\n                &quot;original_purchase_date_ms&quot; = 1406193060000;\n                &quot;original_purchase_date_pst&quot; = &quot;2014-07-24 02:11:00 America/Los_Angeles&quot;;\n                &quot;original_transaction_id&quot; = 1000000117894869;\n                &quot;product_id&quot; = &quot;com.netease.sdk.test.item2&quot;;\n                &quot;purchase_date&quot; = &quot;2014-07-24 09:11:01 Etc/GMT&quot;;\n                &quot;purchase_date_ms&quot; = 1406193061000;\n                &quot;purchase_date_pst&quot; = &quot;2014-07-24 02:11:01 America/Los_Angeles&quot;;\n                quantity = 1;\n                &quot;transaction_id&quot; = 1000000117894869;\n            }\n        );\n        &quot;original_application_version&quot; = &quot;1.0&quot;;\n        &quot;original_purchase_date&quot; = &quot;2013-08-01 07:00:00 Etc/GMT&quot;;\n        &quot;original_purchase_date_ms&quot; = 1375340400000;\n        &quot;original_purchase_date_pst&quot; = &quot;2013-08-01 00:00:00 America/Los_Angeles&quot;;\n        &quot;receipt_type&quot; = ProductionSandbox;\n        &quot;request_date&quot; = &quot;2014-07-24 09:11:17 Etc/GMT&quot;;\n        &quot;request_date_ms&quot; = 1406193077021;\n        &quot;request_date_pst&quot; = &quot;2014-07-24 02:11:17 America/Los_Angeles&quot;;\n    };\n    status = 0;\n}\n</code></pre><p>新旧receipt在验证API接口方面无变化，变化主要在于返回的jsonResponese格式。<br>新的jsonResponese格式官网文档如下：</p>\n<blockquote>\n<p>Receipt Fields<br><a href=\"https://developer.apple.com/library/ios/releasenotes/General/ValidateAppStoreReceipt/Chapters/ReceiptFields.html#//apple_ref/doc/uid/TP40010573-CH106-SW1\" target=\"_blank\" rel=\"external\">https://developer.apple.com/library/ios/releasenotes/General/ValidateAppStoreReceipt/Chapters/ReceiptFields.html#//apple_ref/doc/uid/TP40010573-CH106-SW1</a></p>\n</blockquote>\n<p>下面是程序中实际输出jsonResponese的Log，值得注意的有receipt字段中的in_app字段可能包含多个transaction的receipt。<br>客户端APP中的新接口每次读取将读取出还没读取过的所有receipt，当上一次transaction完成后，但没有成功调用到读取receipt接口时，即将出现多条，如下第二条Log所示。</p>\n<pre><code>2014-07-24 16:06:52.077 [NetEase]iOSNtUniSdkFrameworkDemo[164:3e0b] [NtUniSdk] IAP jsonResponse: {\n    environment = Sandbox;\n    receipt =     {\n        &quot;adam_id&quot; = 0;\n        &quot;application_version&quot; = &quot;1.0&quot;;\n        &quot;bundle_id&quot; = &quot;com.netease.sdk.test&quot;;\n        &quot;download_id&quot; = 0;\n        &quot;in_app&quot; =         (\n                        {\n                &quot;is_trial_period&quot; = false;\n                &quot;original_purchase_date&quot; = &quot;2014-06-23 06:59:55 Etc/GMT&quot;;\n                &quot;original_purchase_date_ms&quot; = 1403506795000;\n                &quot;original_purchase_date_pst&quot; = &quot;2014-06-22 23:59:55 America/Los_Angeles&quot;;\n                &quot;original_transaction_id&quot; = 1000000114795007;\n                &quot;product_id&quot; = &quot;com.netease.sdk.test.item1&quot;;\n                &quot;purchase_date&quot; = &quot;2014-06-24 09:06:09 Etc/GMT&quot;;\n                &quot;purchase_date_ms&quot; = 1403600769000;\n                &quot;purchase_date_pst&quot; = &quot;2014-06-24 02:06:09 America/Los_Angeles&quot;;\n                quantity = 1;\n                &quot;transaction_id&quot; = 1000000114795007;\n            },\n                        {\n                &quot;is_trial_period&quot; = false;\n                &quot;original_purchase_date&quot; = &quot;2014-06-24 09:06:09 Etc/GMT&quot;;\n                &quot;original_purchase_date_ms&quot; = 1403600769000;\n                &quot;original_purchase_date_pst&quot; = &quot;2014-06-24 02:06:09 America/Los_Angeles&quot;;\n                &quot;original_transaction_id&quot; = 1000000114938703;\n                &quot;product_id&quot; = &quot;com.netease.sdk.test.item3&quot;;\n                &quot;purchase_date&quot; = &quot;2014-06-24 09:06:09 Etc/GMT&quot;;\n                &quot;purchase_date_ms&quot; = 1403600769000;\n                &quot;purchase_date_pst&quot; = &quot;2014-06-24 02:06:09 America/Los_Angeles&quot;;\n                quantity = 1;\n                &quot;transaction_id&quot; = 1000000114938703;\n            }\n        );\n        &quot;original_application_version&quot; = &quot;1.0&quot;;\n        &quot;original_purchase_date&quot; = &quot;2013-08-01 07:00:00 Etc/GMT&quot;;\n        &quot;original_purchase_date_ms&quot; = 1375340400000;\n        &quot;original_purchase_date_pst&quot; = &quot;2013-08-01 00:00:00 America/Los_Angeles&quot;;\n        &quot;receipt_type&quot; = ProductionSandbox;\n        &quot;request_date&quot; = &quot;2014-07-24 08:06:54 Etc/GMT&quot;;\n        &quot;request_date_ms&quot; = 1406189214105;\n        &quot;request_date_pst&quot; = &quot;2014-07-24 01:06:54 America/Los_Angeles&quot;;\n       };\n    status = 0;\n}\n</code></pre><p>Apple的IAP一直存在一个比较蛋疼的问题，在IAP的交易订单上没有填写额外信息的地方。由于存在网游的账号和AppStore支付账号两套系统，道具发放一直存在着可能在支付过程意外中断而导致漏洞的情况。iOS7.0在SKPayment中提供了一个applicationUsername属性用于填写用户信息，不过鉴于iOS7.0－的系统中没有该属性，在短时间内对这种意外情况改善也不大。</p>\n","excerpt":"<p>iOS7.0后，SKPayment的property transactionReceipt变成了DEPRECATED。</p>\n<p>建议使用新接口来实现receipt的获取。</p>\n<pre><code>[[[NSBundle mainBundle] appStoreReceiptURL] dataWithContentsOfURL:receiptURL];\n</code></pre><p>如果使用了IAP，Apple官方的建议是使用下列代码来处理：</p>\n<pre><code>NSData *receipt = nil;\n\nif (floor(NSFoundationVersionNumber) &lt;= NSFoundationVersionNumber_iOS_6_1) {\n    // Load resources for iOS 6.1 or earlier\n    receipt = transaction.transactionReceipt;\n\n} else {\n    NSURL *receiptURL = [[NSBundle mainBundle] appStoreReceiptURL];\n    receipt = [NSData dataWithContentsOfURL:receiptURL];\n}\n</code></pre><p>上面的代码很容易以为，新旧接口取得的receipt格式是一致的。其实不然。</p>","more":"<p>在NtUniSdk里面,iOS官方渠道的易信和网易通行证使用了IAP,然后使用了上述Apple官方建议的代码，结果就是receipt格式不一致，计费验证不通过，把接入SDK的G3坑了一顿。</p>\n<p>原来旧接口返回的receipt如下：</p>\n<pre><code>2014-07-24 15:53:51.284 [NetEase]iOSNtUniSdkFrameworkDemo[22831:4107] [NtUniSdk] IAP jsonResponse: {\n    receipt =     {\n        bid = &quot;com.netease.sdk.test&quot;;\n        bvrs = &quot;1.0&quot;;\n        &quot;item_id&quot; = 892617314;\n        &quot;original_purchase_date&quot; = &quot;2014-07-24 07:43:14 Etc/GMT&quot;;\n        &quot;original_purchase_date_ms&quot; = 1406187794660;\n        &quot;original_purchase_date_pst&quot; = &quot;2014-07-24 00:43:14 America/Los_Angeles&quot;;\n        &quot;original_transaction_id&quot; = 1000000117879059;\n        &quot;product_id&quot; = &quot;com.netease.sdk.test.item2&quot;;\n        &quot;purchase_date&quot; = &quot;2014-07-24 07:43:14 Etc/GMT&quot;;\n        &quot;purchase_date_ms&quot; = 1406187794660;\n        &quot;purchase_date_pst&quot; = &quot;2014-07-24 00:43:14 America/Los_Angeles&quot;;\n        quantity = 1;\n        &quot;transaction_id&quot; = 1000000117879059;\n        &quot;unique_identifier&quot; = 0000b0196818;\n        &quot;unique_vendor_identifier&quot; = &quot;FEF4F2DB-D07D-4B96-8F22-592A4B9CBAE7&quot;;\n    };\n    status = 0;\n}\n</code></pre><p>而新接口返回的receipt：</p>\n<pre><code>2014-07-24 17:11:16.475 [NetEase]iOSNtUniSdkFrameworkDemo[185:748f] [NtUniSdk] IAP jsonResponse: {\n    environment = Sandbox;\n    receipt =     {\n        &quot;adam_id&quot; = 0;\n        &quot;application_version&quot; = &quot;1.0&quot;;\n        &quot;bundle_id&quot; = &quot;com.netease.sdk.test&quot;;\n        &quot;download_id&quot; = 0;\n        &quot;in_app&quot; =         (\n                        {\n                &quot;is_trial_period&quot; = false;\n                &quot;original_purchase_date&quot; = &quot;2014-07-24 09:11:00 Etc/GMT&quot;;\n                &quot;original_purchase_date_ms&quot; = 1406193060000;\n                &quot;original_purchase_date_pst&quot; = &quot;2014-07-24 02:11:00 America/Los_Angeles&quot;;\n                &quot;original_transaction_id&quot; = 1000000117894869;\n                &quot;product_id&quot; = &quot;com.netease.sdk.test.item2&quot;;\n                &quot;purchase_date&quot; = &quot;2014-07-24 09:11:01 Etc/GMT&quot;;\n                &quot;purchase_date_ms&quot; = 1406193061000;\n                &quot;purchase_date_pst&quot; = &quot;2014-07-24 02:11:01 America/Los_Angeles&quot;;\n                quantity = 1;\n                &quot;transaction_id&quot; = 1000000117894869;\n            }\n        );\n        &quot;original_application_version&quot; = &quot;1.0&quot;;\n        &quot;original_purchase_date&quot; = &quot;2013-08-01 07:00:00 Etc/GMT&quot;;\n        &quot;original_purchase_date_ms&quot; = 1375340400000;\n        &quot;original_purchase_date_pst&quot; = &quot;2013-08-01 00:00:00 America/Los_Angeles&quot;;\n        &quot;receipt_type&quot; = ProductionSandbox;\n        &quot;request_date&quot; = &quot;2014-07-24 09:11:17 Etc/GMT&quot;;\n        &quot;request_date_ms&quot; = 1406193077021;\n        &quot;request_date_pst&quot; = &quot;2014-07-24 02:11:17 America/Los_Angeles&quot;;\n    };\n    status = 0;\n}\n</code></pre><p>新旧receipt在验证API接口方面无变化，变化主要在于返回的jsonResponese格式。<br>新的jsonResponese格式官网文档如下：</p>\n<blockquote>\n<p>Receipt Fields<br><a href=\"https://developer.apple.com/library/ios/releasenotes/General/ValidateAppStoreReceipt/Chapters/ReceiptFields.html#//apple_ref/doc/uid/TP40010573-CH106-SW1\">https://developer.apple.com/library/ios/releasenotes/General/ValidateAppStoreReceipt/Chapters/ReceiptFields.html#//apple_ref/doc/uid/TP40010573-CH106-SW1</a></p>\n</blockquote>\n<p>下面是程序中实际输出jsonResponese的Log，值得注意的有receipt字段中的in_app字段可能包含多个transaction的receipt。<br>客户端APP中的新接口每次读取将读取出还没读取过的所有receipt，当上一次transaction完成后，但没有成功调用到读取receipt接口时，即将出现多条，如下第二条Log所示。</p>\n<pre><code>2014-07-24 16:06:52.077 [NetEase]iOSNtUniSdkFrameworkDemo[164:3e0b] [NtUniSdk] IAP jsonResponse: {\n    environment = Sandbox;\n    receipt =     {\n        &quot;adam_id&quot; = 0;\n        &quot;application_version&quot; = &quot;1.0&quot;;\n        &quot;bundle_id&quot; = &quot;com.netease.sdk.test&quot;;\n        &quot;download_id&quot; = 0;\n        &quot;in_app&quot; =         (\n                        {\n                &quot;is_trial_period&quot; = false;\n                &quot;original_purchase_date&quot; = &quot;2014-06-23 06:59:55 Etc/GMT&quot;;\n                &quot;original_purchase_date_ms&quot; = 1403506795000;\n                &quot;original_purchase_date_pst&quot; = &quot;2014-06-22 23:59:55 America/Los_Angeles&quot;;\n                &quot;original_transaction_id&quot; = 1000000114795007;\n                &quot;product_id&quot; = &quot;com.netease.sdk.test.item1&quot;;\n                &quot;purchase_date&quot; = &quot;2014-06-24 09:06:09 Etc/GMT&quot;;\n                &quot;purchase_date_ms&quot; = 1403600769000;\n                &quot;purchase_date_pst&quot; = &quot;2014-06-24 02:06:09 America/Los_Angeles&quot;;\n                quantity = 1;\n                &quot;transaction_id&quot; = 1000000114795007;\n            },\n                        {\n                &quot;is_trial_period&quot; = false;\n                &quot;original_purchase_date&quot; = &quot;2014-06-24 09:06:09 Etc/GMT&quot;;\n                &quot;original_purchase_date_ms&quot; = 1403600769000;\n                &quot;original_purchase_date_pst&quot; = &quot;2014-06-24 02:06:09 America/Los_Angeles&quot;;\n                &quot;original_transaction_id&quot; = 1000000114938703;\n                &quot;product_id&quot; = &quot;com.netease.sdk.test.item3&quot;;\n                &quot;purchase_date&quot; = &quot;2014-06-24 09:06:09 Etc/GMT&quot;;\n                &quot;purchase_date_ms&quot; = 1403600769000;\n                &quot;purchase_date_pst&quot; = &quot;2014-06-24 02:06:09 America/Los_Angeles&quot;;\n                quantity = 1;\n                &quot;transaction_id&quot; = 1000000114938703;\n            }\n        );\n        &quot;original_application_version&quot; = &quot;1.0&quot;;\n        &quot;original_purchase_date&quot; = &quot;2013-08-01 07:00:00 Etc/GMT&quot;;\n        &quot;original_purchase_date_ms&quot; = 1375340400000;\n        &quot;original_purchase_date_pst&quot; = &quot;2013-08-01 00:00:00 America/Los_Angeles&quot;;\n        &quot;receipt_type&quot; = ProductionSandbox;\n        &quot;request_date&quot; = &quot;2014-07-24 08:06:54 Etc/GMT&quot;;\n        &quot;request_date_ms&quot; = 1406189214105;\n        &quot;request_date_pst&quot; = &quot;2014-07-24 01:06:54 America/Los_Angeles&quot;;\n       };\n    status = 0;\n}\n</code></pre><p>Apple的IAP一直存在一个比较蛋疼的问题，在IAP的交易订单上没有填写额外信息的地方。由于存在网游的账号和AppStore支付账号两套系统，道具发放一直存在着可能在支付过程意外中断而导致漏洞的情况。iOS7.0在SKPayment中提供了一个applicationUsername属性用于填写用户信息，不过鉴于iOS7.0－的系统中没有该属性，在短时间内对这种意外情况改善也不大。</p>"},{"title":"A_New_Blog","date":"2014-07-17T00:25:34.000Z","_content":"\n折腾了几天，先post上第一篇。\n","source":"_posts/A_New_Blog.md","raw":"title: A_New_Blog\ndate: 2014-07-17 08:25:34\ntags: daily\n---\n\n折腾了几天，先post上第一篇。\n","slug":"A_New_Blog","published":1,"updated":"2016-08-07T11:27:12.928Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cirkp6cvf0004h8g6ssvx44d8","content":"<p>折腾了几天，先post上第一篇。</p>\n","excerpt":"","more":"<p>折腾了几天，先post上第一篇。</p>\n"},{"title":"黑魔法之Xcode Plugin开发","date":"2014-11-24T14:42:01.000Z","_content":"\nXcode 插件的黑科技\n\n##1. 取得项目路径\n\n先贴段代码：\n\n    NSString *workspacePath = @\"\";\n    \n    // to find current project path\n    NSArray *workspaceWindowControllers = [NSClassFromString(@\"IDEWorkspaceWindowController\") valueForKey:@\"workspaceWindowControllers\"];\n    id workSpace;\n    for (id controller in workspaceWindowControllers) {\n        if ([[controller valueForKey:@\"window\"] isEqual:[NSApp keyWindow]]) {\n            workSpace = [controller valueForKey:@\"_workspace\"];\n        }\n    }\n    \n    if (workSpace) {\n        workspacePath = [[workSpace valueForKey:@\"representingFilePath\"] valueForKey:@\"_pathString\"];\n    }\n    \n这段代码位于 BMPlugin.m 中，作用是取得当前 workspace，并读取其文件路径。\n\n <!-- more --> \n\n> 由于 Xcode 插件开发基本无文档可查，这段代码也是从网上 copy 回来的。完全没有系统了解的方法。\n> \n> 值得注意的是，这些都不是公开的API，所以，Xcode 版本迭代时，注意检查兼容性。\n> \n\n##2. 标示支持的 Xcode 版本\n\n插件项目的 info.plist 需要添加 DVTPlugInCompatibilityUUIDs 标示支持的 Xcode 版本。\n\n当前 Xcode 版本的 DVTPlugInCompatibilityUUID 可在 Xcode.app/Contents/Info.plist 找到。\n\n如果对应 Xcode 版本的 DVTPlugInCompatibilityUUID 没有被添加到 info.plist 中，那么该版本 Xcode 启动时不会加载插件。\n\n##3. XCPluginHasUI NO\n\n> Set XCPluginHasUI in Info.plist to YES to disable your plugin\n\n记得这个属性 XCPluginHasUI 需要设置为 NO。\n\n##4. 其他需要注意的\n\n编译的时候记得把 .xib 界面文件添加到 Compile Sources 里面，否则，编译出来的包里面没有对应的 .nib 。\n","source":"_posts/Black_Magic_Xcode_Plugin.md","raw":"title: 黑魔法之Xcode Plugin开发 \ndate: 2014-11-24 22:42:01\ntags: [Xcode,Plugin]\n---\n\nXcode 插件的黑科技\n\n##1. 取得项目路径\n\n先贴段代码：\n\n    NSString *workspacePath = @\"\";\n    \n    // to find current project path\n    NSArray *workspaceWindowControllers = [NSClassFromString(@\"IDEWorkspaceWindowController\") valueForKey:@\"workspaceWindowControllers\"];\n    id workSpace;\n    for (id controller in workspaceWindowControllers) {\n        if ([[controller valueForKey:@\"window\"] isEqual:[NSApp keyWindow]]) {\n            workSpace = [controller valueForKey:@\"_workspace\"];\n        }\n    }\n    \n    if (workSpace) {\n        workspacePath = [[workSpace valueForKey:@\"representingFilePath\"] valueForKey:@\"_pathString\"];\n    }\n    \n这段代码位于 BMPlugin.m 中，作用是取得当前 workspace，并读取其文件路径。\n\n <!-- more --> \n\n> 由于 Xcode 插件开发基本无文档可查，这段代码也是从网上 copy 回来的。完全没有系统了解的方法。\n> \n> 值得注意的是，这些都不是公开的API，所以，Xcode 版本迭代时，注意检查兼容性。\n> \n\n##2. 标示支持的 Xcode 版本\n\n插件项目的 info.plist 需要添加 DVTPlugInCompatibilityUUIDs 标示支持的 Xcode 版本。\n\n当前 Xcode 版本的 DVTPlugInCompatibilityUUID 可在 Xcode.app/Contents/Info.plist 找到。\n\n如果对应 Xcode 版本的 DVTPlugInCompatibilityUUID 没有被添加到 info.plist 中，那么该版本 Xcode 启动时不会加载插件。\n\n##3. XCPluginHasUI NO\n\n> Set XCPluginHasUI in Info.plist to YES to disable your plugin\n\n记得这个属性 XCPluginHasUI 需要设置为 NO。\n\n##4. 其他需要注意的\n\n编译的时候记得把 .xib 界面文件添加到 Compile Sources 里面，否则，编译出来的包里面没有对应的 .nib 。\n","slug":"Black_Magic_Xcode_Plugin","published":1,"updated":"2016-08-07T11:27:12.937Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cirkp6cvh0005h8g65s1sgszx","content":"<p>Xcode 插件的黑科技</p>\n<p>##1. 取得项目路径</p>\n<p>先贴段代码：</p>\n<pre><code>NSString *workspacePath = @&quot;&quot;;\n\n// to find current project path\nNSArray *workspaceWindowControllers = [NSClassFromString(@&quot;IDEWorkspaceWindowController&quot;) valueForKey:@&quot;workspaceWindowControllers&quot;];\nid workSpace;\nfor (id controller in workspaceWindowControllers) {\n    if ([[controller valueForKey:@&quot;window&quot;] isEqual:[NSApp keyWindow]]) {\n        workSpace = [controller valueForKey:@&quot;_workspace&quot;];\n    }\n}\n\nif (workSpace) {\n    workspacePath = [[workSpace valueForKey:@&quot;representingFilePath&quot;] valueForKey:@&quot;_pathString&quot;];\n}\n</code></pre><p>这段代码位于 BMPlugin.m 中，作用是取得当前 workspace，并读取其文件路径。</p>\n <a id=\"more\"></a> \n<blockquote>\n<p>由于 Xcode 插件开发基本无文档可查，这段代码也是从网上 copy 回来的。完全没有系统了解的方法。</p>\n<p>值得注意的是，这些都不是公开的API，所以，Xcode 版本迭代时，注意检查兼容性。</p>\n</blockquote>\n<p>##2. 标示支持的 Xcode 版本</p>\n<p>插件项目的 info.plist 需要添加 DVTPlugInCompatibilityUUIDs 标示支持的 Xcode 版本。</p>\n<p>当前 Xcode 版本的 DVTPlugInCompatibilityUUID 可在 Xcode.app/Contents/Info.plist 找到。</p>\n<p>如果对应 Xcode 版本的 DVTPlugInCompatibilityUUID 没有被添加到 info.plist 中，那么该版本 Xcode 启动时不会加载插件。</p>\n<p>##3. XCPluginHasUI NO</p>\n<blockquote>\n<p>Set XCPluginHasUI in Info.plist to YES to disable your plugin</p>\n</blockquote>\n<p>记得这个属性 XCPluginHasUI 需要设置为 NO。</p>\n<p>##4. 其他需要注意的</p>\n<p>编译的时候记得把 .xib 界面文件添加到 Compile Sources 里面，否则，编译出来的包里面没有对应的 .nib 。</p>\n","excerpt":"<p>Xcode 插件的黑科技</p>\n<p>##1. 取得项目路径</p>\n<p>先贴段代码：</p>\n<pre><code>NSString *workspacePath = @&quot;&quot;;\n\n// to find current project path\nNSArray *workspaceWindowControllers = [NSClassFromString(@&quot;IDEWorkspaceWindowController&quot;) valueForKey:@&quot;workspaceWindowControllers&quot;];\nid workSpace;\nfor (id controller in workspaceWindowControllers) {\n    if ([[controller valueForKey:@&quot;window&quot;] isEqual:[NSApp keyWindow]]) {\n        workSpace = [controller valueForKey:@&quot;_workspace&quot;];\n    }\n}\n\nif (workSpace) {\n    workspacePath = [[workSpace valueForKey:@&quot;representingFilePath&quot;] valueForKey:@&quot;_pathString&quot;];\n}\n</code></pre><p>这段代码位于 BMPlugin.m 中，作用是取得当前 workspace，并读取其文件路径。</p>","more":"<blockquote>\n<p>由于 Xcode 插件开发基本无文档可查，这段代码也是从网上 copy 回来的。完全没有系统了解的方法。</p>\n<p>值得注意的是，这些都不是公开的API，所以，Xcode 版本迭代时，注意检查兼容性。</p>\n</blockquote>\n<p>##2. 标示支持的 Xcode 版本</p>\n<p>插件项目的 info.plist 需要添加 DVTPlugInCompatibilityUUIDs 标示支持的 Xcode 版本。</p>\n<p>当前 Xcode 版本的 DVTPlugInCompatibilityUUID 可在 Xcode.app/Contents/Info.plist 找到。</p>\n<p>如果对应 Xcode 版本的 DVTPlugInCompatibilityUUID 没有被添加到 info.plist 中，那么该版本 Xcode 启动时不会加载插件。</p>\n<p>##3. XCPluginHasUI NO</p>\n<blockquote>\n<p>Set XCPluginHasUI in Info.plist to YES to disable your plugin</p>\n</blockquote>\n<p>记得这个属性 XCPluginHasUI 需要设置为 NO。</p>\n<p>##4. 其他需要注意的</p>\n<p>编译的时候记得把 .xib 界面文件添加到 Compile Sources 里面，否则，编译出来的包里面没有对应的 .nib 。</p>"},{"title":"黑魔法之 iOS Flash ANE 打包","date":"2014-08-14T18:09:46.000Z","_content":"\nMA6-僵尸 使用Flash Air开发，故iOS SDK需包装一个Flash ANE版本。\n\n用到的环境有：Flash Builder 4.7、Xcode 5.1.1、iOS SDK 7.1\n\n## Flash Flex 项目 ##\n\n在Flash Buildder中建立一个 **Flex手机项目库** ，新建一个.as脚本，实现as的wrapper。\n下面给了个简化的项目示例，注意其中用于实现回调的onStatus和初始化函数NtUniSdk4Flash。\n\n <!-- more --> \n\n\tpackage com.netease.ntunisdk\n\t{\n\t\timport flash.events.EventDispatcher;\n\t\timport flash.events.StatusEvent;\n\t\timport flash.external.ExtensionContext;\n\t\n\t\tpublic class NtUniSdk4Flash extends EventDispatcher\n\t\t{\n\t\t\tprivate static var _instance:NtUniSdk4Flash;\n\t\t\tprivate var extContext:ExtensionContext;\n\t\t\n\t\t\tpublic function ntInit():void\n\t\t\t{\n\t\t\t\textContext.call( \"__NtSdkMgr_ntInit\" );\n\t\t\t}\n\t\t\n\t\t\tpublic static function get instance():NtUniSdk4Flash {\n\t\t\t\tif ( !_instance ) {\n\t\t\t\t\t_instance = new NtUniSdk4Flash( new SingletonEnforcer() );\n\t\t\t\t}\n\t\t\t\treturn _instance;\n\t\t\t}\n\n\t\t\tpublic function dispose():void { \n\t\t\t\textContext.dispose(); \n\t\t\t}\n\t\t\n\t\t\tprivate function onStatus( event:StatusEvent ):void {\n\t\t\t\tdispatchEvent( new SDKNotification(event.code, false, false) );\n\t\t\t}\n\t\t\n\t\t\n\t\t\t/**\n\t\t \t* Constructor. \n\t\t \t*/\t\t\n\t\t\tpublic function NtUniSdk4Flash( enforcer:SingletonEnforcer ) {\n\t\t\t\tsuper();\n\t\t\t\n\t\t\t\textContext = ExtensionContext.createExtensionContext( \"com.netease.ntunisdk.ios.ane\", \"\" );\n\t\t\t\n\t\t\t\tif ( !extContext ) {\n\t\t\t\t\tthrow new Error( \"iOS NtUniSdk native extension is not supported on this platform.\" );\n\t\t\t\t}\n\t\t\t\n\t\t\t\textContext.addEventListener( StatusEvent.STATUS, onStatus );\n\t\t\t}\n\t\t}\n\t}\n\t\n\tclass SingletonEnforcer {\n\t\n\t}\n\t\n\t\n然后需要再建立一个extension.xml，示例再如下：\n\n\t<extension xmlns=\"http://ns.adobe.com/air/extension/3.1\"> \n    \t<id>com.netease.ntunisdk.ios.ane</id> \n    \t<versionNumber>0.0.1</versionNumber> \n    \t<platforms>  \n\t\t\t<platform name=\"iPhone-ARM\"> \n            \t<applicationDeployment> \n                \t<nativeLibrary>liblibNtUniSdk4Flash.a</nativeLibrary> \n                \t<initializer>ExtInitializer</initializer>\n            \t</applicationDeployment>\n        \t</platform>\n    \t</platforms> \n\t</extension>\n\t\n因为我们需要的只是iphone版本的ANE，所以只有iPhone-ARM一个平台。com.netease.ntunisdk.ios.ane和上面as代码中的ExtensionContext.createExtensionContext参数是对应的。\n\n然后，在菜单里，选择 项目 -> 构建项目，编译项目。如果你的构建项目事灰色的，那是打开了自动构建。把 项目 -> 自动构建 取消掉。\n\n这时候，可以等到 **产出1. 一个.swc文件** 。\n\n\n## Xcode 静态库项目 ##\n\n建立一个Coco Touch Static Library, 在Air SDK里找到 FlashRuntimeExtensions.h，添加到项目中。\n\n新建一个.m文件，下面给出项目简化版的示例：\n\n\t//\n\t//  libNtUniSdk4Flash.m\n\t//  libNtUniSdk4Flash\n\t//\n\t//  Created by Huang Quanyong on 14-8-7.\n\t//  Copyright (c) 2014年 Stupid Dumb Kids. All rights reserved.\n\t//\n\n\t#import \"FlashRuntimeExtensions.h\"\n\t#import \"UniHead.h\"\n\n\t#define STRING_BUFFER_SIZE 1024*128\n\n\t@interface __NtNotificationWrapper : NSObject\n\n\t@end\n\tstatic __NtNotificationWrapper *__inst = nil;\n\tstatic FREContext __context = NULL;\n\n\t@implementation __NtNotificationWrapper\n\n\t+ (void) initialize\n\t{\n    \tif (__inst) {\n        \treturn;\n    \t}\n    \n   \t\t__inst = [[__NtNotificationWrapper alloc] init];\n    \n    \t//初始化通知\n    \t[[NSNotificationCenter defaultCenter] addObserver:__inst selector:@selector(finishInitNotification:) name:NT_NOTIFICATION_FINISH_INIT object:nil];\n    \n    }\n\n\t//初始化完成处理\n\t- (void)finishInitNotification:(NSNotification *)notification\n\t{\n   \t\tNSString* str = NT_NOTIFICATION_FINISH_INIT;\n    \tconst uint8_t *code = (const uint8_t*) [str UTF8String];\n    \tFREDispatchStatusEventAsync(__context, code, code);\n    \tNSLog(@\"[NtUniSdk] Notification finishInit.\");\n\t}\n\n\t+ (void) doNothing{}\n\n\t@end\n\n\tFREObject __NtSdkMgr_ntInit(FREContext ctx, void* funcData, uint32_t argc, FREObject argv[])\n\t{\n    \tNSLog(@\"[NtUniSdk] __NtSdkMgr_ntInit\");\n    \t[__NtNotificationWrapper doNothing];\n    \t[NtSdkMgr ntInit];\n    \treturn NULL;\n\t}\n\t\n\t// InitNativeCode()\n\t//\n\t// An InitNativeCode function is necessary in the Android implementation of this extension.\n\t// Therefore, an analogous function is necessary in the iOS implementation to make\n\t// the ActionScript interface identical for all implementations.\n\t// However, the iOS implementation has nothing to do.\n\tFREObject InitNativeCode(FREContext ctx, void* funcData, uint32_t argc, FREObject argv[]) {\n    \n    \tNSLog(@\"Entering InitNativeCode()\");\n    \n    \t// Nothing to do.\n    \n    \tNSLog(@\"Exiting InitNativeCode()\");\n    \n    \treturn NULL;\n\t}\n\n\t// ContextInitializer()\n\t//\n\t// The context initializer is called when the runtime creates the extension context instance.\n\n\tvoid ContextInitializer(void* extData, const uint8_t* ctxType, FREContext ctx, uint32_t* numFunctionsToTest, const FRENamedFunction** functionsToSet) {\n    \n    \tNSLog(@\"Entering ContextInitializer()\");\n    \n    \t__context = ctx;\n    \n    \t*numFunctionsToTest = 22;\n    \tFRENamedFunction* func = (FRENamedFunction*) malloc(sizeof(FRENamedFunction) * *numFunctionsToTest);\n    \t\n    \t//Just for consistency with Android\n    \tfunc[0].name = (const uint8_t*) \"__NtSdkMgr_ntInit\";\n    \tfunc[0].functionData = NULL;\n    \tfunc[0].function = &__NtSdkMgr_ntInit;\n    \n    \t*functionsToSet = func;\n    \n    \tNSLog(@\"Exiting ContextInitializer()\");\n\t}\n\n\t// ContextFinalizer()\n\t//\n\t// The context finalizer is called when the extension's ActionScript code\n\t// calls the ExtensionContext instance's dispose() method.\n\t// If the AIR runtime garbage collector disposes of the ExtensionContext instance, the runtime also calls\n\t// ContextFinalizer().\n\n\tvoid ContextFinalizer(FREContext ctx) {\n    \n   \t \tNSLog(@\"Entering ContextFinalizer()\");\n    \n    \t// Nothing to clean up.\n    \n    \tNSLog(@\"Exiting ContextFinalizer()\");\n    \n    \treturn;\n\t}\n\n\t// ExtInitializer()\n\t//\n\t// The extension initializer is called the first time the ActionScript side of the extension\n\t// calls ExtensionContext.createExtensionContext() for any context.\n\n\tvoid ExtInitializer(void** extDataToSet, FREContextInitializer* ctxInitializerToSet, FREContextFinalizer* ctxFinalizerToSet) {\n    \n    \tNSLog(@\"Entering ExtInitializer()\");\n    \n    \t*extDataToSet = NULL;\n    \t*ctxInitializerToSet = &ContextInitializer;\n    \t*ctxFinalizerToSet = &ContextFinalizer;\n    \n    \tNSLog(@\"Exiting ExtInitializer()\");\n\t}\n\n\t// ExtFinalizer()\n\t//\n\t// The extension finalizer is called when the runtime unloads the extension. However, it is not always called.\n\n\tvoid ExtFinalizer(void* extData) {\n    \n    \tNSLog(@\"Entering ExtFinalizer()\");\n    \n    \t// Nothing to clean up.\n    \n    \tNSLog(@\"Exiting ExtFinalizer()\");\n    \treturn;\n\t}\n\t\n注意中间消息的回调实现，调用FREDispatchStatusEventAsync，会触发as里的onStatus。\n\n编译该项目，得到 **产出2.一个.a文件** ，即是extension.xml中的\n\n\t<nativeLibrary>liblibNtUniSdk4Flash.a</nativeLibrary> \n\t\n## 编译ANE ###\n\n编译ANE的过程简直就是黑魔法。\n\n建立一个platform.xml，写入库依赖连接信息，以iTools SDK为例。\n\n\t<platform xmlns=\"http://ns.adobe.com/air/extension/3.1\">\n    \t<description>An optional description.</description> \n    \t<copyright>2011 (optional)</copyright> \n    \t<sdkVersion>5.0.0</sdkVersion> \n    \t<linkerOptions> \n        \t<option>-ios_version_min 5.0</option>\n        \t<option>-framework AdSupport</option>\n        \t<option>-framework SystemConfiguration</option>\n        \t<option>-framework CFNetwork</option>\n        \t<option>-framework Security</option>\n        \t<option>-framework MobileCoreServices</option>\n        \t<option>-framework QuartzCore</option>\n        \t<option>-framework CoreTelephony</option>\n\n        \t<option>-framework StoreKit</option>\n        \t<option>-framework NtUniSdkiTools</option>\n        \n        \t<option>-lc /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS7.1.sdk/usr/lib/libz.dylib</option>\n    \t</linkerOptions> \n\t</platform>\n\n把产出1的.swc文件，后缀改为.zip，解压，得到catalog.xml和library.swf。\n\n建立一个文件夹，命名为iPhone-ARM，放入三个文件，上一步所得的catalog.xml和library.swf、产出1.的.a文件。\n\n新建一个目录，放入如下：\n\n+ 上文的iPhone-ARM文件夹\n+ 上文的platform.xml\n+ 上文的extension.xml\n+ 产出1.的NtUniSdk4Flash.swc\n+ developer_identity.p12 用于签名的证书，密码为111111 (没有的话，可是用Flash Builder生成，请看后面步骤)\n\n\n用以下指令编译ANE：\n\n\t\"/Applications/Adobe Flash Builder 4.7/sdks/4.6.0/bin/adt\" \\\n\t\t-package -storetype pkcs12 -keystore developer_identity.p12 -storepass 111111 \\\n\t\t-target com.netease.ntunisdk.ios.ane extension.xml -swc NtUniSdk4Flash.swc -platform iPhone-ARM -C iPhone-ARM  -platformoptions platform.xml  .\n\t\t\n然后，你就生成了一个可用的ANE文件。\n\n>没有developer_identity.p12证书\n\n>请新建一个Flex手机工程，在工程上点击右键，选择属性，并选择 Flex构建打包 -> Apple iOS，在右边选择 数字签名 -> 创建，即可创建一个可用的数字签名证书。\n\n\n\n","source":"_posts/Black_Magic_Flash_iOS_ANE.md","raw":"title: 黑魔法之 iOS Flash ANE 打包\ndate: 2014-08-15 02:09:46\ntags: [iOS,SDK,Flash,ANE]\n---\n\nMA6-僵尸 使用Flash Air开发，故iOS SDK需包装一个Flash ANE版本。\n\n用到的环境有：Flash Builder 4.7、Xcode 5.1.1、iOS SDK 7.1\n\n## Flash Flex 项目 ##\n\n在Flash Buildder中建立一个 **Flex手机项目库** ，新建一个.as脚本，实现as的wrapper。\n下面给了个简化的项目示例，注意其中用于实现回调的onStatus和初始化函数NtUniSdk4Flash。\n\n <!-- more --> \n\n\tpackage com.netease.ntunisdk\n\t{\n\t\timport flash.events.EventDispatcher;\n\t\timport flash.events.StatusEvent;\n\t\timport flash.external.ExtensionContext;\n\t\n\t\tpublic class NtUniSdk4Flash extends EventDispatcher\n\t\t{\n\t\t\tprivate static var _instance:NtUniSdk4Flash;\n\t\t\tprivate var extContext:ExtensionContext;\n\t\t\n\t\t\tpublic function ntInit():void\n\t\t\t{\n\t\t\t\textContext.call( \"__NtSdkMgr_ntInit\" );\n\t\t\t}\n\t\t\n\t\t\tpublic static function get instance():NtUniSdk4Flash {\n\t\t\t\tif ( !_instance ) {\n\t\t\t\t\t_instance = new NtUniSdk4Flash( new SingletonEnforcer() );\n\t\t\t\t}\n\t\t\t\treturn _instance;\n\t\t\t}\n\n\t\t\tpublic function dispose():void { \n\t\t\t\textContext.dispose(); \n\t\t\t}\n\t\t\n\t\t\tprivate function onStatus( event:StatusEvent ):void {\n\t\t\t\tdispatchEvent( new SDKNotification(event.code, false, false) );\n\t\t\t}\n\t\t\n\t\t\n\t\t\t/**\n\t\t \t* Constructor. \n\t\t \t*/\t\t\n\t\t\tpublic function NtUniSdk4Flash( enforcer:SingletonEnforcer ) {\n\t\t\t\tsuper();\n\t\t\t\n\t\t\t\textContext = ExtensionContext.createExtensionContext( \"com.netease.ntunisdk.ios.ane\", \"\" );\n\t\t\t\n\t\t\t\tif ( !extContext ) {\n\t\t\t\t\tthrow new Error( \"iOS NtUniSdk native extension is not supported on this platform.\" );\n\t\t\t\t}\n\t\t\t\n\t\t\t\textContext.addEventListener( StatusEvent.STATUS, onStatus );\n\t\t\t}\n\t\t}\n\t}\n\t\n\tclass SingletonEnforcer {\n\t\n\t}\n\t\n\t\n然后需要再建立一个extension.xml，示例再如下：\n\n\t<extension xmlns=\"http://ns.adobe.com/air/extension/3.1\"> \n    \t<id>com.netease.ntunisdk.ios.ane</id> \n    \t<versionNumber>0.0.1</versionNumber> \n    \t<platforms>  \n\t\t\t<platform name=\"iPhone-ARM\"> \n            \t<applicationDeployment> \n                \t<nativeLibrary>liblibNtUniSdk4Flash.a</nativeLibrary> \n                \t<initializer>ExtInitializer</initializer>\n            \t</applicationDeployment>\n        \t</platform>\n    \t</platforms> \n\t</extension>\n\t\n因为我们需要的只是iphone版本的ANE，所以只有iPhone-ARM一个平台。com.netease.ntunisdk.ios.ane和上面as代码中的ExtensionContext.createExtensionContext参数是对应的。\n\n然后，在菜单里，选择 项目 -> 构建项目，编译项目。如果你的构建项目事灰色的，那是打开了自动构建。把 项目 -> 自动构建 取消掉。\n\n这时候，可以等到 **产出1. 一个.swc文件** 。\n\n\n## Xcode 静态库项目 ##\n\n建立一个Coco Touch Static Library, 在Air SDK里找到 FlashRuntimeExtensions.h，添加到项目中。\n\n新建一个.m文件，下面给出项目简化版的示例：\n\n\t//\n\t//  libNtUniSdk4Flash.m\n\t//  libNtUniSdk4Flash\n\t//\n\t//  Created by Huang Quanyong on 14-8-7.\n\t//  Copyright (c) 2014年 Stupid Dumb Kids. All rights reserved.\n\t//\n\n\t#import \"FlashRuntimeExtensions.h\"\n\t#import \"UniHead.h\"\n\n\t#define STRING_BUFFER_SIZE 1024*128\n\n\t@interface __NtNotificationWrapper : NSObject\n\n\t@end\n\tstatic __NtNotificationWrapper *__inst = nil;\n\tstatic FREContext __context = NULL;\n\n\t@implementation __NtNotificationWrapper\n\n\t+ (void) initialize\n\t{\n    \tif (__inst) {\n        \treturn;\n    \t}\n    \n   \t\t__inst = [[__NtNotificationWrapper alloc] init];\n    \n    \t//初始化通知\n    \t[[NSNotificationCenter defaultCenter] addObserver:__inst selector:@selector(finishInitNotification:) name:NT_NOTIFICATION_FINISH_INIT object:nil];\n    \n    }\n\n\t//初始化完成处理\n\t- (void)finishInitNotification:(NSNotification *)notification\n\t{\n   \t\tNSString* str = NT_NOTIFICATION_FINISH_INIT;\n    \tconst uint8_t *code = (const uint8_t*) [str UTF8String];\n    \tFREDispatchStatusEventAsync(__context, code, code);\n    \tNSLog(@\"[NtUniSdk] Notification finishInit.\");\n\t}\n\n\t+ (void) doNothing{}\n\n\t@end\n\n\tFREObject __NtSdkMgr_ntInit(FREContext ctx, void* funcData, uint32_t argc, FREObject argv[])\n\t{\n    \tNSLog(@\"[NtUniSdk] __NtSdkMgr_ntInit\");\n    \t[__NtNotificationWrapper doNothing];\n    \t[NtSdkMgr ntInit];\n    \treturn NULL;\n\t}\n\t\n\t// InitNativeCode()\n\t//\n\t// An InitNativeCode function is necessary in the Android implementation of this extension.\n\t// Therefore, an analogous function is necessary in the iOS implementation to make\n\t// the ActionScript interface identical for all implementations.\n\t// However, the iOS implementation has nothing to do.\n\tFREObject InitNativeCode(FREContext ctx, void* funcData, uint32_t argc, FREObject argv[]) {\n    \n    \tNSLog(@\"Entering InitNativeCode()\");\n    \n    \t// Nothing to do.\n    \n    \tNSLog(@\"Exiting InitNativeCode()\");\n    \n    \treturn NULL;\n\t}\n\n\t// ContextInitializer()\n\t//\n\t// The context initializer is called when the runtime creates the extension context instance.\n\n\tvoid ContextInitializer(void* extData, const uint8_t* ctxType, FREContext ctx, uint32_t* numFunctionsToTest, const FRENamedFunction** functionsToSet) {\n    \n    \tNSLog(@\"Entering ContextInitializer()\");\n    \n    \t__context = ctx;\n    \n    \t*numFunctionsToTest = 22;\n    \tFRENamedFunction* func = (FRENamedFunction*) malloc(sizeof(FRENamedFunction) * *numFunctionsToTest);\n    \t\n    \t//Just for consistency with Android\n    \tfunc[0].name = (const uint8_t*) \"__NtSdkMgr_ntInit\";\n    \tfunc[0].functionData = NULL;\n    \tfunc[0].function = &__NtSdkMgr_ntInit;\n    \n    \t*functionsToSet = func;\n    \n    \tNSLog(@\"Exiting ContextInitializer()\");\n\t}\n\n\t// ContextFinalizer()\n\t//\n\t// The context finalizer is called when the extension's ActionScript code\n\t// calls the ExtensionContext instance's dispose() method.\n\t// If the AIR runtime garbage collector disposes of the ExtensionContext instance, the runtime also calls\n\t// ContextFinalizer().\n\n\tvoid ContextFinalizer(FREContext ctx) {\n    \n   \t \tNSLog(@\"Entering ContextFinalizer()\");\n    \n    \t// Nothing to clean up.\n    \n    \tNSLog(@\"Exiting ContextFinalizer()\");\n    \n    \treturn;\n\t}\n\n\t// ExtInitializer()\n\t//\n\t// The extension initializer is called the first time the ActionScript side of the extension\n\t// calls ExtensionContext.createExtensionContext() for any context.\n\n\tvoid ExtInitializer(void** extDataToSet, FREContextInitializer* ctxInitializerToSet, FREContextFinalizer* ctxFinalizerToSet) {\n    \n    \tNSLog(@\"Entering ExtInitializer()\");\n    \n    \t*extDataToSet = NULL;\n    \t*ctxInitializerToSet = &ContextInitializer;\n    \t*ctxFinalizerToSet = &ContextFinalizer;\n    \n    \tNSLog(@\"Exiting ExtInitializer()\");\n\t}\n\n\t// ExtFinalizer()\n\t//\n\t// The extension finalizer is called when the runtime unloads the extension. However, it is not always called.\n\n\tvoid ExtFinalizer(void* extData) {\n    \n    \tNSLog(@\"Entering ExtFinalizer()\");\n    \n    \t// Nothing to clean up.\n    \n    \tNSLog(@\"Exiting ExtFinalizer()\");\n    \treturn;\n\t}\n\t\n注意中间消息的回调实现，调用FREDispatchStatusEventAsync，会触发as里的onStatus。\n\n编译该项目，得到 **产出2.一个.a文件** ，即是extension.xml中的\n\n\t<nativeLibrary>liblibNtUniSdk4Flash.a</nativeLibrary> \n\t\n## 编译ANE ###\n\n编译ANE的过程简直就是黑魔法。\n\n建立一个platform.xml，写入库依赖连接信息，以iTools SDK为例。\n\n\t<platform xmlns=\"http://ns.adobe.com/air/extension/3.1\">\n    \t<description>An optional description.</description> \n    \t<copyright>2011 (optional)</copyright> \n    \t<sdkVersion>5.0.0</sdkVersion> \n    \t<linkerOptions> \n        \t<option>-ios_version_min 5.0</option>\n        \t<option>-framework AdSupport</option>\n        \t<option>-framework SystemConfiguration</option>\n        \t<option>-framework CFNetwork</option>\n        \t<option>-framework Security</option>\n        \t<option>-framework MobileCoreServices</option>\n        \t<option>-framework QuartzCore</option>\n        \t<option>-framework CoreTelephony</option>\n\n        \t<option>-framework StoreKit</option>\n        \t<option>-framework NtUniSdkiTools</option>\n        \n        \t<option>-lc /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS7.1.sdk/usr/lib/libz.dylib</option>\n    \t</linkerOptions> \n\t</platform>\n\n把产出1的.swc文件，后缀改为.zip，解压，得到catalog.xml和library.swf。\n\n建立一个文件夹，命名为iPhone-ARM，放入三个文件，上一步所得的catalog.xml和library.swf、产出1.的.a文件。\n\n新建一个目录，放入如下：\n\n+ 上文的iPhone-ARM文件夹\n+ 上文的platform.xml\n+ 上文的extension.xml\n+ 产出1.的NtUniSdk4Flash.swc\n+ developer_identity.p12 用于签名的证书，密码为111111 (没有的话，可是用Flash Builder生成，请看后面步骤)\n\n\n用以下指令编译ANE：\n\n\t\"/Applications/Adobe Flash Builder 4.7/sdks/4.6.0/bin/adt\" \\\n\t\t-package -storetype pkcs12 -keystore developer_identity.p12 -storepass 111111 \\\n\t\t-target com.netease.ntunisdk.ios.ane extension.xml -swc NtUniSdk4Flash.swc -platform iPhone-ARM -C iPhone-ARM  -platformoptions platform.xml  .\n\t\t\n然后，你就生成了一个可用的ANE文件。\n\n>没有developer_identity.p12证书\n\n>请新建一个Flex手机工程，在工程上点击右键，选择属性，并选择 Flex构建打包 -> Apple iOS，在右边选择 数字签名 -> 创建，即可创建一个可用的数字签名证书。\n\n\n\n","slug":"Black_Magic_Flash_iOS_ANE","published":1,"updated":"2016-08-07T11:27:12.936Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cirkp6cvm0007h8g60j19ad0x","content":"<p>MA6-僵尸 使用Flash Air开发，故iOS SDK需包装一个Flash ANE版本。</p>\n<p>用到的环境有：Flash Builder 4.7、Xcode 5.1.1、iOS SDK 7.1</p>\n<h2 id=\"Flash-Flex-项目\"><a href=\"#Flash-Flex-项目\" class=\"headerlink\" title=\"Flash Flex 项目\"></a>Flash Flex 项目</h2><p>在Flash Buildder中建立一个 <strong>Flex手机项目库</strong> ，新建一个.as脚本，实现as的wrapper。<br>下面给了个简化的项目示例，注意其中用于实现回调的onStatus和初始化函数NtUniSdk4Flash。</p>\n <a id=\"more\"></a> \n<pre><code>package com.netease.ntunisdk\n{\n    import flash.events.EventDispatcher;\n    import flash.events.StatusEvent;\n    import flash.external.ExtensionContext;\n\n    public class NtUniSdk4Flash extends EventDispatcher\n    {\n        private static var _instance:NtUniSdk4Flash;\n        private var extContext:ExtensionContext;\n\n        public function ntInit():void\n        {\n            extContext.call( &quot;__NtSdkMgr_ntInit&quot; );\n        }\n\n        public static function get instance():NtUniSdk4Flash {\n            if ( !_instance ) {\n                _instance = new NtUniSdk4Flash( new SingletonEnforcer() );\n            }\n            return _instance;\n        }\n\n        public function dispose():void { \n            extContext.dispose(); \n        }\n\n        private function onStatus( event:StatusEvent ):void {\n            dispatchEvent( new SDKNotification(event.code, false, false) );\n        }\n\n\n        /**\n         * Constructor. \n         */        \n        public function NtUniSdk4Flash( enforcer:SingletonEnforcer ) {\n            super();\n\n            extContext = ExtensionContext.createExtensionContext( &quot;com.netease.ntunisdk.ios.ane&quot;, &quot;&quot; );\n\n            if ( !extContext ) {\n                throw new Error( &quot;iOS NtUniSdk native extension is not supported on this platform.&quot; );\n            }\n\n            extContext.addEventListener( StatusEvent.STATUS, onStatus );\n        }\n    }\n}\n\nclass SingletonEnforcer {\n\n}\n</code></pre><p>然后需要再建立一个extension.xml，示例再如下：</p>\n<pre><code>&lt;extension xmlns=&quot;http://ns.adobe.com/air/extension/3.1&quot;&gt; \n    &lt;id&gt;com.netease.ntunisdk.ios.ane&lt;/id&gt; \n    &lt;versionNumber&gt;0.0.1&lt;/versionNumber&gt; \n    &lt;platforms&gt;  \n        &lt;platform name=&quot;iPhone-ARM&quot;&gt; \n            &lt;applicationDeployment&gt; \n                &lt;nativeLibrary&gt;liblibNtUniSdk4Flash.a&lt;/nativeLibrary&gt; \n                &lt;initializer&gt;ExtInitializer&lt;/initializer&gt;\n            &lt;/applicationDeployment&gt;\n        &lt;/platform&gt;\n    &lt;/platforms&gt; \n&lt;/extension&gt;\n</code></pre><p>因为我们需要的只是iphone版本的ANE，所以只有iPhone-ARM一个平台。com.netease.ntunisdk.ios.ane和上面as代码中的ExtensionContext.createExtensionContext参数是对应的。</p>\n<p>然后，在菜单里，选择 项目 -&gt; 构建项目，编译项目。如果你的构建项目事灰色的，那是打开了自动构建。把 项目 -&gt; 自动构建 取消掉。</p>\n<p>这时候，可以等到 <strong>产出1. 一个.swc文件</strong> 。</p>\n<h2 id=\"Xcode-静态库项目\"><a href=\"#Xcode-静态库项目\" class=\"headerlink\" title=\"Xcode 静态库项目\"></a>Xcode 静态库项目</h2><p>建立一个Coco Touch Static Library, 在Air SDK里找到 FlashRuntimeExtensions.h，添加到项目中。</p>\n<p>新建一个.m文件，下面给出项目简化版的示例：</p>\n<pre><code>//\n//  libNtUniSdk4Flash.m\n//  libNtUniSdk4Flash\n//\n//  Created by Huang Quanyong on 14-8-7.\n//  Copyright (c) 2014年 Stupid Dumb Kids. All rights reserved.\n//\n\n#import &quot;FlashRuntimeExtensions.h&quot;\n#import &quot;UniHead.h&quot;\n\n#define STRING_BUFFER_SIZE 1024*128\n\n@interface __NtNotificationWrapper : NSObject\n\n@end\nstatic __NtNotificationWrapper *__inst = nil;\nstatic FREContext __context = NULL;\n\n@implementation __NtNotificationWrapper\n\n+ (void) initialize\n{\n    if (__inst) {\n        return;\n    }\n\n       __inst = [[__NtNotificationWrapper alloc] init];\n\n    //初始化通知\n    [[NSNotificationCenter defaultCenter] addObserver:__inst selector:@selector(finishInitNotification:) name:NT_NOTIFICATION_FINISH_INIT object:nil];\n\n}\n\n//初始化完成处理\n- (void)finishInitNotification:(NSNotification *)notification\n{\n       NSString* str = NT_NOTIFICATION_FINISH_INIT;\n    const uint8_t *code = (const uint8_t*) [str UTF8String];\n    FREDispatchStatusEventAsync(__context, code, code);\n    NSLog(@&quot;[NtUniSdk] Notification finishInit.&quot;);\n}\n\n+ (void) doNothing{}\n\n@end\n\nFREObject __NtSdkMgr_ntInit(FREContext ctx, void* funcData, uint32_t argc, FREObject argv[])\n{\n    NSLog(@&quot;[NtUniSdk] __NtSdkMgr_ntInit&quot;);\n    [__NtNotificationWrapper doNothing];\n    [NtSdkMgr ntInit];\n    return NULL;\n}\n\n// InitNativeCode()\n//\n// An InitNativeCode function is necessary in the Android implementation of this extension.\n// Therefore, an analogous function is necessary in the iOS implementation to make\n// the ActionScript interface identical for all implementations.\n// However, the iOS implementation has nothing to do.\nFREObject InitNativeCode(FREContext ctx, void* funcData, uint32_t argc, FREObject argv[]) {\n\n    NSLog(@&quot;Entering InitNativeCode()&quot;);\n\n    // Nothing to do.\n\n    NSLog(@&quot;Exiting InitNativeCode()&quot;);\n\n    return NULL;\n}\n\n// ContextInitializer()\n//\n// The context initializer is called when the runtime creates the extension context instance.\n\nvoid ContextInitializer(void* extData, const uint8_t* ctxType, FREContext ctx, uint32_t* numFunctionsToTest, const FRENamedFunction** functionsToSet) {\n\n    NSLog(@&quot;Entering ContextInitializer()&quot;);\n\n    __context = ctx;\n\n    *numFunctionsToTest = 22;\n    FRENamedFunction* func = (FRENamedFunction*) malloc(sizeof(FRENamedFunction) * *numFunctionsToTest);\n\n    //Just for consistency with Android\n    func[0].name = (const uint8_t*) &quot;__NtSdkMgr_ntInit&quot;;\n    func[0].functionData = NULL;\n    func[0].function = &amp;__NtSdkMgr_ntInit;\n\n    *functionsToSet = func;\n\n    NSLog(@&quot;Exiting ContextInitializer()&quot;);\n}\n\n// ContextFinalizer()\n//\n// The context finalizer is called when the extension&apos;s ActionScript code\n// calls the ExtensionContext instance&apos;s dispose() method.\n// If the AIR runtime garbage collector disposes of the ExtensionContext instance, the runtime also calls\n// ContextFinalizer().\n\nvoid ContextFinalizer(FREContext ctx) {\n\n        NSLog(@&quot;Entering ContextFinalizer()&quot;);\n\n    // Nothing to clean up.\n\n    NSLog(@&quot;Exiting ContextFinalizer()&quot;);\n\n    return;\n}\n\n// ExtInitializer()\n//\n// The extension initializer is called the first time the ActionScript side of the extension\n// calls ExtensionContext.createExtensionContext() for any context.\n\nvoid ExtInitializer(void** extDataToSet, FREContextInitializer* ctxInitializerToSet, FREContextFinalizer* ctxFinalizerToSet) {\n\n    NSLog(@&quot;Entering ExtInitializer()&quot;);\n\n    *extDataToSet = NULL;\n    *ctxInitializerToSet = &amp;ContextInitializer;\n    *ctxFinalizerToSet = &amp;ContextFinalizer;\n\n    NSLog(@&quot;Exiting ExtInitializer()&quot;);\n}\n\n// ExtFinalizer()\n//\n// The extension finalizer is called when the runtime unloads the extension. However, it is not always called.\n\nvoid ExtFinalizer(void* extData) {\n\n    NSLog(@&quot;Entering ExtFinalizer()&quot;);\n\n    // Nothing to clean up.\n\n    NSLog(@&quot;Exiting ExtFinalizer()&quot;);\n    return;\n}\n</code></pre><p>注意中间消息的回调实现，调用FREDispatchStatusEventAsync，会触发as里的onStatus。</p>\n<p>编译该项目，得到 <strong>产出2.一个.a文件</strong> ，即是extension.xml中的</p>\n<pre><code>&lt;nativeLibrary&gt;liblibNtUniSdk4Flash.a&lt;/nativeLibrary&gt; \n</code></pre><h2 id=\"编译ANE\"><a href=\"#编译ANE\" class=\"headerlink\" title=\"编译ANE\"></a>编译ANE</h2><p>编译ANE的过程简直就是黑魔法。</p>\n<p>建立一个platform.xml，写入库依赖连接信息，以iTools SDK为例。</p>\n<pre><code>&lt;platform xmlns=&quot;http://ns.adobe.com/air/extension/3.1&quot;&gt;\n    &lt;description&gt;An optional description.&lt;/description&gt; \n    &lt;copyright&gt;2011 (optional)&lt;/copyright&gt; \n    &lt;sdkVersion&gt;5.0.0&lt;/sdkVersion&gt; \n    &lt;linkerOptions&gt; \n        &lt;option&gt;-ios_version_min 5.0&lt;/option&gt;\n        &lt;option&gt;-framework AdSupport&lt;/option&gt;\n        &lt;option&gt;-framework SystemConfiguration&lt;/option&gt;\n        &lt;option&gt;-framework CFNetwork&lt;/option&gt;\n        &lt;option&gt;-framework Security&lt;/option&gt;\n        &lt;option&gt;-framework MobileCoreServices&lt;/option&gt;\n        &lt;option&gt;-framework QuartzCore&lt;/option&gt;\n        &lt;option&gt;-framework CoreTelephony&lt;/option&gt;\n\n        &lt;option&gt;-framework StoreKit&lt;/option&gt;\n        &lt;option&gt;-framework NtUniSdkiTools&lt;/option&gt;\n\n        &lt;option&gt;-lc /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS7.1.sdk/usr/lib/libz.dylib&lt;/option&gt;\n    &lt;/linkerOptions&gt; \n&lt;/platform&gt;\n</code></pre><p>把产出1的.swc文件，后缀改为.zip，解压，得到catalog.xml和library.swf。</p>\n<p>建立一个文件夹，命名为iPhone-ARM，放入三个文件，上一步所得的catalog.xml和library.swf、产出1.的.a文件。</p>\n<p>新建一个目录，放入如下：</p>\n<ul>\n<li>上文的iPhone-ARM文件夹</li>\n<li>上文的platform.xml</li>\n<li>上文的extension.xml</li>\n<li>产出1.的NtUniSdk4Flash.swc</li>\n<li>developer_identity.p12 用于签名的证书，密码为111111 (没有的话，可是用Flash Builder生成，请看后面步骤)</li>\n</ul>\n<p>用以下指令编译ANE：</p>\n<pre><code>&quot;/Applications/Adobe Flash Builder 4.7/sdks/4.6.0/bin/adt&quot; \\\n    -package -storetype pkcs12 -keystore developer_identity.p12 -storepass 111111 \\\n    -target com.netease.ntunisdk.ios.ane extension.xml -swc NtUniSdk4Flash.swc -platform iPhone-ARM -C iPhone-ARM  -platformoptions platform.xml  .\n</code></pre><p>然后，你就生成了一个可用的ANE文件。</p>\n<blockquote>\n<p>没有developer_identity.p12证书</p>\n<p>请新建一个Flex手机工程，在工程上点击右键，选择属性，并选择 Flex构建打包 -&gt; Apple iOS，在右边选择 数字签名 -&gt; 创建，即可创建一个可用的数字签名证书。</p>\n</blockquote>\n","excerpt":"<p>MA6-僵尸 使用Flash Air开发，故iOS SDK需包装一个Flash ANE版本。</p>\n<p>用到的环境有：Flash Builder 4.7、Xcode 5.1.1、iOS SDK 7.1</p>\n<h2 id=\"Flash-Flex-项目\"><a href=\"#Flash-Flex-项目\" class=\"headerlink\" title=\"Flash Flex 项目\"></a>Flash Flex 项目</h2><p>在Flash Buildder中建立一个 <strong>Flex手机项目库</strong> ，新建一个.as脚本，实现as的wrapper。<br>下面给了个简化的项目示例，注意其中用于实现回调的onStatus和初始化函数NtUniSdk4Flash。</p>","more":"<pre><code>package com.netease.ntunisdk\n{\n    import flash.events.EventDispatcher;\n    import flash.events.StatusEvent;\n    import flash.external.ExtensionContext;\n\n    public class NtUniSdk4Flash extends EventDispatcher\n    {\n        private static var _instance:NtUniSdk4Flash;\n        private var extContext:ExtensionContext;\n\n        public function ntInit():void\n        {\n            extContext.call( &quot;__NtSdkMgr_ntInit&quot; );\n        }\n\n        public static function get instance():NtUniSdk4Flash {\n            if ( !_instance ) {\n                _instance = new NtUniSdk4Flash( new SingletonEnforcer() );\n            }\n            return _instance;\n        }\n\n        public function dispose():void { \n            extContext.dispose(); \n        }\n\n        private function onStatus( event:StatusEvent ):void {\n            dispatchEvent( new SDKNotification(event.code, false, false) );\n        }\n\n\n        /**\n         * Constructor. \n         */        \n        public function NtUniSdk4Flash( enforcer:SingletonEnforcer ) {\n            super();\n\n            extContext = ExtensionContext.createExtensionContext( &quot;com.netease.ntunisdk.ios.ane&quot;, &quot;&quot; );\n\n            if ( !extContext ) {\n                throw new Error( &quot;iOS NtUniSdk native extension is not supported on this platform.&quot; );\n            }\n\n            extContext.addEventListener( StatusEvent.STATUS, onStatus );\n        }\n    }\n}\n\nclass SingletonEnforcer {\n\n}\n</code></pre><p>然后需要再建立一个extension.xml，示例再如下：</p>\n<pre><code>&lt;extension xmlns=&quot;http://ns.adobe.com/air/extension/3.1&quot;&gt; \n    &lt;id&gt;com.netease.ntunisdk.ios.ane&lt;/id&gt; \n    &lt;versionNumber&gt;0.0.1&lt;/versionNumber&gt; \n    &lt;platforms&gt;  \n        &lt;platform name=&quot;iPhone-ARM&quot;&gt; \n            &lt;applicationDeployment&gt; \n                &lt;nativeLibrary&gt;liblibNtUniSdk4Flash.a&lt;/nativeLibrary&gt; \n                &lt;initializer&gt;ExtInitializer&lt;/initializer&gt;\n            &lt;/applicationDeployment&gt;\n        &lt;/platform&gt;\n    &lt;/platforms&gt; \n&lt;/extension&gt;\n</code></pre><p>因为我们需要的只是iphone版本的ANE，所以只有iPhone-ARM一个平台。com.netease.ntunisdk.ios.ane和上面as代码中的ExtensionContext.createExtensionContext参数是对应的。</p>\n<p>然后，在菜单里，选择 项目 -&gt; 构建项目，编译项目。如果你的构建项目事灰色的，那是打开了自动构建。把 项目 -&gt; 自动构建 取消掉。</p>\n<p>这时候，可以等到 <strong>产出1. 一个.swc文件</strong> 。</p>\n<h2 id=\"Xcode-静态库项目\"><a href=\"#Xcode-静态库项目\" class=\"headerlink\" title=\"Xcode 静态库项目\"></a>Xcode 静态库项目</h2><p>建立一个Coco Touch Static Library, 在Air SDK里找到 FlashRuntimeExtensions.h，添加到项目中。</p>\n<p>新建一个.m文件，下面给出项目简化版的示例：</p>\n<pre><code>//\n//  libNtUniSdk4Flash.m\n//  libNtUniSdk4Flash\n//\n//  Created by Huang Quanyong on 14-8-7.\n//  Copyright (c) 2014年 Stupid Dumb Kids. All rights reserved.\n//\n\n#import &quot;FlashRuntimeExtensions.h&quot;\n#import &quot;UniHead.h&quot;\n\n#define STRING_BUFFER_SIZE 1024*128\n\n@interface __NtNotificationWrapper : NSObject\n\n@end\nstatic __NtNotificationWrapper *__inst = nil;\nstatic FREContext __context = NULL;\n\n@implementation __NtNotificationWrapper\n\n+ (void) initialize\n{\n    if (__inst) {\n        return;\n    }\n\n       __inst = [[__NtNotificationWrapper alloc] init];\n\n    //初始化通知\n    [[NSNotificationCenter defaultCenter] addObserver:__inst selector:@selector(finishInitNotification:) name:NT_NOTIFICATION_FINISH_INIT object:nil];\n\n}\n\n//初始化完成处理\n- (void)finishInitNotification:(NSNotification *)notification\n{\n       NSString* str = NT_NOTIFICATION_FINISH_INIT;\n    const uint8_t *code = (const uint8_t*) [str UTF8String];\n    FREDispatchStatusEventAsync(__context, code, code);\n    NSLog(@&quot;[NtUniSdk] Notification finishInit.&quot;);\n}\n\n+ (void) doNothing{}\n\n@end\n\nFREObject __NtSdkMgr_ntInit(FREContext ctx, void* funcData, uint32_t argc, FREObject argv[])\n{\n    NSLog(@&quot;[NtUniSdk] __NtSdkMgr_ntInit&quot;);\n    [__NtNotificationWrapper doNothing];\n    [NtSdkMgr ntInit];\n    return NULL;\n}\n\n// InitNativeCode()\n//\n// An InitNativeCode function is necessary in the Android implementation of this extension.\n// Therefore, an analogous function is necessary in the iOS implementation to make\n// the ActionScript interface identical for all implementations.\n// However, the iOS implementation has nothing to do.\nFREObject InitNativeCode(FREContext ctx, void* funcData, uint32_t argc, FREObject argv[]) {\n\n    NSLog(@&quot;Entering InitNativeCode()&quot;);\n\n    // Nothing to do.\n\n    NSLog(@&quot;Exiting InitNativeCode()&quot;);\n\n    return NULL;\n}\n\n// ContextInitializer()\n//\n// The context initializer is called when the runtime creates the extension context instance.\n\nvoid ContextInitializer(void* extData, const uint8_t* ctxType, FREContext ctx, uint32_t* numFunctionsToTest, const FRENamedFunction** functionsToSet) {\n\n    NSLog(@&quot;Entering ContextInitializer()&quot;);\n\n    __context = ctx;\n\n    *numFunctionsToTest = 22;\n    FRENamedFunction* func = (FRENamedFunction*) malloc(sizeof(FRENamedFunction) * *numFunctionsToTest);\n\n    //Just for consistency with Android\n    func[0].name = (const uint8_t*) &quot;__NtSdkMgr_ntInit&quot;;\n    func[0].functionData = NULL;\n    func[0].function = &amp;__NtSdkMgr_ntInit;\n\n    *functionsToSet = func;\n\n    NSLog(@&quot;Exiting ContextInitializer()&quot;);\n}\n\n// ContextFinalizer()\n//\n// The context finalizer is called when the extension&apos;s ActionScript code\n// calls the ExtensionContext instance&apos;s dispose() method.\n// If the AIR runtime garbage collector disposes of the ExtensionContext instance, the runtime also calls\n// ContextFinalizer().\n\nvoid ContextFinalizer(FREContext ctx) {\n\n        NSLog(@&quot;Entering ContextFinalizer()&quot;);\n\n    // Nothing to clean up.\n\n    NSLog(@&quot;Exiting ContextFinalizer()&quot;);\n\n    return;\n}\n\n// ExtInitializer()\n//\n// The extension initializer is called the first time the ActionScript side of the extension\n// calls ExtensionContext.createExtensionContext() for any context.\n\nvoid ExtInitializer(void** extDataToSet, FREContextInitializer* ctxInitializerToSet, FREContextFinalizer* ctxFinalizerToSet) {\n\n    NSLog(@&quot;Entering ExtInitializer()&quot;);\n\n    *extDataToSet = NULL;\n    *ctxInitializerToSet = &amp;ContextInitializer;\n    *ctxFinalizerToSet = &amp;ContextFinalizer;\n\n    NSLog(@&quot;Exiting ExtInitializer()&quot;);\n}\n\n// ExtFinalizer()\n//\n// The extension finalizer is called when the runtime unloads the extension. However, it is not always called.\n\nvoid ExtFinalizer(void* extData) {\n\n    NSLog(@&quot;Entering ExtFinalizer()&quot;);\n\n    // Nothing to clean up.\n\n    NSLog(@&quot;Exiting ExtFinalizer()&quot;);\n    return;\n}\n</code></pre><p>注意中间消息的回调实现，调用FREDispatchStatusEventAsync，会触发as里的onStatus。</p>\n<p>编译该项目，得到 <strong>产出2.一个.a文件</strong> ，即是extension.xml中的</p>\n<pre><code>&lt;nativeLibrary&gt;liblibNtUniSdk4Flash.a&lt;/nativeLibrary&gt; \n</code></pre><h2 id=\"编译ANE\"><a href=\"#编译ANE\" class=\"headerlink\" title=\"编译ANE\"></a>编译ANE</h2><p>编译ANE的过程简直就是黑魔法。</p>\n<p>建立一个platform.xml，写入库依赖连接信息，以iTools SDK为例。</p>\n<pre><code>&lt;platform xmlns=&quot;http://ns.adobe.com/air/extension/3.1&quot;&gt;\n    &lt;description&gt;An optional description.&lt;/description&gt; \n    &lt;copyright&gt;2011 (optional)&lt;/copyright&gt; \n    &lt;sdkVersion&gt;5.0.0&lt;/sdkVersion&gt; \n    &lt;linkerOptions&gt; \n        &lt;option&gt;-ios_version_min 5.0&lt;/option&gt;\n        &lt;option&gt;-framework AdSupport&lt;/option&gt;\n        &lt;option&gt;-framework SystemConfiguration&lt;/option&gt;\n        &lt;option&gt;-framework CFNetwork&lt;/option&gt;\n        &lt;option&gt;-framework Security&lt;/option&gt;\n        &lt;option&gt;-framework MobileCoreServices&lt;/option&gt;\n        &lt;option&gt;-framework QuartzCore&lt;/option&gt;\n        &lt;option&gt;-framework CoreTelephony&lt;/option&gt;\n\n        &lt;option&gt;-framework StoreKit&lt;/option&gt;\n        &lt;option&gt;-framework NtUniSdkiTools&lt;/option&gt;\n\n        &lt;option&gt;-lc /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS7.1.sdk/usr/lib/libz.dylib&lt;/option&gt;\n    &lt;/linkerOptions&gt; \n&lt;/platform&gt;\n</code></pre><p>把产出1的.swc文件，后缀改为.zip，解压，得到catalog.xml和library.swf。</p>\n<p>建立一个文件夹，命名为iPhone-ARM，放入三个文件，上一步所得的catalog.xml和library.swf、产出1.的.a文件。</p>\n<p>新建一个目录，放入如下：</p>\n<ul>\n<li>上文的iPhone-ARM文件夹</li>\n<li>上文的platform.xml</li>\n<li>上文的extension.xml</li>\n<li>产出1.的NtUniSdk4Flash.swc</li>\n<li>developer_identity.p12 用于签名的证书，密码为111111 (没有的话，可是用Flash Builder生成，请看后面步骤)</li>\n</ul>\n<p>用以下指令编译ANE：</p>\n<pre><code>&quot;/Applications/Adobe Flash Builder 4.7/sdks/4.6.0/bin/adt&quot; \\\n    -package -storetype pkcs12 -keystore developer_identity.p12 -storepass 111111 \\\n    -target com.netease.ntunisdk.ios.ane extension.xml -swc NtUniSdk4Flash.swc -platform iPhone-ARM -C iPhone-ARM  -platformoptions platform.xml  .\n</code></pre><p>然后，你就生成了一个可用的ANE文件。</p>\n<blockquote>\n<p>没有developer_identity.p12证书</p>\n<p>请新建一个Flex手机工程，在工程上点击右键，选择属性，并选择 Flex构建打包 -&gt; Apple iOS，在右边选择 数字签名 -&gt; 创建，即可创建一个可用的数字签名证书。</p>\n</blockquote>"},{"title":"推荐一个系列视频《Extra Credits》","date":"2014-11-26T16:43:39.000Z","_content":"\n最近中午的午休时间都在看[《Extra Credits》](http://extra-credits.net/)，挺赞的，是一个讨论游戏行业相关话题的系列视频。在此推荐一下。\n\n![Extra Credits](/images/extra_credits.png)\n\n <!-- more --> \n\n这是wikipedia上的介绍。\n\n>Extra Credits is a video lesson series presented by game designer James Portnow, animator/narrator Daniel Floyd, and artists Allison Theus, Elisa \"LeeLee\" Scaldaferri, Scott DeWitt, and Dan Jones. The series of videos discuss issues pertinent to video games and game studies, particularly discussing issues concerning video game development, addressing the legitimacy of video games as art, and creating intellectual discourse on important issues in gaming culture.[1]\n>\n> -- WIKIPEDIA\n\nLinks:\n\n[Official Website](http://extra-credits.net/)\n\n[Extra Credits's channel on YouTube](https://www.youtube.com/user/ExtraCreditz)\n\n[the wikipedia link fo Extra Credits](http://en.wikipedia.org/wiki/Extra_Credits)\n\n\n\n","source":"_posts/Extra_Credits.md","raw":"title: 推荐一个系列视频《Extra Credits》\ndate: 2014-11-27 00:43:39\ntags: [Extra Credits, game, video lesson series]\n---\n\n最近中午的午休时间都在看[《Extra Credits》](http://extra-credits.net/)，挺赞的，是一个讨论游戏行业相关话题的系列视频。在此推荐一下。\n\n![Extra Credits](/images/extra_credits.png)\n\n <!-- more --> \n\n这是wikipedia上的介绍。\n\n>Extra Credits is a video lesson series presented by game designer James Portnow, animator/narrator Daniel Floyd, and artists Allison Theus, Elisa \"LeeLee\" Scaldaferri, Scott DeWitt, and Dan Jones. The series of videos discuss issues pertinent to video games and game studies, particularly discussing issues concerning video game development, addressing the legitimacy of video games as art, and creating intellectual discourse on important issues in gaming culture.[1]\n>\n> -- WIKIPEDIA\n\nLinks:\n\n[Official Website](http://extra-credits.net/)\n\n[Extra Credits's channel on YouTube](https://www.youtube.com/user/ExtraCreditz)\n\n[the wikipedia link fo Extra Credits](http://en.wikipedia.org/wiki/Extra_Credits)\n\n\n\n","slug":"Extra_Credits","published":1,"updated":"2016-08-07T11:27:12.939Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cirkp6cvo0008h8g61dt2g8fj","content":"<p>最近中午的午休时间都在看<a href=\"http://extra-credits.net/\" target=\"_blank\" rel=\"external\">《Extra Credits》</a>，挺赞的，是一个讨论游戏行业相关话题的系列视频。在此推荐一下。</p>\n<p><img src=\"/images/extra_credits.png\" alt=\"Extra Credits\"></p>\n <a id=\"more\"></a> \n<p>这是wikipedia上的介绍。</p>\n<blockquote>\n<p>Extra Credits is a video lesson series presented by game designer James Portnow, animator/narrator Daniel Floyd, and artists Allison Theus, Elisa “LeeLee” Scaldaferri, Scott DeWitt, and Dan Jones. The series of videos discuss issues pertinent to video games and game studies, particularly discussing issues concerning video game development, addressing the legitimacy of video games as art, and creating intellectual discourse on important issues in gaming culture.[1]</p>\n<p>– WIKIPEDIA</p>\n</blockquote>\n<p>Links:</p>\n<p><a href=\"http://extra-credits.net/\" target=\"_blank\" rel=\"external\">Official Website</a></p>\n<p><a href=\"https://www.youtube.com/user/ExtraCreditz\" target=\"_blank\" rel=\"external\">Extra Credits’s channel on YouTube</a></p>\n<p><a href=\"http://en.wikipedia.org/wiki/Extra_Credits\" target=\"_blank\" rel=\"external\">the wikipedia link fo Extra Credits</a></p>\n","excerpt":"<p>最近中午的午休时间都在看<a href=\"http://extra-credits.net/\">《Extra Credits》</a>，挺赞的，是一个讨论游戏行业相关话题的系列视频。在此推荐一下。</p>\n<p><img src=\"/images/extra_credits.png\" alt=\"Extra Credits\"></p>","more":"<p>这是wikipedia上的介绍。</p>\n<blockquote>\n<p>Extra Credits is a video lesson series presented by game designer James Portnow, animator/narrator Daniel Floyd, and artists Allison Theus, Elisa “LeeLee” Scaldaferri, Scott DeWitt, and Dan Jones. The series of videos discuss issues pertinent to video games and game studies, particularly discussing issues concerning video game development, addressing the legitimacy of video games as art, and creating intellectual discourse on important issues in gaming culture.[1]</p>\n<p>– WIKIPEDIA</p>\n</blockquote>\n<p>Links:</p>\n<p><a href=\"http://extra-credits.net/\">Official Website</a></p>\n<p><a href=\"https://www.youtube.com/user/ExtraCreditz\">Extra Credits’s channel on YouTube</a></p>\n<p><a href=\"http://en.wikipedia.org/wiki/Extra_Credits\">the wikipedia link fo Extra Credits</a></p>"},{"title":"U3D iOS SDK Wrapper","date":"2014-08-17T10:47:54.000Z","_content":"\n很多游戏使用U3D引擎，比如《忍者必须死》、《影之刃》... 所以，iOS NtUniSDK需要一个U3D的wrapper。\n\nU3D的C#可以调用外部C接口，故需要为NtUniSDK包装一个C语言层，下面给出简化的项目示例代码。\n\n <!-- more --> \n\n\t#import \"UnityAppController.h\"\n\n\t#import \"UniHead.h\"\n\n\t#pragma mark __NtNotificationWrapper\n\n\t#define GameObject \"Main Camera\"\n\n\t#if defined(__cplusplus)\n\textern \"C\"{\n\t#endif\n    \textern void UnitySendMessage(const char *, const char *, const char *);\n\t#if defined(__cplusplus)\n\t}\n\t#endif\n\n\n\t@interface __NtNotificationWrapper : NSObject\n\t@end\n\t\n\tstatic __NtNotificationWrapper *__inst = nil;\n\n\t@implementation __NtNotificationWrapper\n\n\t+ (void) initialize\n\t{\n    \tif (__inst) {\n        \treturn;\n    \t}\n    \n    \t__inst = [[__NtNotificationWrapper alloc] init];\n    \n    \t//初始化通知\n    \t[[NSNotificationCenter defaultCenter] addObserver:__inst selector:@selector(finishInitNotification:) name:NT_NOTIFICATION_FINISH_INIT object:nil];\n    \n\t}\n\n\n\t//初始化完成处理\n\t- (void)finishInitNotification:(NSNotification *)notification\n\t{\n   \t\tNSLog(@\"[NtUniSdk] Notification finishInit.\");\n    \tUnitySendMessage(GameObject,\"NT_NOTIFICATION_FINISH_INIT\",\"\");\n\t}\n\n\t\n\t+ (void) doNothing{}\n\n\t@end\n\n\n\t#pragma mark - __NtSdkMgr_X\n\n\t#if defined(__cplusplus)\n\textern \"C\"{\n\t#endif\n\n    char* __makeCString(NSString* string)\n    {\n        if (string == nil) {\n            return NULL;\n        }\n        \n        const char* cstring = [string cStringUsingEncoding:NSUTF8StringEncoding];\n        \n        if (NULL == cstring) {\n            return NULL;\n        }\n        char* res = (char*)malloc(strlen(cstring)+1);\n        strcpy(res, cstring);\n        return res;\n    }\n       \n    NSString* __makeNSString(const char* cstring)\n    {\n        if (cstring == NULL) {\n            return nil;\n        }\n            \n        NSString* nsstring = [[NSString alloc] initWithCString:cstring encoding:NSUTF8StringEncoding];\n        \n        return nsstring;\n    }\n        \n    void __NtSdkMgr_ntInit()\n    {\n        [__NtNotificationWrapper doNothing];\n        [NtSdkMgr ntInit];\n    }\n\t\n\t#if defined(__cplusplus)\n\t}\n\t#endif\n\t\n注意上述代码中，对Notification的传递使用了\n\n\textern void UnitySendMessage(const char *, const char *, const char *);\n\n调用GameObject上的回调函数。\n\n回到U3D，新建一个C#文件，实现SDK的C# Wrapper。下面是简化的代码示例：\n\n\n\tusing UnityEngine;\n\n\tusing System;\n\tusing System.Collections;\n\tusing System.Collections.Generic;\n\tusing System.Runtime.InteropServices;\n\tusing System.Text;\n\n\tnamespace NtUniSdk{\n\t\tnamespace Unity3d{ \n\t\t\tpublic class SdkU3d : MonoBehaviour\n\t\t\t{\n\n\t\t\t\tpublic static void ntInit()\n\t\t\t\t{\n\t\t\t\t\t__NtSdkMgr_ntInit();\n\t\t\t\t}\n\n\t\t\t\t[DllImport(\"__Internal\")]\n\t\t\t\tprivate static extern void __NtSdkMgr_ntInit();\n\t\t\t\n\t\t\t};\n\n\t\t}\n\t}\n\n在U3D中即可使用该Wrapper操作SDK。\n\n在U3D中将工程导出为Xcode工程，向Xcode中添加上述完成的C包装层，同时，按文档正常接入NtUniSDK。\n","source":"_posts/U3D_iOS_Wrapper.md","raw":"title: U3D iOS SDK Wrapper\ndate: 2014-08-17 18:47:54\ntags: [U3D,iOS,SDK]\n---\n\n很多游戏使用U3D引擎，比如《忍者必须死》、《影之刃》... 所以，iOS NtUniSDK需要一个U3D的wrapper。\n\nU3D的C#可以调用外部C接口，故需要为NtUniSDK包装一个C语言层，下面给出简化的项目示例代码。\n\n <!-- more --> \n\n\t#import \"UnityAppController.h\"\n\n\t#import \"UniHead.h\"\n\n\t#pragma mark __NtNotificationWrapper\n\n\t#define GameObject \"Main Camera\"\n\n\t#if defined(__cplusplus)\n\textern \"C\"{\n\t#endif\n    \textern void UnitySendMessage(const char *, const char *, const char *);\n\t#if defined(__cplusplus)\n\t}\n\t#endif\n\n\n\t@interface __NtNotificationWrapper : NSObject\n\t@end\n\t\n\tstatic __NtNotificationWrapper *__inst = nil;\n\n\t@implementation __NtNotificationWrapper\n\n\t+ (void) initialize\n\t{\n    \tif (__inst) {\n        \treturn;\n    \t}\n    \n    \t__inst = [[__NtNotificationWrapper alloc] init];\n    \n    \t//初始化通知\n    \t[[NSNotificationCenter defaultCenter] addObserver:__inst selector:@selector(finishInitNotification:) name:NT_NOTIFICATION_FINISH_INIT object:nil];\n    \n\t}\n\n\n\t//初始化完成处理\n\t- (void)finishInitNotification:(NSNotification *)notification\n\t{\n   \t\tNSLog(@\"[NtUniSdk] Notification finishInit.\");\n    \tUnitySendMessage(GameObject,\"NT_NOTIFICATION_FINISH_INIT\",\"\");\n\t}\n\n\t\n\t+ (void) doNothing{}\n\n\t@end\n\n\n\t#pragma mark - __NtSdkMgr_X\n\n\t#if defined(__cplusplus)\n\textern \"C\"{\n\t#endif\n\n    char* __makeCString(NSString* string)\n    {\n        if (string == nil) {\n            return NULL;\n        }\n        \n        const char* cstring = [string cStringUsingEncoding:NSUTF8StringEncoding];\n        \n        if (NULL == cstring) {\n            return NULL;\n        }\n        char* res = (char*)malloc(strlen(cstring)+1);\n        strcpy(res, cstring);\n        return res;\n    }\n       \n    NSString* __makeNSString(const char* cstring)\n    {\n        if (cstring == NULL) {\n            return nil;\n        }\n            \n        NSString* nsstring = [[NSString alloc] initWithCString:cstring encoding:NSUTF8StringEncoding];\n        \n        return nsstring;\n    }\n        \n    void __NtSdkMgr_ntInit()\n    {\n        [__NtNotificationWrapper doNothing];\n        [NtSdkMgr ntInit];\n    }\n\t\n\t#if defined(__cplusplus)\n\t}\n\t#endif\n\t\n注意上述代码中，对Notification的传递使用了\n\n\textern void UnitySendMessage(const char *, const char *, const char *);\n\n调用GameObject上的回调函数。\n\n回到U3D，新建一个C#文件，实现SDK的C# Wrapper。下面是简化的代码示例：\n\n\n\tusing UnityEngine;\n\n\tusing System;\n\tusing System.Collections;\n\tusing System.Collections.Generic;\n\tusing System.Runtime.InteropServices;\n\tusing System.Text;\n\n\tnamespace NtUniSdk{\n\t\tnamespace Unity3d{ \n\t\t\tpublic class SdkU3d : MonoBehaviour\n\t\t\t{\n\n\t\t\t\tpublic static void ntInit()\n\t\t\t\t{\n\t\t\t\t\t__NtSdkMgr_ntInit();\n\t\t\t\t}\n\n\t\t\t\t[DllImport(\"__Internal\")]\n\t\t\t\tprivate static extern void __NtSdkMgr_ntInit();\n\t\t\t\n\t\t\t};\n\n\t\t}\n\t}\n\n在U3D中即可使用该Wrapper操作SDK。\n\n在U3D中将工程导出为Xcode工程，向Xcode中添加上述完成的C包装层，同时，按文档正常接入NtUniSDK。\n","slug":"U3D_iOS_Wrapper","published":1,"updated":"2016-08-07T11:27:12.939Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cirkp6cvp0009h8g61trmlyg8","content":"<p>很多游戏使用U3D引擎，比如《忍者必须死》、《影之刃》… 所以，iOS NtUniSDK需要一个U3D的wrapper。</p>\n<p>U3D的C#可以调用外部C接口，故需要为NtUniSDK包装一个C语言层，下面给出简化的项目示例代码。</p>\n <a id=\"more\"></a> \n<pre><code>#import &quot;UnityAppController.h&quot;\n\n#import &quot;UniHead.h&quot;\n\n#pragma mark __NtNotificationWrapper\n\n#define GameObject &quot;Main Camera&quot;\n\n#if defined(__cplusplus)\nextern &quot;C&quot;{\n#endif\n    extern void UnitySendMessage(const char *, const char *, const char *);\n#if defined(__cplusplus)\n}\n#endif\n\n\n@interface __NtNotificationWrapper : NSObject\n@end\n\nstatic __NtNotificationWrapper *__inst = nil;\n\n@implementation __NtNotificationWrapper\n\n+ (void) initialize\n{\n    if (__inst) {\n        return;\n    }\n\n    __inst = [[__NtNotificationWrapper alloc] init];\n\n    //初始化通知\n    [[NSNotificationCenter defaultCenter] addObserver:__inst selector:@selector(finishInitNotification:) name:NT_NOTIFICATION_FINISH_INIT object:nil];\n\n}\n\n\n//初始化完成处理\n- (void)finishInitNotification:(NSNotification *)notification\n{\n       NSLog(@&quot;[NtUniSdk] Notification finishInit.&quot;);\n    UnitySendMessage(GameObject,&quot;NT_NOTIFICATION_FINISH_INIT&quot;,&quot;&quot;);\n}\n\n\n+ (void) doNothing{}\n\n@end\n\n\n#pragma mark - __NtSdkMgr_X\n\n#if defined(__cplusplus)\nextern &quot;C&quot;{\n#endif\n\nchar* __makeCString(NSString* string)\n{\n    if (string == nil) {\n        return NULL;\n    }\n\n    const char* cstring = [string cStringUsingEncoding:NSUTF8StringEncoding];\n\n    if (NULL == cstring) {\n        return NULL;\n    }\n    char* res = (char*)malloc(strlen(cstring)+1);\n    strcpy(res, cstring);\n    return res;\n}\n\nNSString* __makeNSString(const char* cstring)\n{\n    if (cstring == NULL) {\n        return nil;\n    }\n\n    NSString* nsstring = [[NSString alloc] initWithCString:cstring encoding:NSUTF8StringEncoding];\n\n    return nsstring;\n}\n\nvoid __NtSdkMgr_ntInit()\n{\n    [__NtNotificationWrapper doNothing];\n    [NtSdkMgr ntInit];\n}\n\n#if defined(__cplusplus)\n}\n#endif\n</code></pre><p>注意上述代码中，对Notification的传递使用了</p>\n<pre><code>extern void UnitySendMessage(const char *, const char *, const char *);\n</code></pre><p>调用GameObject上的回调函数。</p>\n<p>回到U3D，新建一个C#文件，实现SDK的C# Wrapper。下面是简化的代码示例：</p>\n<pre><code>using UnityEngine;\n\nusing System;\nusing System.Collections;\nusing System.Collections.Generic;\nusing System.Runtime.InteropServices;\nusing System.Text;\n\nnamespace NtUniSdk{\n    namespace Unity3d{ \n        public class SdkU3d : MonoBehaviour\n        {\n\n            public static void ntInit()\n            {\n                __NtSdkMgr_ntInit();\n            }\n\n            [DllImport(&quot;__Internal&quot;)]\n            private static extern void __NtSdkMgr_ntInit();\n\n        };\n\n    }\n}\n</code></pre><p>在U3D中即可使用该Wrapper操作SDK。</p>\n<p>在U3D中将工程导出为Xcode工程，向Xcode中添加上述完成的C包装层，同时，按文档正常接入NtUniSDK。</p>\n","excerpt":"<p>很多游戏使用U3D引擎，比如《忍者必须死》、《影之刃》… 所以，iOS NtUniSDK需要一个U3D的wrapper。</p>\n<p>U3D的C#可以调用外部C接口，故需要为NtUniSDK包装一个C语言层，下面给出简化的项目示例代码。</p>","more":"<pre><code>#import &quot;UnityAppController.h&quot;\n\n#import &quot;UniHead.h&quot;\n\n#pragma mark __NtNotificationWrapper\n\n#define GameObject &quot;Main Camera&quot;\n\n#if defined(__cplusplus)\nextern &quot;C&quot;{\n#endif\n    extern void UnitySendMessage(const char *, const char *, const char *);\n#if defined(__cplusplus)\n}\n#endif\n\n\n@interface __NtNotificationWrapper : NSObject\n@end\n\nstatic __NtNotificationWrapper *__inst = nil;\n\n@implementation __NtNotificationWrapper\n\n+ (void) initialize\n{\n    if (__inst) {\n        return;\n    }\n\n    __inst = [[__NtNotificationWrapper alloc] init];\n\n    //初始化通知\n    [[NSNotificationCenter defaultCenter] addObserver:__inst selector:@selector(finishInitNotification:) name:NT_NOTIFICATION_FINISH_INIT object:nil];\n\n}\n\n\n//初始化完成处理\n- (void)finishInitNotification:(NSNotification *)notification\n{\n       NSLog(@&quot;[NtUniSdk] Notification finishInit.&quot;);\n    UnitySendMessage(GameObject,&quot;NT_NOTIFICATION_FINISH_INIT&quot;,&quot;&quot;);\n}\n\n\n+ (void) doNothing{}\n\n@end\n\n\n#pragma mark - __NtSdkMgr_X\n\n#if defined(__cplusplus)\nextern &quot;C&quot;{\n#endif\n\nchar* __makeCString(NSString* string)\n{\n    if (string == nil) {\n        return NULL;\n    }\n\n    const char* cstring = [string cStringUsingEncoding:NSUTF8StringEncoding];\n\n    if (NULL == cstring) {\n        return NULL;\n    }\n    char* res = (char*)malloc(strlen(cstring)+1);\n    strcpy(res, cstring);\n    return res;\n}\n\nNSString* __makeNSString(const char* cstring)\n{\n    if (cstring == NULL) {\n        return nil;\n    }\n\n    NSString* nsstring = [[NSString alloc] initWithCString:cstring encoding:NSUTF8StringEncoding];\n\n    return nsstring;\n}\n\nvoid __NtSdkMgr_ntInit()\n{\n    [__NtNotificationWrapper doNothing];\n    [NtSdkMgr ntInit];\n}\n\n#if defined(__cplusplus)\n}\n#endif\n</code></pre><p>注意上述代码中，对Notification的传递使用了</p>\n<pre><code>extern void UnitySendMessage(const char *, const char *, const char *);\n</code></pre><p>调用GameObject上的回调函数。</p>\n<p>回到U3D，新建一个C#文件，实现SDK的C# Wrapper。下面是简化的代码示例：</p>\n<pre><code>using UnityEngine;\n\nusing System;\nusing System.Collections;\nusing System.Collections.Generic;\nusing System.Runtime.InteropServices;\nusing System.Text;\n\nnamespace NtUniSdk{\n    namespace Unity3d{ \n        public class SdkU3d : MonoBehaviour\n        {\n\n            public static void ntInit()\n            {\n                __NtSdkMgr_ntInit();\n            }\n\n            [DllImport(&quot;__Internal&quot;)]\n            private static extern void __NtSdkMgr_ntInit();\n\n        };\n\n    }\n}\n</code></pre><p>在U3D中即可使用该Wrapper操作SDK。</p>\n<p>在U3D中将工程导出为Xcode工程，向Xcode中添加上述完成的C包装层，同时，按文档正常接入NtUniSDK。</p>"},{"title":"入职作业之json数据与lua vlaue转换","date":"2015-01-09T13:56:39.000Z","_content":"\n\n题目任务描述：封装json格式的数据与lua value间的互相转换功能\n\n下载ECMA-404的描述文件，观察json的数据格式。\n\n根据描述，一个json value可以是这些类型: object, array, number, string, true, false, or null。\n\n![value](/images/value.png)\n\n <!-- more --> \n\n下面是描述几种数据类型的图。\n\n![object](/images/object.png)\n\n![array](/images/array.png)\n\n![number](/images/number.png)\n\n![string](/images/string.png)\n\n这些图的描述能力应该等同BNF，所以需要处理的操作大概有：\n\n1. 串联\t\t\t\t\t如，C等于A串联B(C＝AB)，即匹配一个C等同于匹配一个A接着匹配一个B\n2. 并联\t\t\t\t\t如，C等于A并联A(C=A|B)，即匹配一个C等同于匹配一个A或者匹配一个B\n3. 匹配0或1次\t\t\t如，C等于匹配A0或1次(C=A?)，即匹配一个C等同于匹配一个A0或多次，该操作可以由 C=A|\"\" 代替，其中\"\"表示空串。\n4. 匹配0或任意次\t\t如，C等于匹配A0或任意次(C=A*)，即匹配一个C等同于匹配一个A0或任意次\n\n则最简单的，上述的value可以描述成\n\n\tvalue ＝ object | array | number | string | true | false | null\n\t\nobject可以描述成，(引号内表示终结符，括号指示结合顺序)\n\t\n\tobject ＝ \"{\" ((string \":\" value) (\",\" string \":\" value)*)? \"}\"\n\t\n其他就依次类推...\n\t\n---\n\n回来开始写代码：\n\n先定义最简单的匹配函数的格式：\n\n\t -- the matcher function\n\t function matcher(json_str, start)\n\t \t...\n\t \treturn result, value, new_start\n\t end\n\n最简单的匹配函数，接受一个待匹配的字符串和一个起始下标，返回匹配结果（true|false），匹配成功后的返回数据，一个新的起始下标。\n\n定义两个最简单的结果处理函数，一个不处理输入直接返回，另一个直接返回nil，后面会常用到\n\n\t-- result handler\n\tlocal no_h = function(v) return v end\n\tlocal nil_h = function() return nil end\n\n定义一个生成基本匹配函数的生成函数，接受一个lua find的匹配表达式和一个结果处理函数，返回一个匹配函数。\n\n\t-- matcher function generator\n\tlocal generator = function(pattern, handler)\n\n\t  -- the matcher function\n\t  function matcher(json_str, start)\n\t    local _, e = string.find(json_str, \"^\"..pattern, start)\n\n\t    if e then\n\t      return true, handler(string.sub(json_str, start, e)), e+1\n\t    else\n\t      return false, nil, start\n\t    end\n\t    \n\t  end\n\t  \n\t  return matcher\n\tend\n\n根据最开始的描述，需要的操作至少还有：并联、串联、匹配0或一次、匹配0或任意次。\n\n下面是并联多个匹配函数的并联操作，输入一个匹配函数列表和一个结果处理函数，返回一个并联后的匹配函数。\n\n\t-- parallelize matchers\n\tparallelize = function(matchers,handler)\n\t  if handler == nil then\n\t    handler = no_h\n\t  end\n\t  \n\t  -- the paralleized matcher function\n\t  function p_matcher(json_str, start)\n\t    local r,v,s\n\t    \n\t    for i=1,#matchers do\n\t      r,v,s = matchers[i](json_str, start)\n\t      if r then\n\t        if handler == nil_h then return true, nil, s end\n\t        if handler == no_h then return true, v, s end\n\t        return r,handler(v),s\n\t      end\n\t    end\n\t    \n\t    return false,nil,start\n\t  end\n\t  \n\t  return p_matcher\n\tend\n\n下面是串联多个匹配函数的串联操作，输入一个匹配函数列表和一个结果处理函数，返回一个串联后的匹配函数。\n\n\t-- serialize matchers\n\tserialize = function(matchers,handler)\n\t  if handler == nil then\n\t    handler = no_h\n\t  end\n\t  \n\t  -- the serialized matcher function\n\t  function s_matcher(json_str, start)\n\t    local r,v,s = false,nil,start\n\t    local results = {}\n\t    \n\t    for i=1,#matchers do\n\t      r,v,s = matchers[i](json_str, s)\n\t      if r == false then\n\t        return false,nil,start\n\t      end\n\t      table.insert(results,v)\n\t    end\n\t    \n\t    if handler == nil_h then return true, nil, s end\n\t    if handler == no_h then return true, results, s end\n\t    return true,handler(results),s\n\t  end\n\t  \n\t  return s_matcher\n\tend\n\n匹配0或任意次和匹配1或任意次之间存在转换关系，实现中选了1或任意次匹配作为原子操作，0或任意次可以描述为:(\"\"表示空串)\n\n\t0_or_more = one_or_more | \"\"\n\t\n下面是1或任意次匹配操作，接受一个匹配函数和一个结果处理函数，返回一个匹配1次或任意次的匹配函数。\n\n\t-- make a matcher match one or more\n\tone_or_more = function(matcher, handler)\n\t  if handler == nil then\n\t    handler = function(v) return v end\n\t  end\n\t  \n\t  -- the one or more matcher function\n\t  function oom_matcher(json_str, start)\n\t    local r,v,s = false,nil,start\n\t    local results = {}\n\t    \n\t    r,v,s = matcher(json_str, s)\n\t    if r == false then\n\t      return false,nil,s\n\t    end\n\t    table.insert(results,v)\n\t    \n\t    while true do\n\t      r,v,s = matcher(json_str, s)\n\t      if r == false then\n\t        break\n\t      end\n\t      table.insert(results,v)\n\t    end\n\t    \n\t    if handler == nil_h then return true, nil, s end\n\t    if handler == no_h then return true, results, s end\n\t    return true,handler(results),s\n\t  end\n\t  \n\t  return oom_matcher\n\tend\n\n下面定义了一个空串匹配函数，和定义一个0或1次匹配操作函数。\n\n\t-- empty\n\tlocal empty_m = generator(\"\",nil_h)\n\n\t-- or empty helper\n\tlocal or_empty = function(matcher)\n\t  return parallelize{matcher,empty_m}\n\tend\n\t\n定义完这些，就可以开始描述我们的匹配函数了。\n\n\t-- main matchers\n\tlocal null_m, boolean_m, number_m, string_m, object_m, array_m, value_m, value_a\n\nvalue匹配函数的描述，value为number_m,string_m,boolean_m,null_m,object_m,array_m并联。\n\n\t-- value\n\tvalue_m = function(json_str,s)\n\t  -- use value_a to bootup\n\t  if value_a==nil then \n\t    value_a = parallelize{number_m,string_m,boolean_m,null_m,object_m,array_m}\n\t  end\n\t  return value_a(json_str,s)\n\tend\n\t\n这里的value需要使用value_a来协助描述，因为代码最终会出现循环引用，此时number_m,string_m,boolean_m,null_m,object_m,array_m都还没定义，需要在定义好后，才能生成value的匹配函数。\n\n匹配null的函数，使用生成函数生成。\n\n\t-- null\n\tnull_m = generator(\"null\",function() return nil end)\n\n匹配boolean的函数，true和false使用生成函数生成，然后并联true和false匹配函数，生成boolean匹配函数。\n\n\t-- boolean\n\tlocal true_m = generator(\"true\", function() return true end)\n\tlocal false_m = generator(\"false\", function() return false end)\n\tboolean_m = parallelize{true_m,false_m}\n\n匹配number的函数，根据最上面的图，描述为如下：\n\n\t-- number\n\tlocal sign_m = generator(\"[+-]?\",no_h)\n\tlocal minus_or_no_m = generator(\"[-]?\",no_h)\n\tlocal number_no_0_m = generator(\"[1-9]%d*\",no_h)\n\tlocal number_0_m = generator(\"0\",no_h)\n\tlocal dot_number_m = generator(\"%.%d+\",no_h)\n\tlocal e_number_m = generator(\"[eE][+-]?%d+\",no_h)\n\n\tnumber_m = serialize(\n\t  {\n\t    minus_or_no_m,\n\t    parallelize{number_0_m,number_no_0_m},\n\t    or_empty(dot_number_m),\n\t    or_empty(e_number_m)\n\t  },\n\t  function(t) return tonumber(table.concat(t)) end\n\t  )\n\nstring需要处理unicode2utf8编码转换及转义符号。\n\nunicode到utf8转换函数：\n\n\t-- string\n\tlocal function hex2utf8(hex)\n\t  local v, utf8str = 0, \"\"  \n\t  v = tonumber(hex,16)\n\t  if v >= 0x0800 then\n\t    utf8str = string.char(v%0x40+0x80)\n\t    v = math.modf(v/0x40)\n\t    vv = v % 0x40\n\t    utf8str = string.char(vv+0x80) .. utf8str\n\t    v = math.modf(v/0x40)\n\t    utf8str = string.char(v+0xe0) .. utf8str\n\t  elseif v >= 0x0080 then\n\t    utf8str = string.char(v%0x40+0x80)\n\t    v = math.modf(v/0x40)\n\t    utf8str = string.char(v+0xc0) .. utf8str\n\t  else\n\t    utf8str = string.char(v)\n\t  end\n\t  return utf8str\n\tend\n\n匹配引号的函数，使用生成函数生成。\n\n\t-- string\n\tlocal quotation_m = generator(\"\\\"\",nil_h)\n\t\n匹配非\"\\\"字符的函数，生成函数生成。\n\n\tlocal char_m = generator(\"[^\\\"\\\\]+\", no_h)\n\t\n转义表\n\t\n\tlocal escape_char = {\n\t    [\"\\\"\"] = \"\\\"\",\n\t    [\"\\\\\"] = \"\\\\\",\n\t    [\"/\"]  = \"/\",\n\t    [\"b\"]  = \"\\b\",\n\t    [\"f\"]  = \"\\f\",\n\t    [\"n\"]  = \"\\n\",\n\t    [\"r\"]  = \"\\r\",\n\t    [\"t\"]  = \"\\t\",\n\t  }\n\n匹配\"\\\"字符函数。\n\t  \n\tlocal backslash_m = generator(\"\\\\\", nil_h)\n\t\n转义符号匹配和处理函数，注意传入的结果处理函数。\n\n\tlocal escape_char_m = generator(\"[\\\"\\\\/bfnrt]\",function(c) return escape_char[c] end)\n\nunicode匹配和处理函数，注意传入的结果处理函数。\n\n\tlocal unicode_char_m = generator(\"u[0-9a-fA-F][0-9a-fA-F][0-9a-fA-F][0-9a-fA-F]\", function(v) return hex2utf8(string.sub(v,2)) end)\n\nstring的描述\n\n\tstring_m = serialize(\n\t  {\n\t    quotation_m,\n\t    or_empty(\n\t        one_or_more(\n\t          parallelize{\n\t            char_m,\n\t            serialize(\n\t              {\n\t                backslash_m,\n\t                parallelize{escape_char_m,unicode_char_m}\n\t              },\n\t              table.concat\n\t              ),\n\t            },\n\t          table.concat\n\t          )\n\t      ),\n\t    quotation_m\n\t  },\n\t  table.concat\n\t)\n\nobject的描述，各层结果处理函数比较复杂。\n\n\t-- object\n\t-- brace_l\n\tlocal brace_l_m = generator(\"%s*{%s*\",nil_h)\n\tlocal brace_r_m = generator(\"%s*}%s*\",nil_h)\n\tlocal colon_m = generator(\"%s*:%s*\",nil_h)\n\tlocal comma_m = generator(\"%s*,%s*\",nil_h)\n\n\tlocal object_item_m = serialize{string_m,colon_m,value_m}\n\n\tobject_m = serialize(\n\t  {\n\t    brace_l_m,\n\t    or_empty(\n\t      serialize(\n\t        {\n\t          object_item_m,\n\t          or_empty(\n\t            one_or_more(\n\t              serialize(\n\t                {comma_m,object_item_m},\n\t                function(t) return t[1] end\n\t              )\n\t            )\n\t          )\n\t        },\n\t        function(t)\n\t          if t[2] then\n\t            table.insert(t[2],t[1])\n\t            return t[2]\n\t          else\n\t            return {t[1]}\n\t          end\n\t        end\n\t      )\n\t    ),\n\t    brace_r_m\n\t  },\n\t  function(t)\n\t    local o = {}\n\t        \n\t    if t[1] then\n\t      for k,v in pairs(t[1]) do\n\t        o[v[1]] = v[2]\n\t      end\n\t    end\n\t    \n\t    return o\n\t  end\n\t)\n\narray的描述，array需要保持一个状态index，如果直接用基本操作描述，传入的结果处理函数会比较蛋疼，所以用函数实现了。\n\n\t-- arrary\n\tlocal bracket_l_m = generator(\"%s*%[%s*\",nil_h)\n\tlocal bracket_r_m = generator(\"%s*%]%s*\",nil_h)\n\n\tarray_m = function(json_str, start)\n\n\t  local array,index = {}, 1\n\t  local add_item = function(v) array[index] = v[1]; index=index+1 end \n\t  local array_item_m = serialize({value_m},add_item)\n\t  \n\t  local array_a = serialize{\n\t      bracket_l_m,\n\t      or_empty(\n\t        serialize{\n\t            array_item_m,\n\t            or_empty(\n\t              one_or_more(serialize{comma_m,array_item_m})\n\t                )\n\t              }\n\t          ),\n\t      bracket_r_m\n\t    }\n\t  \n\t  local r,v,s = array_a(json_str,start)\n\t  return r,array,s\n\tend\n\n最后，匹配函数\n\n\tlocal function Marshal(json_str)\n\t  local result,value,start = value_m(json_str,1)\n\t  if result --and start == #json_str+1 \n\t  then\n\t    return value \n\t  else\n\t    return nil, \"error_type\"\n\t  end\n\tend\n\nlua table 反解析成 json string 的比较直观，对每一种lua value类型写一个转换函数即可，此处不冗述。\n\n\n\n","source":"_posts/Homework_Lua.md","raw":"title: 入职作业之json数据与lua vlaue转换\ndate: 2015-01-09 21:56:39\ntags: [lua,json,parser]\n---\n\n\n题目任务描述：封装json格式的数据与lua value间的互相转换功能\n\n下载ECMA-404的描述文件，观察json的数据格式。\n\n根据描述，一个json value可以是这些类型: object, array, number, string, true, false, or null。\n\n![value](/images/value.png)\n\n <!-- more --> \n\n下面是描述几种数据类型的图。\n\n![object](/images/object.png)\n\n![array](/images/array.png)\n\n![number](/images/number.png)\n\n![string](/images/string.png)\n\n这些图的描述能力应该等同BNF，所以需要处理的操作大概有：\n\n1. 串联\t\t\t\t\t如，C等于A串联B(C＝AB)，即匹配一个C等同于匹配一个A接着匹配一个B\n2. 并联\t\t\t\t\t如，C等于A并联A(C=A|B)，即匹配一个C等同于匹配一个A或者匹配一个B\n3. 匹配0或1次\t\t\t如，C等于匹配A0或1次(C=A?)，即匹配一个C等同于匹配一个A0或多次，该操作可以由 C=A|\"\" 代替，其中\"\"表示空串。\n4. 匹配0或任意次\t\t如，C等于匹配A0或任意次(C=A*)，即匹配一个C等同于匹配一个A0或任意次\n\n则最简单的，上述的value可以描述成\n\n\tvalue ＝ object | array | number | string | true | false | null\n\t\nobject可以描述成，(引号内表示终结符，括号指示结合顺序)\n\t\n\tobject ＝ \"{\" ((string \":\" value) (\",\" string \":\" value)*)? \"}\"\n\t\n其他就依次类推...\n\t\n---\n\n回来开始写代码：\n\n先定义最简单的匹配函数的格式：\n\n\t -- the matcher function\n\t function matcher(json_str, start)\n\t \t...\n\t \treturn result, value, new_start\n\t end\n\n最简单的匹配函数，接受一个待匹配的字符串和一个起始下标，返回匹配结果（true|false），匹配成功后的返回数据，一个新的起始下标。\n\n定义两个最简单的结果处理函数，一个不处理输入直接返回，另一个直接返回nil，后面会常用到\n\n\t-- result handler\n\tlocal no_h = function(v) return v end\n\tlocal nil_h = function() return nil end\n\n定义一个生成基本匹配函数的生成函数，接受一个lua find的匹配表达式和一个结果处理函数，返回一个匹配函数。\n\n\t-- matcher function generator\n\tlocal generator = function(pattern, handler)\n\n\t  -- the matcher function\n\t  function matcher(json_str, start)\n\t    local _, e = string.find(json_str, \"^\"..pattern, start)\n\n\t    if e then\n\t      return true, handler(string.sub(json_str, start, e)), e+1\n\t    else\n\t      return false, nil, start\n\t    end\n\t    \n\t  end\n\t  \n\t  return matcher\n\tend\n\n根据最开始的描述，需要的操作至少还有：并联、串联、匹配0或一次、匹配0或任意次。\n\n下面是并联多个匹配函数的并联操作，输入一个匹配函数列表和一个结果处理函数，返回一个并联后的匹配函数。\n\n\t-- parallelize matchers\n\tparallelize = function(matchers,handler)\n\t  if handler == nil then\n\t    handler = no_h\n\t  end\n\t  \n\t  -- the paralleized matcher function\n\t  function p_matcher(json_str, start)\n\t    local r,v,s\n\t    \n\t    for i=1,#matchers do\n\t      r,v,s = matchers[i](json_str, start)\n\t      if r then\n\t        if handler == nil_h then return true, nil, s end\n\t        if handler == no_h then return true, v, s end\n\t        return r,handler(v),s\n\t      end\n\t    end\n\t    \n\t    return false,nil,start\n\t  end\n\t  \n\t  return p_matcher\n\tend\n\n下面是串联多个匹配函数的串联操作，输入一个匹配函数列表和一个结果处理函数，返回一个串联后的匹配函数。\n\n\t-- serialize matchers\n\tserialize = function(matchers,handler)\n\t  if handler == nil then\n\t    handler = no_h\n\t  end\n\t  \n\t  -- the serialized matcher function\n\t  function s_matcher(json_str, start)\n\t    local r,v,s = false,nil,start\n\t    local results = {}\n\t    \n\t    for i=1,#matchers do\n\t      r,v,s = matchers[i](json_str, s)\n\t      if r == false then\n\t        return false,nil,start\n\t      end\n\t      table.insert(results,v)\n\t    end\n\t    \n\t    if handler == nil_h then return true, nil, s end\n\t    if handler == no_h then return true, results, s end\n\t    return true,handler(results),s\n\t  end\n\t  \n\t  return s_matcher\n\tend\n\n匹配0或任意次和匹配1或任意次之间存在转换关系，实现中选了1或任意次匹配作为原子操作，0或任意次可以描述为:(\"\"表示空串)\n\n\t0_or_more = one_or_more | \"\"\n\t\n下面是1或任意次匹配操作，接受一个匹配函数和一个结果处理函数，返回一个匹配1次或任意次的匹配函数。\n\n\t-- make a matcher match one or more\n\tone_or_more = function(matcher, handler)\n\t  if handler == nil then\n\t    handler = function(v) return v end\n\t  end\n\t  \n\t  -- the one or more matcher function\n\t  function oom_matcher(json_str, start)\n\t    local r,v,s = false,nil,start\n\t    local results = {}\n\t    \n\t    r,v,s = matcher(json_str, s)\n\t    if r == false then\n\t      return false,nil,s\n\t    end\n\t    table.insert(results,v)\n\t    \n\t    while true do\n\t      r,v,s = matcher(json_str, s)\n\t      if r == false then\n\t        break\n\t      end\n\t      table.insert(results,v)\n\t    end\n\t    \n\t    if handler == nil_h then return true, nil, s end\n\t    if handler == no_h then return true, results, s end\n\t    return true,handler(results),s\n\t  end\n\t  \n\t  return oom_matcher\n\tend\n\n下面定义了一个空串匹配函数，和定义一个0或1次匹配操作函数。\n\n\t-- empty\n\tlocal empty_m = generator(\"\",nil_h)\n\n\t-- or empty helper\n\tlocal or_empty = function(matcher)\n\t  return parallelize{matcher,empty_m}\n\tend\n\t\n定义完这些，就可以开始描述我们的匹配函数了。\n\n\t-- main matchers\n\tlocal null_m, boolean_m, number_m, string_m, object_m, array_m, value_m, value_a\n\nvalue匹配函数的描述，value为number_m,string_m,boolean_m,null_m,object_m,array_m并联。\n\n\t-- value\n\tvalue_m = function(json_str,s)\n\t  -- use value_a to bootup\n\t  if value_a==nil then \n\t    value_a = parallelize{number_m,string_m,boolean_m,null_m,object_m,array_m}\n\t  end\n\t  return value_a(json_str,s)\n\tend\n\t\n这里的value需要使用value_a来协助描述，因为代码最终会出现循环引用，此时number_m,string_m,boolean_m,null_m,object_m,array_m都还没定义，需要在定义好后，才能生成value的匹配函数。\n\n匹配null的函数，使用生成函数生成。\n\n\t-- null\n\tnull_m = generator(\"null\",function() return nil end)\n\n匹配boolean的函数，true和false使用生成函数生成，然后并联true和false匹配函数，生成boolean匹配函数。\n\n\t-- boolean\n\tlocal true_m = generator(\"true\", function() return true end)\n\tlocal false_m = generator(\"false\", function() return false end)\n\tboolean_m = parallelize{true_m,false_m}\n\n匹配number的函数，根据最上面的图，描述为如下：\n\n\t-- number\n\tlocal sign_m = generator(\"[+-]?\",no_h)\n\tlocal minus_or_no_m = generator(\"[-]?\",no_h)\n\tlocal number_no_0_m = generator(\"[1-9]%d*\",no_h)\n\tlocal number_0_m = generator(\"0\",no_h)\n\tlocal dot_number_m = generator(\"%.%d+\",no_h)\n\tlocal e_number_m = generator(\"[eE][+-]?%d+\",no_h)\n\n\tnumber_m = serialize(\n\t  {\n\t    minus_or_no_m,\n\t    parallelize{number_0_m,number_no_0_m},\n\t    or_empty(dot_number_m),\n\t    or_empty(e_number_m)\n\t  },\n\t  function(t) return tonumber(table.concat(t)) end\n\t  )\n\nstring需要处理unicode2utf8编码转换及转义符号。\n\nunicode到utf8转换函数：\n\n\t-- string\n\tlocal function hex2utf8(hex)\n\t  local v, utf8str = 0, \"\"  \n\t  v = tonumber(hex,16)\n\t  if v >= 0x0800 then\n\t    utf8str = string.char(v%0x40+0x80)\n\t    v = math.modf(v/0x40)\n\t    vv = v % 0x40\n\t    utf8str = string.char(vv+0x80) .. utf8str\n\t    v = math.modf(v/0x40)\n\t    utf8str = string.char(v+0xe0) .. utf8str\n\t  elseif v >= 0x0080 then\n\t    utf8str = string.char(v%0x40+0x80)\n\t    v = math.modf(v/0x40)\n\t    utf8str = string.char(v+0xc0) .. utf8str\n\t  else\n\t    utf8str = string.char(v)\n\t  end\n\t  return utf8str\n\tend\n\n匹配引号的函数，使用生成函数生成。\n\n\t-- string\n\tlocal quotation_m = generator(\"\\\"\",nil_h)\n\t\n匹配非\"\\\"字符的函数，生成函数生成。\n\n\tlocal char_m = generator(\"[^\\\"\\\\]+\", no_h)\n\t\n转义表\n\t\n\tlocal escape_char = {\n\t    [\"\\\"\"] = \"\\\"\",\n\t    [\"\\\\\"] = \"\\\\\",\n\t    [\"/\"]  = \"/\",\n\t    [\"b\"]  = \"\\b\",\n\t    [\"f\"]  = \"\\f\",\n\t    [\"n\"]  = \"\\n\",\n\t    [\"r\"]  = \"\\r\",\n\t    [\"t\"]  = \"\\t\",\n\t  }\n\n匹配\"\\\"字符函数。\n\t  \n\tlocal backslash_m = generator(\"\\\\\", nil_h)\n\t\n转义符号匹配和处理函数，注意传入的结果处理函数。\n\n\tlocal escape_char_m = generator(\"[\\\"\\\\/bfnrt]\",function(c) return escape_char[c] end)\n\nunicode匹配和处理函数，注意传入的结果处理函数。\n\n\tlocal unicode_char_m = generator(\"u[0-9a-fA-F][0-9a-fA-F][0-9a-fA-F][0-9a-fA-F]\", function(v) return hex2utf8(string.sub(v,2)) end)\n\nstring的描述\n\n\tstring_m = serialize(\n\t  {\n\t    quotation_m,\n\t    or_empty(\n\t        one_or_more(\n\t          parallelize{\n\t            char_m,\n\t            serialize(\n\t              {\n\t                backslash_m,\n\t                parallelize{escape_char_m,unicode_char_m}\n\t              },\n\t              table.concat\n\t              ),\n\t            },\n\t          table.concat\n\t          )\n\t      ),\n\t    quotation_m\n\t  },\n\t  table.concat\n\t)\n\nobject的描述，各层结果处理函数比较复杂。\n\n\t-- object\n\t-- brace_l\n\tlocal brace_l_m = generator(\"%s*{%s*\",nil_h)\n\tlocal brace_r_m = generator(\"%s*}%s*\",nil_h)\n\tlocal colon_m = generator(\"%s*:%s*\",nil_h)\n\tlocal comma_m = generator(\"%s*,%s*\",nil_h)\n\n\tlocal object_item_m = serialize{string_m,colon_m,value_m}\n\n\tobject_m = serialize(\n\t  {\n\t    brace_l_m,\n\t    or_empty(\n\t      serialize(\n\t        {\n\t          object_item_m,\n\t          or_empty(\n\t            one_or_more(\n\t              serialize(\n\t                {comma_m,object_item_m},\n\t                function(t) return t[1] end\n\t              )\n\t            )\n\t          )\n\t        },\n\t        function(t)\n\t          if t[2] then\n\t            table.insert(t[2],t[1])\n\t            return t[2]\n\t          else\n\t            return {t[1]}\n\t          end\n\t        end\n\t      )\n\t    ),\n\t    brace_r_m\n\t  },\n\t  function(t)\n\t    local o = {}\n\t        \n\t    if t[1] then\n\t      for k,v in pairs(t[1]) do\n\t        o[v[1]] = v[2]\n\t      end\n\t    end\n\t    \n\t    return o\n\t  end\n\t)\n\narray的描述，array需要保持一个状态index，如果直接用基本操作描述，传入的结果处理函数会比较蛋疼，所以用函数实现了。\n\n\t-- arrary\n\tlocal bracket_l_m = generator(\"%s*%[%s*\",nil_h)\n\tlocal bracket_r_m = generator(\"%s*%]%s*\",nil_h)\n\n\tarray_m = function(json_str, start)\n\n\t  local array,index = {}, 1\n\t  local add_item = function(v) array[index] = v[1]; index=index+1 end \n\t  local array_item_m = serialize({value_m},add_item)\n\t  \n\t  local array_a = serialize{\n\t      bracket_l_m,\n\t      or_empty(\n\t        serialize{\n\t            array_item_m,\n\t            or_empty(\n\t              one_or_more(serialize{comma_m,array_item_m})\n\t                )\n\t              }\n\t          ),\n\t      bracket_r_m\n\t    }\n\t  \n\t  local r,v,s = array_a(json_str,start)\n\t  return r,array,s\n\tend\n\n最后，匹配函数\n\n\tlocal function Marshal(json_str)\n\t  local result,value,start = value_m(json_str,1)\n\t  if result --and start == #json_str+1 \n\t  then\n\t    return value \n\t  else\n\t    return nil, \"error_type\"\n\t  end\n\tend\n\nlua table 反解析成 json string 的比较直观，对每一种lua value类型写一个转换函数即可，此处不冗述。\n\n\n\n","slug":"Homework_Lua","published":1,"updated":"2016-08-07T11:27:12.943Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cirkp6cvr000bh8g6hj61jn5z","content":"<p>题目任务描述：封装json格式的数据与lua value间的互相转换功能</p>\n<p>下载ECMA-404的描述文件，观察json的数据格式。</p>\n<p>根据描述，一个json value可以是这些类型: object, array, number, string, true, false, or null。</p>\n<p><img src=\"/images/value.png\" alt=\"value\"></p>\n <a id=\"more\"></a> \n<p>下面是描述几种数据类型的图。</p>\n<p><img src=\"/images/object.png\" alt=\"object\"></p>\n<p><img src=\"/images/array.png\" alt=\"array\"></p>\n<p><img src=\"/images/number.png\" alt=\"number\"></p>\n<p><img src=\"/images/string.png\" alt=\"string\"></p>\n<p>这些图的描述能力应该等同BNF，所以需要处理的操作大概有：</p>\n<ol>\n<li>串联                    如，C等于A串联B(C＝AB)，即匹配一个C等同于匹配一个A接着匹配一个B</li>\n<li>并联                    如，C等于A并联A(C=A|B)，即匹配一个C等同于匹配一个A或者匹配一个B</li>\n<li>匹配0或1次            如，C等于匹配A0或1次(C=A?)，即匹配一个C等同于匹配一个A0或多次，该操作可以由 C=A|”” 代替，其中””表示空串。</li>\n<li>匹配0或任意次        如，C等于匹配A0或任意次(C=A*)，即匹配一个C等同于匹配一个A0或任意次</li>\n</ol>\n<p>则最简单的，上述的value可以描述成</p>\n<pre><code>value ＝ object | array | number | string | true | false | null\n</code></pre><p>object可以描述成，(引号内表示终结符，括号指示结合顺序)</p>\n<pre><code>object ＝ &quot;{&quot; ((string &quot;:&quot; value) (&quot;,&quot; string &quot;:&quot; value)*)? &quot;}&quot;\n</code></pre><p>其他就依次类推…</p>\n<hr>\n<p>回来开始写代码：</p>\n<p>先定义最简单的匹配函数的格式：</p>\n<pre><code>-- the matcher function\nfunction matcher(json_str, start)\n    ...\n    return result, value, new_start\nend\n</code></pre><p>最简单的匹配函数，接受一个待匹配的字符串和一个起始下标，返回匹配结果（true|false），匹配成功后的返回数据，一个新的起始下标。</p>\n<p>定义两个最简单的结果处理函数，一个不处理输入直接返回，另一个直接返回nil，后面会常用到</p>\n<pre><code>-- result handler\nlocal no_h = function(v) return v end\nlocal nil_h = function() return nil end\n</code></pre><p>定义一个生成基本匹配函数的生成函数，接受一个lua find的匹配表达式和一个结果处理函数，返回一个匹配函数。</p>\n<pre><code>-- matcher function generator\nlocal generator = function(pattern, handler)\n\n  -- the matcher function\n  function matcher(json_str, start)\n    local _, e = string.find(json_str, &quot;^&quot;..pattern, start)\n\n    if e then\n      return true, handler(string.sub(json_str, start, e)), e+1\n    else\n      return false, nil, start\n    end\n\n  end\n\n  return matcher\nend\n</code></pre><p>根据最开始的描述，需要的操作至少还有：并联、串联、匹配0或一次、匹配0或任意次。</p>\n<p>下面是并联多个匹配函数的并联操作，输入一个匹配函数列表和一个结果处理函数，返回一个并联后的匹配函数。</p>\n<pre><code>-- parallelize matchers\nparallelize = function(matchers,handler)\n  if handler == nil then\n    handler = no_h\n  end\n\n  -- the paralleized matcher function\n  function p_matcher(json_str, start)\n    local r,v,s\n\n    for i=1,#matchers do\n      r,v,s = matchers[i](json_str, start)\n      if r then\n        if handler == nil_h then return true, nil, s end\n        if handler == no_h then return true, v, s end\n        return r,handler(v),s\n      end\n    end\n\n    return false,nil,start\n  end\n\n  return p_matcher\nend\n</code></pre><p>下面是串联多个匹配函数的串联操作，输入一个匹配函数列表和一个结果处理函数，返回一个串联后的匹配函数。</p>\n<pre><code>-- serialize matchers\nserialize = function(matchers,handler)\n  if handler == nil then\n    handler = no_h\n  end\n\n  -- the serialized matcher function\n  function s_matcher(json_str, start)\n    local r,v,s = false,nil,start\n    local results = {}\n\n    for i=1,#matchers do\n      r,v,s = matchers[i](json_str, s)\n      if r == false then\n        return false,nil,start\n      end\n      table.insert(results,v)\n    end\n\n    if handler == nil_h then return true, nil, s end\n    if handler == no_h then return true, results, s end\n    return true,handler(results),s\n  end\n\n  return s_matcher\nend\n</code></pre><p>匹配0或任意次和匹配1或任意次之间存在转换关系，实现中选了1或任意次匹配作为原子操作，0或任意次可以描述为:(“”表示空串)</p>\n<pre><code>0_or_more = one_or_more | &quot;&quot;\n</code></pre><p>下面是1或任意次匹配操作，接受一个匹配函数和一个结果处理函数，返回一个匹配1次或任意次的匹配函数。</p>\n<pre><code>-- make a matcher match one or more\none_or_more = function(matcher, handler)\n  if handler == nil then\n    handler = function(v) return v end\n  end\n\n  -- the one or more matcher function\n  function oom_matcher(json_str, start)\n    local r,v,s = false,nil,start\n    local results = {}\n\n    r,v,s = matcher(json_str, s)\n    if r == false then\n      return false,nil,s\n    end\n    table.insert(results,v)\n\n    while true do\n      r,v,s = matcher(json_str, s)\n      if r == false then\n        break\n      end\n      table.insert(results,v)\n    end\n\n    if handler == nil_h then return true, nil, s end\n    if handler == no_h then return true, results, s end\n    return true,handler(results),s\n  end\n\n  return oom_matcher\nend\n</code></pre><p>下面定义了一个空串匹配函数，和定义一个0或1次匹配操作函数。</p>\n<pre><code>-- empty\nlocal empty_m = generator(&quot;&quot;,nil_h)\n\n-- or empty helper\nlocal or_empty = function(matcher)\n  return parallelize{matcher,empty_m}\nend\n</code></pre><p>定义完这些，就可以开始描述我们的匹配函数了。</p>\n<pre><code>-- main matchers\nlocal null_m, boolean_m, number_m, string_m, object_m, array_m, value_m, value_a\n</code></pre><p>value匹配函数的描述，value为number_m,string_m,boolean_m,null_m,object_m,array_m并联。</p>\n<pre><code>-- value\nvalue_m = function(json_str,s)\n  -- use value_a to bootup\n  if value_a==nil then \n    value_a = parallelize{number_m,string_m,boolean_m,null_m,object_m,array_m}\n  end\n  return value_a(json_str,s)\nend\n</code></pre><p>这里的value需要使用value_a来协助描述，因为代码最终会出现循环引用，此时number_m,string_m,boolean_m,null_m,object_m,array_m都还没定义，需要在定义好后，才能生成value的匹配函数。</p>\n<p>匹配null的函数，使用生成函数生成。</p>\n<pre><code>-- null\nnull_m = generator(&quot;null&quot;,function() return nil end)\n</code></pre><p>匹配boolean的函数，true和false使用生成函数生成，然后并联true和false匹配函数，生成boolean匹配函数。</p>\n<pre><code>-- boolean\nlocal true_m = generator(&quot;true&quot;, function() return true end)\nlocal false_m = generator(&quot;false&quot;, function() return false end)\nboolean_m = parallelize{true_m,false_m}\n</code></pre><p>匹配number的函数，根据最上面的图，描述为如下：</p>\n<pre><code>-- number\nlocal sign_m = generator(&quot;[+-]?&quot;,no_h)\nlocal minus_or_no_m = generator(&quot;[-]?&quot;,no_h)\nlocal number_no_0_m = generator(&quot;[1-9]%d*&quot;,no_h)\nlocal number_0_m = generator(&quot;0&quot;,no_h)\nlocal dot_number_m = generator(&quot;%.%d+&quot;,no_h)\nlocal e_number_m = generator(&quot;[eE][+-]?%d+&quot;,no_h)\n\nnumber_m = serialize(\n  {\n    minus_or_no_m,\n    parallelize{number_0_m,number_no_0_m},\n    or_empty(dot_number_m),\n    or_empty(e_number_m)\n  },\n  function(t) return tonumber(table.concat(t)) end\n  )\n</code></pre><p>string需要处理unicode2utf8编码转换及转义符号。</p>\n<p>unicode到utf8转换函数：</p>\n<pre><code>-- string\nlocal function hex2utf8(hex)\n  local v, utf8str = 0, &quot;&quot;  \n  v = tonumber(hex,16)\n  if v &gt;= 0x0800 then\n    utf8str = string.char(v%0x40+0x80)\n    v = math.modf(v/0x40)\n    vv = v % 0x40\n    utf8str = string.char(vv+0x80) .. utf8str\n    v = math.modf(v/0x40)\n    utf8str = string.char(v+0xe0) .. utf8str\n  elseif v &gt;= 0x0080 then\n    utf8str = string.char(v%0x40+0x80)\n    v = math.modf(v/0x40)\n    utf8str = string.char(v+0xc0) .. utf8str\n  else\n    utf8str = string.char(v)\n  end\n  return utf8str\nend\n</code></pre><p>匹配引号的函数，使用生成函数生成。</p>\n<pre><code>-- string\nlocal quotation_m = generator(&quot;\\&quot;&quot;,nil_h)\n</code></pre><p>匹配非”\\”字符的函数，生成函数生成。</p>\n<pre><code>local char_m = generator(&quot;[^\\&quot;\\\\]+&quot;, no_h)\n</code></pre><p>转义表</p>\n<pre><code>local escape_char = {\n    [&quot;\\&quot;&quot;] = &quot;\\&quot;&quot;,\n    [&quot;\\\\&quot;] = &quot;\\\\&quot;,\n    [&quot;/&quot;]  = &quot;/&quot;,\n    [&quot;b&quot;]  = &quot;\\b&quot;,\n    [&quot;f&quot;]  = &quot;\\f&quot;,\n    [&quot;n&quot;]  = &quot;\\n&quot;,\n    [&quot;r&quot;]  = &quot;\\r&quot;,\n    [&quot;t&quot;]  = &quot;\\t&quot;,\n  }\n</code></pre><p>匹配”\\”字符函数。</p>\n<pre><code>local backslash_m = generator(&quot;\\\\&quot;, nil_h)\n</code></pre><p>转义符号匹配和处理函数，注意传入的结果处理函数。</p>\n<pre><code>local escape_char_m = generator(&quot;[\\&quot;\\\\/bfnrt]&quot;,function(c) return escape_char[c] end)\n</code></pre><p>unicode匹配和处理函数，注意传入的结果处理函数。</p>\n<pre><code>local unicode_char_m = generator(&quot;u[0-9a-fA-F][0-9a-fA-F][0-9a-fA-F][0-9a-fA-F]&quot;, function(v) return hex2utf8(string.sub(v,2)) end)\n</code></pre><p>string的描述</p>\n<pre><code>string_m = serialize(\n  {\n    quotation_m,\n    or_empty(\n        one_or_more(\n          parallelize{\n            char_m,\n            serialize(\n              {\n                backslash_m,\n                parallelize{escape_char_m,unicode_char_m}\n              },\n              table.concat\n              ),\n            },\n          table.concat\n          )\n      ),\n    quotation_m\n  },\n  table.concat\n)\n</code></pre><p>object的描述，各层结果处理函数比较复杂。</p>\n<pre><code>-- object\n-- brace_l\nlocal brace_l_m = generator(&quot;%s*{%s*&quot;,nil_h)\nlocal brace_r_m = generator(&quot;%s*}%s*&quot;,nil_h)\nlocal colon_m = generator(&quot;%s*:%s*&quot;,nil_h)\nlocal comma_m = generator(&quot;%s*,%s*&quot;,nil_h)\n\nlocal object_item_m = serialize{string_m,colon_m,value_m}\n\nobject_m = serialize(\n  {\n    brace_l_m,\n    or_empty(\n      serialize(\n        {\n          object_item_m,\n          or_empty(\n            one_or_more(\n              serialize(\n                {comma_m,object_item_m},\n                function(t) return t[1] end\n              )\n            )\n          )\n        },\n        function(t)\n          if t[2] then\n            table.insert(t[2],t[1])\n            return t[2]\n          else\n            return {t[1]}\n          end\n        end\n      )\n    ),\n    brace_r_m\n  },\n  function(t)\n    local o = {}\n\n    if t[1] then\n      for k,v in pairs(t[1]) do\n        o[v[1]] = v[2]\n      end\n    end\n\n    return o\n  end\n)\n</code></pre><p>array的描述，array需要保持一个状态index，如果直接用基本操作描述，传入的结果处理函数会比较蛋疼，所以用函数实现了。</p>\n<pre><code>-- arrary\nlocal bracket_l_m = generator(&quot;%s*%[%s*&quot;,nil_h)\nlocal bracket_r_m = generator(&quot;%s*%]%s*&quot;,nil_h)\n\narray_m = function(json_str, start)\n\n  local array,index = {}, 1\n  local add_item = function(v) array[index] = v[1]; index=index+1 end \n  local array_item_m = serialize({value_m},add_item)\n\n  local array_a = serialize{\n      bracket_l_m,\n      or_empty(\n        serialize{\n            array_item_m,\n            or_empty(\n              one_or_more(serialize{comma_m,array_item_m})\n                )\n              }\n          ),\n      bracket_r_m\n    }\n\n  local r,v,s = array_a(json_str,start)\n  return r,array,s\nend\n</code></pre><p>最后，匹配函数</p>\n<pre><code>local function Marshal(json_str)\n  local result,value,start = value_m(json_str,1)\n  if result --and start == #json_str+1 \n  then\n    return value \n  else\n    return nil, &quot;error_type&quot;\n  end\nend\n</code></pre><p>lua table 反解析成 json string 的比较直观，对每一种lua value类型写一个转换函数即可，此处不冗述。</p>\n","excerpt":"<p>题目任务描述：封装json格式的数据与lua value间的互相转换功能</p>\n<p>下载ECMA-404的描述文件，观察json的数据格式。</p>\n<p>根据描述，一个json value可以是这些类型: object, array, number, string, true, false, or null。</p>\n<p><img src=\"/images/value.png\" alt=\"value\"></p>","more":"<p>下面是描述几种数据类型的图。</p>\n<p><img src=\"/images/object.png\" alt=\"object\"></p>\n<p><img src=\"/images/array.png\" alt=\"array\"></p>\n<p><img src=\"/images/number.png\" alt=\"number\"></p>\n<p><img src=\"/images/string.png\" alt=\"string\"></p>\n<p>这些图的描述能力应该等同BNF，所以需要处理的操作大概有：</p>\n<ol>\n<li>串联                    如，C等于A串联B(C＝AB)，即匹配一个C等同于匹配一个A接着匹配一个B</li>\n<li>并联                    如，C等于A并联A(C=A|B)，即匹配一个C等同于匹配一个A或者匹配一个B</li>\n<li>匹配0或1次            如，C等于匹配A0或1次(C=A?)，即匹配一个C等同于匹配一个A0或多次，该操作可以由 C=A|”” 代替，其中””表示空串。</li>\n<li>匹配0或任意次        如，C等于匹配A0或任意次(C=A*)，即匹配一个C等同于匹配一个A0或任意次</li>\n</ol>\n<p>则最简单的，上述的value可以描述成</p>\n<pre><code>value ＝ object | array | number | string | true | false | null\n</code></pre><p>object可以描述成，(引号内表示终结符，括号指示结合顺序)</p>\n<pre><code>object ＝ &quot;{&quot; ((string &quot;:&quot; value) (&quot;,&quot; string &quot;:&quot; value)*)? &quot;}&quot;\n</code></pre><p>其他就依次类推…</p>\n<hr>\n<p>回来开始写代码：</p>\n<p>先定义最简单的匹配函数的格式：</p>\n<pre><code>-- the matcher function\nfunction matcher(json_str, start)\n    ...\n    return result, value, new_start\nend\n</code></pre><p>最简单的匹配函数，接受一个待匹配的字符串和一个起始下标，返回匹配结果（true|false），匹配成功后的返回数据，一个新的起始下标。</p>\n<p>定义两个最简单的结果处理函数，一个不处理输入直接返回，另一个直接返回nil，后面会常用到</p>\n<pre><code>-- result handler\nlocal no_h = function(v) return v end\nlocal nil_h = function() return nil end\n</code></pre><p>定义一个生成基本匹配函数的生成函数，接受一个lua find的匹配表达式和一个结果处理函数，返回一个匹配函数。</p>\n<pre><code>-- matcher function generator\nlocal generator = function(pattern, handler)\n\n  -- the matcher function\n  function matcher(json_str, start)\n    local _, e = string.find(json_str, &quot;^&quot;..pattern, start)\n\n    if e then\n      return true, handler(string.sub(json_str, start, e)), e+1\n    else\n      return false, nil, start\n    end\n\n  end\n\n  return matcher\nend\n</code></pre><p>根据最开始的描述，需要的操作至少还有：并联、串联、匹配0或一次、匹配0或任意次。</p>\n<p>下面是并联多个匹配函数的并联操作，输入一个匹配函数列表和一个结果处理函数，返回一个并联后的匹配函数。</p>\n<pre><code>-- parallelize matchers\nparallelize = function(matchers,handler)\n  if handler == nil then\n    handler = no_h\n  end\n\n  -- the paralleized matcher function\n  function p_matcher(json_str, start)\n    local r,v,s\n\n    for i=1,#matchers do\n      r,v,s = matchers[i](json_str, start)\n      if r then\n        if handler == nil_h then return true, nil, s end\n        if handler == no_h then return true, v, s end\n        return r,handler(v),s\n      end\n    end\n\n    return false,nil,start\n  end\n\n  return p_matcher\nend\n</code></pre><p>下面是串联多个匹配函数的串联操作，输入一个匹配函数列表和一个结果处理函数，返回一个串联后的匹配函数。</p>\n<pre><code>-- serialize matchers\nserialize = function(matchers,handler)\n  if handler == nil then\n    handler = no_h\n  end\n\n  -- the serialized matcher function\n  function s_matcher(json_str, start)\n    local r,v,s = false,nil,start\n    local results = {}\n\n    for i=1,#matchers do\n      r,v,s = matchers[i](json_str, s)\n      if r == false then\n        return false,nil,start\n      end\n      table.insert(results,v)\n    end\n\n    if handler == nil_h then return true, nil, s end\n    if handler == no_h then return true, results, s end\n    return true,handler(results),s\n  end\n\n  return s_matcher\nend\n</code></pre><p>匹配0或任意次和匹配1或任意次之间存在转换关系，实现中选了1或任意次匹配作为原子操作，0或任意次可以描述为:(“”表示空串)</p>\n<pre><code>0_or_more = one_or_more | &quot;&quot;\n</code></pre><p>下面是1或任意次匹配操作，接受一个匹配函数和一个结果处理函数，返回一个匹配1次或任意次的匹配函数。</p>\n<pre><code>-- make a matcher match one or more\none_or_more = function(matcher, handler)\n  if handler == nil then\n    handler = function(v) return v end\n  end\n\n  -- the one or more matcher function\n  function oom_matcher(json_str, start)\n    local r,v,s = false,nil,start\n    local results = {}\n\n    r,v,s = matcher(json_str, s)\n    if r == false then\n      return false,nil,s\n    end\n    table.insert(results,v)\n\n    while true do\n      r,v,s = matcher(json_str, s)\n      if r == false then\n        break\n      end\n      table.insert(results,v)\n    end\n\n    if handler == nil_h then return true, nil, s end\n    if handler == no_h then return true, results, s end\n    return true,handler(results),s\n  end\n\n  return oom_matcher\nend\n</code></pre><p>下面定义了一个空串匹配函数，和定义一个0或1次匹配操作函数。</p>\n<pre><code>-- empty\nlocal empty_m = generator(&quot;&quot;,nil_h)\n\n-- or empty helper\nlocal or_empty = function(matcher)\n  return parallelize{matcher,empty_m}\nend\n</code></pre><p>定义完这些，就可以开始描述我们的匹配函数了。</p>\n<pre><code>-- main matchers\nlocal null_m, boolean_m, number_m, string_m, object_m, array_m, value_m, value_a\n</code></pre><p>value匹配函数的描述，value为number_m,string_m,boolean_m,null_m,object_m,array_m并联。</p>\n<pre><code>-- value\nvalue_m = function(json_str,s)\n  -- use value_a to bootup\n  if value_a==nil then \n    value_a = parallelize{number_m,string_m,boolean_m,null_m,object_m,array_m}\n  end\n  return value_a(json_str,s)\nend\n</code></pre><p>这里的value需要使用value_a来协助描述，因为代码最终会出现循环引用，此时number_m,string_m,boolean_m,null_m,object_m,array_m都还没定义，需要在定义好后，才能生成value的匹配函数。</p>\n<p>匹配null的函数，使用生成函数生成。</p>\n<pre><code>-- null\nnull_m = generator(&quot;null&quot;,function() return nil end)\n</code></pre><p>匹配boolean的函数，true和false使用生成函数生成，然后并联true和false匹配函数，生成boolean匹配函数。</p>\n<pre><code>-- boolean\nlocal true_m = generator(&quot;true&quot;, function() return true end)\nlocal false_m = generator(&quot;false&quot;, function() return false end)\nboolean_m = parallelize{true_m,false_m}\n</code></pre><p>匹配number的函数，根据最上面的图，描述为如下：</p>\n<pre><code>-- number\nlocal sign_m = generator(&quot;[+-]?&quot;,no_h)\nlocal minus_or_no_m = generator(&quot;[-]?&quot;,no_h)\nlocal number_no_0_m = generator(&quot;[1-9]%d*&quot;,no_h)\nlocal number_0_m = generator(&quot;0&quot;,no_h)\nlocal dot_number_m = generator(&quot;%.%d+&quot;,no_h)\nlocal e_number_m = generator(&quot;[eE][+-]?%d+&quot;,no_h)\n\nnumber_m = serialize(\n  {\n    minus_or_no_m,\n    parallelize{number_0_m,number_no_0_m},\n    or_empty(dot_number_m),\n    or_empty(e_number_m)\n  },\n  function(t) return tonumber(table.concat(t)) end\n  )\n</code></pre><p>string需要处理unicode2utf8编码转换及转义符号。</p>\n<p>unicode到utf8转换函数：</p>\n<pre><code>-- string\nlocal function hex2utf8(hex)\n  local v, utf8str = 0, &quot;&quot;  \n  v = tonumber(hex,16)\n  if v &gt;= 0x0800 then\n    utf8str = string.char(v%0x40+0x80)\n    v = math.modf(v/0x40)\n    vv = v % 0x40\n    utf8str = string.char(vv+0x80) .. utf8str\n    v = math.modf(v/0x40)\n    utf8str = string.char(v+0xe0) .. utf8str\n  elseif v &gt;= 0x0080 then\n    utf8str = string.char(v%0x40+0x80)\n    v = math.modf(v/0x40)\n    utf8str = string.char(v+0xc0) .. utf8str\n  else\n    utf8str = string.char(v)\n  end\n  return utf8str\nend\n</code></pre><p>匹配引号的函数，使用生成函数生成。</p>\n<pre><code>-- string\nlocal quotation_m = generator(&quot;\\&quot;&quot;,nil_h)\n</code></pre><p>匹配非”\\”字符的函数，生成函数生成。</p>\n<pre><code>local char_m = generator(&quot;[^\\&quot;\\\\]+&quot;, no_h)\n</code></pre><p>转义表</p>\n<pre><code>local escape_char = {\n    [&quot;\\&quot;&quot;] = &quot;\\&quot;&quot;,\n    [&quot;\\\\&quot;] = &quot;\\\\&quot;,\n    [&quot;/&quot;]  = &quot;/&quot;,\n    [&quot;b&quot;]  = &quot;\\b&quot;,\n    [&quot;f&quot;]  = &quot;\\f&quot;,\n    [&quot;n&quot;]  = &quot;\\n&quot;,\n    [&quot;r&quot;]  = &quot;\\r&quot;,\n    [&quot;t&quot;]  = &quot;\\t&quot;,\n  }\n</code></pre><p>匹配”\\”字符函数。</p>\n<pre><code>local backslash_m = generator(&quot;\\\\&quot;, nil_h)\n</code></pre><p>转义符号匹配和处理函数，注意传入的结果处理函数。</p>\n<pre><code>local escape_char_m = generator(&quot;[\\&quot;\\\\/bfnrt]&quot;,function(c) return escape_char[c] end)\n</code></pre><p>unicode匹配和处理函数，注意传入的结果处理函数。</p>\n<pre><code>local unicode_char_m = generator(&quot;u[0-9a-fA-F][0-9a-fA-F][0-9a-fA-F][0-9a-fA-F]&quot;, function(v) return hex2utf8(string.sub(v,2)) end)\n</code></pre><p>string的描述</p>\n<pre><code>string_m = serialize(\n  {\n    quotation_m,\n    or_empty(\n        one_or_more(\n          parallelize{\n            char_m,\n            serialize(\n              {\n                backslash_m,\n                parallelize{escape_char_m,unicode_char_m}\n              },\n              table.concat\n              ),\n            },\n          table.concat\n          )\n      ),\n    quotation_m\n  },\n  table.concat\n)\n</code></pre><p>object的描述，各层结果处理函数比较复杂。</p>\n<pre><code>-- object\n-- brace_l\nlocal brace_l_m = generator(&quot;%s*{%s*&quot;,nil_h)\nlocal brace_r_m = generator(&quot;%s*}%s*&quot;,nil_h)\nlocal colon_m = generator(&quot;%s*:%s*&quot;,nil_h)\nlocal comma_m = generator(&quot;%s*,%s*&quot;,nil_h)\n\nlocal object_item_m = serialize{string_m,colon_m,value_m}\n\nobject_m = serialize(\n  {\n    brace_l_m,\n    or_empty(\n      serialize(\n        {\n          object_item_m,\n          or_empty(\n            one_or_more(\n              serialize(\n                {comma_m,object_item_m},\n                function(t) return t[1] end\n              )\n            )\n          )\n        },\n        function(t)\n          if t[2] then\n            table.insert(t[2],t[1])\n            return t[2]\n          else\n            return {t[1]}\n          end\n        end\n      )\n    ),\n    brace_r_m\n  },\n  function(t)\n    local o = {}\n\n    if t[1] then\n      for k,v in pairs(t[1]) do\n        o[v[1]] = v[2]\n      end\n    end\n\n    return o\n  end\n)\n</code></pre><p>array的描述，array需要保持一个状态index，如果直接用基本操作描述，传入的结果处理函数会比较蛋疼，所以用函数实现了。</p>\n<pre><code>-- arrary\nlocal bracket_l_m = generator(&quot;%s*%[%s*&quot;,nil_h)\nlocal bracket_r_m = generator(&quot;%s*%]%s*&quot;,nil_h)\n\narray_m = function(json_str, start)\n\n  local array,index = {}, 1\n  local add_item = function(v) array[index] = v[1]; index=index+1 end \n  local array_item_m = serialize({value_m},add_item)\n\n  local array_a = serialize{\n      bracket_l_m,\n      or_empty(\n        serialize{\n            array_item_m,\n            or_empty(\n              one_or_more(serialize{comma_m,array_item_m})\n                )\n              }\n          ),\n      bracket_r_m\n    }\n\n  local r,v,s = array_a(json_str,start)\n  return r,array,s\nend\n</code></pre><p>最后，匹配函数</p>\n<pre><code>local function Marshal(json_str)\n  local result,value,start = value_m(json_str,1)\n  if result --and start == #json_str+1 \n  then\n    return value \n  else\n    return nil, &quot;error_type&quot;\n  end\nend\n</code></pre><p>lua table 反解析成 json string 的比较直观，对每一种lua value类型写一个转换函数即可，此处不冗述。</p>"}],"PostAsset":[],"PostCategory":[],"PostTag":[{"post_id":"cirkp6cv50000h8g6gquj4q2j","tag_id":"cirkp6cvd0003h8g6b5t4bhm1","_id":"cirkp6cvs000dh8g63kkubxc0"},{"post_id":"cirkp6cv50000h8g6gquj4q2j","tag_id":"cirkp6cvl0006h8g6vrn1y117","_id":"cirkp6cvs000eh8g673wseo4j"},{"post_id":"cirkp6cv50000h8g6gquj4q2j","tag_id":"cirkp6cvq000ah8g6z22pip84","_id":"cirkp6cvs000gh8g6d6jqdrne"},{"post_id":"cirkp6cvb0002h8g67y3f12lo","tag_id":"cirkp6cvr000ch8g6vld6yio5","_id":"cirkp6cvu000jh8g64imd5eji"},{"post_id":"cirkp6cvb0002h8g67y3f12lo","tag_id":"cirkp6cvs000fh8g6r7wesg9w","_id":"cirkp6cvu000kh8g635xqegjy"},{"post_id":"cirkp6cvb0002h8g67y3f12lo","tag_id":"cirkp6cvt000hh8g6owq9pkue","_id":"cirkp6cvv000mh8g6dblcvxbd"},{"post_id":"cirkp6cvf0004h8g6ssvx44d8","tag_id":"cirkp6cvt000ih8g6bhk0ybk4","_id":"cirkp6cvv000nh8g69inivp1c"},{"post_id":"cirkp6cvh0005h8g65s1sgszx","tag_id":"cirkp6cvv000lh8g627wqw8ac","_id":"cirkp6cvx000qh8g6ez4u8kva"},{"post_id":"cirkp6cvh0005h8g65s1sgszx","tag_id":"cirkp6cvw000oh8g6s3h37xz4","_id":"cirkp6cvy000rh8g6zyx3kdrv"},{"post_id":"cirkp6cvm0007h8g60j19ad0x","tag_id":"cirkp6cvr000ch8g6vld6yio5","_id":"cirkp6cw0000wh8g6mlq8907n"},{"post_id":"cirkp6cvm0007h8g60j19ad0x","tag_id":"cirkp6cvy000sh8g62fcblijd","_id":"cirkp6cw0000xh8g6sxi4ictt"},{"post_id":"cirkp6cvm0007h8g60j19ad0x","tag_id":"cirkp6cvz000th8g60tcq6ayl","_id":"cirkp6cw1000zh8g6w0n9mlwn"},{"post_id":"cirkp6cvm0007h8g60j19ad0x","tag_id":"cirkp6cvz000uh8g65johd67c","_id":"cirkp6cw10010h8g6xi187qdu"},{"post_id":"cirkp6cvo0008h8g61dt2g8fj","tag_id":"cirkp6cw0000vh8g61s17xu40","_id":"cirkp6cw20012h8g65b9vftaj"},{"post_id":"cirkp6cvo0008h8g61dt2g8fj","tag_id":"cirkp6cvd0003h8g6b5t4bhm1","_id":"cirkp6cw20013h8g6wngtwn3y"},{"post_id":"cirkp6cvo0008h8g61dt2g8fj","tag_id":"cirkp6cw1000yh8g69h8rtzvo","_id":"cirkp6cw30015h8g6o3etptma"},{"post_id":"cirkp6cvp0009h8g61trmlyg8","tag_id":"cirkp6cw10011h8g6oi6axdjk","_id":"cirkp6cw40018h8g6xhdgkcqo"},{"post_id":"cirkp6cvp0009h8g61trmlyg8","tag_id":"cirkp6cvr000ch8g6vld6yio5","_id":"cirkp6cw40019h8g60to7j84t"},{"post_id":"cirkp6cvp0009h8g61trmlyg8","tag_id":"cirkp6cvy000sh8g62fcblijd","_id":"cirkp6cw4001bh8g6udl9c81h"},{"post_id":"cirkp6cvr000bh8g6hj61jn5z","tag_id":"cirkp6cw30017h8g69qz3swsh","_id":"cirkp6cw5001dh8g6r1trn85e"},{"post_id":"cirkp6cvr000bh8g6hj61jn5z","tag_id":"cirkp6cw4001ah8g69ojwj96e","_id":"cirkp6cw5001eh8g6kkejiyuv"},{"post_id":"cirkp6cvr000bh8g6hj61jn5z","tag_id":"cirkp6cw5001ch8g6lxhel8pj","_id":"cirkp6cw6001fh8g6fuwpdxd8"}],"Tag":[{"name":"game","_id":"cirkp6cvd0003h8g6b5t4bhm1"},{"name":"work","_id":"cirkp6cvl0006h8g6vrn1y117"},{"name":"begin","_id":"cirkp6cvq000ah8g6z22pip84"},{"name":"iOS","_id":"cirkp6cvr000ch8g6vld6yio5"},{"name":"IAP","_id":"cirkp6cvs000fh8g6r7wesg9w"},{"name":"Receipt","_id":"cirkp6cvt000hh8g6owq9pkue"},{"name":"daily","_id":"cirkp6cvt000ih8g6bhk0ybk4"},{"name":"Xcode","_id":"cirkp6cvv000lh8g627wqw8ac"},{"name":"Plugin","_id":"cirkp6cvw000oh8g6s3h37xz4"},{"name":"SDK","_id":"cirkp6cvy000sh8g62fcblijd"},{"name":"Flash","_id":"cirkp6cvz000th8g60tcq6ayl"},{"name":"ANE","_id":"cirkp6cvz000uh8g65johd67c"},{"name":"Extra Credits","_id":"cirkp6cw0000vh8g61s17xu40"},{"name":"video lesson series","_id":"cirkp6cw1000yh8g69h8rtzvo"},{"name":"U3D","_id":"cirkp6cw10011h8g6oi6axdjk"},{"name":"lua","_id":"cirkp6cw30017h8g69qz3swsh"},{"name":"json","_id":"cirkp6cw4001ah8g69ojwj96e"},{"name":"parser","_id":"cirkp6cw5001ch8g6lxhel8pj"}]}}